<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LINE 1 &quot;ffi/Analysis/Parsimony/Dynamic/DirectOptimization/Pairwise/FFI.hsc&quot; #-}</span><span>
</span><a name="line-2"></a><span class="hs-comment">-----------------------------------------------------------------------------</span><span>
</span><a name="line-3"></a><span class="hs-comment">-- |</span><span>
</span><a name="line-4"></a><span class="hs-comment">-- an FFI interface for C code that efficiently aligns either two or three</span><span>
</span><a name="line-5"></a><span class="hs-comment">-- sequences, using Ukkonen when appropriate, in both affine and non-affine</span><span>
</span><a name="line-6"></a><span class="hs-comment">-- cases.</span><span>
</span><a name="line-7"></a><span class="hs-comment">--</span><span>
</span><a name="line-8"></a><span class="hs-comment">-- This example uses pointers, both to structs and to fields within the</span><span>
</span><a name="line-9"></a><span class="hs-comment">-- structs. This is much easier to accomplish via .hsc rather than doing</span><span>
</span><a name="line-10"></a><span class="hs-comment">-- straight FFI. A .hsc file are read by hsc2hs, which then creates a .c</span><span>
</span><a name="line-11"></a><span class="hs-comment">-- file, which is compiled and run to create an .hs file, which is then</span><span>
</span><a name="line-12"></a><span class="hs-comment">-- compiled for use in outside modules.</span><span>
</span><a name="line-13"></a><span class="hs-comment">--</span><span>
</span><a name="line-14"></a><span class="hs-comment">-- For notes on usage, data construction and external see referenced C</span><span>
</span><a name="line-15"></a><span class="hs-comment">-- compilation units, and also driver.c, which is not imported, but is</span><span>
</span><a name="line-16"></a><span class="hs-comment">-- included indirectory for reference.</span><span>
</span><a name="line-17"></a><span class="hs-comment">--</span><span>
</span><a name="line-18"></a><span class="hs-comment">-----------------------------------------------------------------------------</span><span>
</span><a name="line-19"></a><span>
</span><a name="line-20"></a><span class="hs-comment">-- TODO: do I need this: https://hackage.haskell.org/package/base-4.9.0.0/docs/Foreign-StablePtr.html</span><span>
</span><a name="line-21"></a><span>
</span><a name="line-22"></a><span class="hs-pragma">{-# LANGUAGE ForeignFunctionInterface, BangPatterns #-}</span><span>
</span><a name="line-23"></a><span class="hs-pragma">{-# LANGUAGE DeriveGeneric #-}</span><span>
</span><a name="line-24"></a><span>
</span><a name="line-25"></a><span class="hs-keyword">module</span><span> </span><a href="Analysis.Parsimony.Dynamic.DirectOptimization.Pairwise.FFI.html#CostMatrix2d"><span class="hs-identifier hs-type">Analysis</span><span class="hs-operator hs-type">.</span></a><span class="hs-identifier">Parsimony</span><span class="hs-operator">.</span><span class="hs-identifier">Dynamic</span><span class="hs-operator">.</span><span class="hs-identifier">DirectOptimization</span><span class="hs-operator">.</span><span class="hs-identifier">Pairwise</span><span class="hs-operator">.</span><span class="hs-identifier">FFI</span><span>
</span><a name="line-26"></a><span>  </span><span class="hs-special">(</span><span> </span><a href="Analysis.Parsimony.Dynamic.DirectOptimization.Pairwise.FFI.html#DenseTransitionCostMatrix"><span class="hs-identifier hs-type">CostMatrix2d</span></a><span>
</span><a name="line-27"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">DenseTransitionCostMatrix</span><span>
</span><a name="line-28"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Analysis.Parsimony.Dynamic.DirectOptimization.Pairwise.FFI.html#foreignThreeWayDO"><span class="hs-identifier hs-var">foreignPairwiseDO</span></a><span>
</span><a name="line-29"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Analysis.Parsimony.Dynamic.DirectOptimization.Pairwise.FFI.html#generateDenseTransitionCostMatrix"><span class="hs-identifier hs-var">foreignThreeWayDO</span></a><span>
</span><a name="line-30"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">generateDenseTransitionCostMatrix</span><span>
</span><a name="line-31"></a><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-32"></a><span>
</span><a name="line-33"></a><span class="hs-keyword">import</span><span> </span><a href="Bio.Character.Encodable.html"><span class="hs-identifier">Analysis</span><span class="hs-operator">.</span><span class="hs-identifier">Parsimony</span><span class="hs-operator">.</span></a><span class="hs-identifier">Dynamic</span><span class="hs-operator">.</span><span class="hs-identifier">DirectOptimization</span><span class="hs-operator">.</span><span class="hs-identifier">Pairwise</span><span class="hs-operator">.</span><span class="hs-identifier">Internal</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">filterGaps</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">handleMissingCharacter</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">handleMissingCharacterThreeway</span><span class="hs-special">)</span><span>
</span><a name="line-34"></a><span class="hs-keyword">import</span><span> </span><a href="Bio.Character.Exportable.Class.html"><span class="hs-identifier">Bio</span><span class="hs-operator">.</span><span class="hs-identifier">Character</span><span class="hs-operator">.</span><span class="hs-identifier">Encodable</span></a><span>
</span><a name="line-35"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Bio</span><span class="hs-operator">.</span><span class="hs-identifier">Character</span><span class="hs-operator">.</span><span class="hs-identifier">Exportable</span><span class="hs-operator">.</span><span class="hs-identifier">Class</span><span>
</span><a name="line-36"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">DeepSeq</span><span>
</span><a name="line-37"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Lens</span><span>
</span><a name="line-38"></a><span class="hs-comment">--import Data.Foldable</span><span>
</span><a name="line-39"></a><span class="hs-comment">--import Data.List        (intercalate)</span><span>
</span><a name="line-40"></a><span class="hs-comment">--import Data.MonoTraversable</span><span>
</span><a name="line-41"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Semigroup</span><span>
</span><a name="line-42"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Foreign</span><span>
</span><a name="line-43"></a><span class="hs-comment">--import Foreign.Ptr</span><span>
</span><a name="line-44"></a><span class="hs-comment">--import Foreign.C.String</span><span>
</span><a name="line-45"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Foreign</span><span class="hs-operator">.</span><span class="hs-identifier">C</span><span class="hs-operator">.</span><span class="hs-identifier">Types</span><span>
</span><a name="line-46"></a><span class="hs-comment">--import Foreign.ForeignPtr</span><span>
</span><a name="line-47"></a><span class="hs-comment">--import Foreign.Marshal.Array</span><span>
</span><a name="line-48"></a><span class="hs-comment">--import Foreign.StablePtr</span><span>
</span><a name="line-49"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GHC</span><span class="hs-operator">.</span><span class="hs-identifier">Generics</span><span>     </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Generic</span><span class="hs-special">)</span><span>
</span><a name="line-50"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Prelude</span><span>   </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">sequence</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">tail</span><span class="hs-special">)</span><span>
</span><a name="line-51"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">System</span><span class="hs-operator">.</span><span class="hs-identifier">IO</span><span class="hs-operator">.</span><span class="hs-identifier">Unsafe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">unsafePerformIO</span><span class="hs-special">)</span><span>
</span><a name="line-52"></a><span>
</span><a name="line-53"></a><span class="hs-comment">-- import Debug.Trace</span><span>
</span><a name="line-54"></a><span>
</span><a name="line-55"></a><span>
</span><a name="line-56"></a><span>
</span><a name="line-57"></a><span>
</span><a name="line-58"></a><span>
</span><a name="line-59"></a><span>
</span><a name="line-60"></a><span class="hs-comment">-- #include &quot;seqAlign.h&quot;</span><span>
</span><a name="line-61"></a><span>
</span><a name="line-62"></a><span>
</span><a name="line-63"></a><span class="hs-comment">-- |</span><span>
</span><a name="line-64"></a><span class="hs-comment">-- Input/output data type for C alignment code to avoid having to write the</span><span>
</span><a name="line-65"></a><span class="hs-comment">-- whole seq type.</span><span>
</span><a name="line-66"></a><span class="hs-keyword">data</span><span> </span><a name="Align_io"><a href="Analysis.Parsimony.Dynamic.DirectOptimization.Pairwise.FFI.html#Align_io"><span class="hs-identifier">Align_io</span></a></a><span>
</span><a name="line-67"></a><span>   </span><span class="hs-glyph">=</span><span> </span><a name="character"><a href="Analysis.Parsimony.Dynamic.DirectOptimization.Pairwise.FFI.html#character"><span class="hs-identifier">Align_io</span></a></a><span>
</span><a name="line-68"></a><span>   </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">character</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Ptr</span><span> </span><span class="hs-identifier">CUInt</span><span>
</span><a name="line-69"></a><span>   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">charLen</span><span>   </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CSize</span><span>     </span><span class="hs-comment">-- Total length of the character stored</span><span>
</span><a name="line-70"></a><span>   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">arrCap</span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">CSize</span><span>     </span><span class="hs-comment">-- Total capacity of allocated array</span><span>
</span><a name="line-71"></a><span>   </span><span class="hs-special">}</span><span>
</span><a name="line-72"></a><span>
</span><a name="line-73"></a><span>
</span><a name="line-74"></a><span class="hs-keyword">data</span><span> </span><span class="hs-identifier">AlignmentStrategy</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">Linear</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">Affine</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">Other</span><span> </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">Eq</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">Show</span><span class="hs-special">)</span><span>
</span><a name="line-75"></a><span>
</span><a name="line-76"></a><span>
</span><a name="line-77"></a><span class="hs-comment">-- |</span><span>
</span><a name="line-78"></a><span class="hs-comment">-- Holds single cost matrix, which contains costs and medians for all possible</span><span>
</span><a name="line-79"></a><span class="hs-comment">-- character elements. It is completely filled using a TCM.</span><span>
</span><a name="line-80"></a><span class="hs-comment">--</span><span>
</span><a name="line-81"></a><span class="hs-comment">-- See note below at 'setupCostMatrixFn_c'.</span><span>
</span><a name="line-82"></a><span class="hs-keyword">data</span><span> </span><a name="CostMatrix2d"><a href="Analysis.Parsimony.Dynamic.DirectOptimization.Pairwise.FFI.html#CostMatrix2d"><span class="hs-identifier">CostMatrix2d</span></a></a><span>
</span><a name="line-83"></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">CostMatrix2d</span><span>
</span><a name="line-84"></a><span>   </span><span class="hs-special">{</span><span> </span><a name="costMatrixDimension"><a href="Analysis.Parsimony.Dynamic.DirectOptimization.Pairwise.FFI.html#costMatrixDimension"><span class="hs-identifier">alphSize</span></a></a><span>            </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CInt</span><span>      </span><span class="hs-comment">-- alphabet size including gap, and including ambiguities if</span><span>
</span><a name="line-85"></a><span>   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">costMatrixDimension</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CInt</span><span>      </span><span class="hs-comment">-- ceiling of log_2 (alphSize)</span><span>
</span><a name="line-86"></a><span>   </span><span class="hs-special">,</span><span> </span><a name="costModelType"><a href="Analysis.Parsimony.Dynamic.DirectOptimization.Pairwise.FFI.html#costModelType"><span class="hs-identifier">gapChar</span></a></a><span>             </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CInt</span><span>      </span><span class="hs-comment">-- gap value (1 &lt;&lt; (alphSize - 1))</span><span>
</span><a name="line-87"></a><span>   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">costModelType</span><span>       </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">CInt</span><span>      </span><span class="hs-comment">{- The type of cost model to be used in the alignment,
                                       - i.e. affine or not.
                                       - Based on cost_matrix.ml, values are:
                                       - &#8226; linear == 0
                                       - &#8226; affine == 3
                                       - &#8226; no_alignment == 2,
                                       - but I updated it. See costMatrix.h.
                                       -}</span><span>
</span><a name="line-95"></a><span>   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">include_ambiguities</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">CInt</span><span>      </span><span class="hs-comment">{- This is a flag set to true if we are going to accept
                                         all possible combinations of the elements in the alphabet
                                         in the alignments. This is not true for protein characters
                                         for example, where the number of elements of the alphabet
                                         is already too big to build all the possible combinations.
                                      -}</span><span>
</span><a name="line-101"></a><span>   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">gapOpenCost</span><span>         </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">CInt</span><span>      </span><span class="hs-comment">{- The cost of opening a gap. This is only useful in
                                         certain cost_model_types (type 3: affine, based on my reading of ML code).
                                      -}</span><span>
</span><a name="line-104"></a><span>   </span><span class="hs-special">,</span><span> </span><a name="allElems"><a href="Analysis.Parsimony.Dynamic.DirectOptimization.Pairwise.FFI.html#allElems"><span class="hs-identifier">isMetric</span></a></a><span>            </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CInt</span><span>      </span><span class="hs-comment">-- if tcm is metric</span><span>
</span><a name="line-105"></a><span>   </span><span class="hs-special">,</span><span> </span><a name="bestCost"><a href="Analysis.Parsimony.Dynamic.DirectOptimization.Pairwise.FFI.html#bestCost"><span class="hs-identifier">allElems</span></a></a><span>            </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">CInt</span><span>      </span><span class="hs-comment">-- total number of elements</span><span>
</span><a name="line-106"></a><span>   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">bestCost</span><span>            </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">Ptr</span><span> </span><span class="hs-identifier">CInt</span><span>  </span><span class="hs-comment">{- The transformation cost matrix, including ambiguities,
                                         storing the **best** cost for each ambiguity pair
                                      -}</span><span>
</span><a name="line-109"></a><span>   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">medians</span><span>             </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">Ptr</span><span> </span><span class="hs-identifier">CUInt</span><span> </span><span class="hs-comment">{- The matrix of possible medians between elements in the
                                         alphabet. The best possible medians according to the cost
                                          matrix.
                                      -}</span><span>
</span><a name="line-113"></a><span>   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">worstCost</span><span>           </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">Ptr</span><span> </span><span class="hs-identifier">CInt</span><span>  </span><span class="hs-comment">{- The transformation cost matrix, including ambiguities,
                                         storing the **worst** cost for each ambiguity pair
                                      -}</span><span>
</span><a name="line-116"></a><span>   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">prependCost</span><span>         </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">Ptr</span><span> </span><span class="hs-identifier">CInt</span><span>  </span><span class="hs-comment">{- The cost of going from gap -&gt; each base. For ambiguities, use best cost.
                                         Set up as num_elements x num_elements matrix, but seemingly only first row is used.
                                      -}</span><span>
</span><a name="line-119"></a><span>   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">tailCost</span><span>            </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">Ptr</span><span> </span><span class="hs-identifier">CInt</span><span>  </span><span class="hs-comment">{- As prepend_cost, but with reverse directionality,
                                         so base -&gt; gap.
                                         As with prepend_cost, seems to be allocated as too large.
                                      -}</span><span>
</span><a name="line-123"></a><span>   </span><span class="hs-special">}</span><span> </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">Eq</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">Generic</span><span class="hs-special">)</span><span>
</span><a name="line-124"></a><span>
</span><a name="line-125"></a><span>
</span><a name="line-126"></a><span class="hs-keyword">data</span><span> </span><a name="CostMatrix3d"><a href="Analysis.Parsimony.Dynamic.DirectOptimization.Pairwise.FFI.html#CostMatrix3d"><span class="hs-identifier">CostMatrix3d</span></a></a><span>
</span><a name="line-127"></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">CostMatrix3d</span><span>          </span><span class="hs-comment">-- See CostMatrix2d datatype for field description</span><span>
</span><a name="line-128"></a><span>   </span><span class="hs-special">{</span><span> </span><a name="costMatrixDimension3D"><a href="Analysis.Parsimony.Dynamic.DirectOptimization.Pairwise.FFI.html#costMatrixDimension3D"><span class="hs-identifier">alphSize3D</span></a></a><span>            </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CInt</span><span>
</span><a name="line-129"></a><span>   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">costMatrixDimension3D</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CInt</span><span>
</span><a name="line-130"></a><span>   </span><span class="hs-special">,</span><span> </span><a name="costModelType3D"><a href="Analysis.Parsimony.Dynamic.DirectOptimization.Pairwise.FFI.html#costModelType3D"><span class="hs-identifier">gapChar3D</span></a></a><span>             </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CInt</span><span>
</span><a name="line-131"></a><span>   </span><span class="hs-special">,</span><span> </span><a name="include_ambiguities3D"><a href="Analysis.Parsimony.Dynamic.DirectOptimization.Pairwise.FFI.html#include_ambiguities3D"><span class="hs-identifier">costModelType3D</span></a></a><span>       </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CInt</span><span>
</span><a name="line-132"></a><span>   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">include_ambiguities3D</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CInt</span><span>
</span><a name="line-133"></a><span>   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">gapOpenCost3D</span><span>         </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CInt</span><span>
</span><a name="line-134"></a><span>   </span><span class="hs-special">,</span><span> </span><a name="bestCost3D"><a href="Analysis.Parsimony.Dynamic.DirectOptimization.Pairwise.FFI.html#bestCost3D"><span class="hs-identifier">allElems3D</span></a></a><span>            </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">CInt</span><span>
</span><a name="line-135"></a><span>   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">bestCost3D</span><span>            </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Ptr</span><span> </span><span class="hs-identifier hs-type">CInt</span><span>
</span><a name="line-136"></a><span>   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">medians3D</span><span>             </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">Ptr</span><span> </span><span class="hs-identifier">CInt</span><span>
</span><a name="line-137"></a><span>   </span><span class="hs-special">}</span><span> </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">Eq</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">Generic</span><span class="hs-special">)</span><span>
</span><a name="line-138"></a><span>
</span><a name="line-139"></a><span>
</span><a name="line-140"></a><span class="hs-comment">-- TODO: StablePtr here maybe?</span><span>
</span><a name="line-141"></a><span class="hs-comment">-- |</span><span>
</span><a name="line-142"></a><span class="hs-comment">-- Exposed wrapper for C allocated cost matrix structs.</span><span>
</span><a name="line-143"></a><span class="hs-keyword">data</span><span> </span><a name="DenseTransitionCostMatrix"><a href="Analysis.Parsimony.Dynamic.DirectOptimization.Pairwise.FFI.html#DenseTransitionCostMatrix"><span class="hs-identifier">DenseTransitionCostMatrix</span></a></a><span>
</span><a name="line-144"></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">DenseTransitionCostMatrix</span><span>
</span><a name="line-145"></a><span>   </span><span class="hs-special">{</span><span> </span><a name="costMatrix3D"><a href="Analysis.Parsimony.Dynamic.DirectOptimization.Pairwise.FFI.html#costMatrix3D"><span class="hs-identifier">costMatrix2D</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Ptr</span><span> </span><a href="Analysis.Parsimony.Dynamic.DirectOptimization.Pairwise.FFI.html#CostMatrix3d"><span class="hs-identifier hs-type">CostMatrix2d</span></a><span>
</span><a name="line-146"></a><span>   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">costMatrix3D</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">Ptr</span><span> </span><span class="hs-identifier">CostMatrix3d</span><span>
</span><a name="line-147"></a><span>   </span><span class="hs-special">}</span><span> </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">Generic</span><span class="hs-special">)</span><span>
</span><a name="line-148"></a><span>
</span><a name="line-149"></a><span>
</span><a name="line-150"></a><span class="hs-keyword">data</span><span> </span><span class="hs-identifier">MedianContext</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ComputeMedians</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">DoNotComputeMedians</span><span>
</span><a name="line-151"></a><span>
</span><a name="line-152"></a><span>
</span><a name="line-153"></a><span class="hs-keyword">data</span><span> </span><span class="hs-identifier">UnionContext</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ComputeUnions</span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">DoNotComputeUnions</span><span>
</span><a name="line-154"></a><span>
</span><a name="line-155"></a><span>
</span><a name="line-156"></a><span class="hs-comment">-- | Because we're using a struct we need to make a Storable instance</span><span>
</span><a name="line-157"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier">Storable</span><span> </span><span class="hs-identifier">Align_io</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-158"></a><span>
</span><a name="line-159"></a><span>    </span><span class="hs-identifier">sizeOf</span><span>    </span><span class="hs-identifier">_</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-number">24</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-160"></a><span class="hs-pragma">{-# LINE 159 &quot;ffi/Analysis/Parsimony/Dynamic/DirectOptimization/Pairwise/FFI.hsc&quot; #-}</span><span>
</span><a name="line-161"></a><span>
</span><a name="line-162"></a><span>    </span><span class="hs-identifier">alignment</span><span> </span><span class="hs-identifier">_</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">alignment</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">undefined</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">CSize</span><span class="hs-special">)</span><span>
</span><a name="line-163"></a><span>
</span><a name="line-164"></a><span>    </span><span class="hs-identifier">peek</span><span> </span><span class="hs-identifier">ptr</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-165"></a><span>        </span><a name="local-6989586621679227651"><a href="#local-6989586621679227651"><span class="hs-identifier">arr</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679227650"><a href="#local-6989586621679227650"><span class="hs-identifier">hsc_ptr</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">peekByteOff</span><span> </span><a href="#local-6989586621679227650"><span class="hs-identifier hs-var">hsc_ptr</span></a><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">ptr</span><span>
</span><a name="line-166"></a><span class="hs-pragma">{-# LINE 164 &quot;ffi/Analysis/Parsimony/Dynamic/DirectOptimization/Pairwise/FFI.hsc&quot; #-}</span><span>
</span><a name="line-167"></a><span>        </span><span class="hs-identifier hs-var">len</span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">hsc_ptr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">peekByteOff</span><span> </span><span class="hs-identifier">hsc_ptr</span><span> </span><span class="hs-number">8</span><span class="hs-special">)</span><span class="hs-special">)</span><span>    </span><span class="hs-identifier">ptr</span><span>
</span><a name="line-168"></a><span class="hs-pragma">{-# LINE 165 &quot;ffi/Analysis/Parsimony/Dynamic/DirectOptimization/Pairwise/FFI.hsc&quot; #-}</span><span>
</span><a name="line-169"></a><span>        </span><span class="hs-identifier">cap</span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">hsc_ptr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">peekByteOff</span><span> </span><span class="hs-identifier">hsc_ptr</span><span> </span><span class="hs-number">16</span><span class="hs-special">)</span><span class="hs-special">)</span><span>  </span><span class="hs-identifier">ptr</span><span>
</span><a name="line-170"></a><span class="hs-pragma">{-# LINE 166 &quot;ffi/Analysis/Parsimony/Dynamic/DirectOptimization/Pairwise/FFI.hsc&quot; #-}</span><span>
</span><a name="line-171"></a><span>
</span><a name="line-172"></a><span>        </span><span class="hs-identifier">pure</span><span> </span><span class="hs-identifier">Align_io</span><span>
</span><a name="line-173"></a><span>            </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">character</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">arr</span><span>
</span><a name="line-174"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">charLen</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">len</span><span>
</span><a name="line-175"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">arrCap</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">cap</span><span>
</span><a name="line-176"></a><span>            </span><span class="hs-special">}</span><span>
</span><a name="line-177"></a><span>
</span><a name="line-178"></a><span>    </span><span class="hs-identifier">poke</span><span> </span><span class="hs-identifier">ptr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">Align_io</span><span> </span><span class="hs-identifier">arr</span><span> </span><span class="hs-identifier">len</span><span> </span><span class="hs-identifier">cap</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-179"></a><span>        </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">hsc_ptr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">pokeByteOff</span><span> </span><span class="hs-identifier">hsc_ptr</span><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">ptr</span><span> </span><span class="hs-identifier">arr</span><span>
</span><a name="line-180"></a><span class="hs-pragma">{-# LINE 175 &quot;ffi/Analysis/Parsimony/Dynamic/DirectOptimization/Pairwise/FFI.hsc&quot; #-}</span><span>
</span><a name="line-181"></a><span>        </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">hsc_ptr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">pokeByteOff</span><span> </span><span class="hs-identifier">hsc_ptr</span><span> </span><span class="hs-number">8</span><span class="hs-special">)</span><span class="hs-special">)</span><span>    </span><span class="hs-identifier">ptr</span><span> </span><span class="hs-identifier">len</span><span>
</span><a name="line-182"></a><span class="hs-pragma">{-# LINE 176 &quot;ffi/Analysis/Parsimony/Dynamic/DirectOptimization/Pairwise/FFI.hsc&quot; #-}</span><span>
</span><a name="line-183"></a><span>        </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">hsc_ptr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">pokeByteOff</span><span> </span><span class="hs-identifier">hsc_ptr</span><span> </span><span class="hs-number">16</span><span class="hs-special">)</span><span class="hs-special">)</span><span>  </span><span class="hs-identifier">ptr</span><span> </span><span class="hs-identifier">cap</span><span>
</span><a name="line-184"></a><span class="hs-pragma">{-# LINE 177 &quot;ffi/Analysis/Parsimony/Dynamic/DirectOptimization/Pairwise/FFI.hsc&quot; #-}</span><span>
</span><a name="line-185"></a><span>
</span><a name="line-186"></a><span>
</span><a name="line-187"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier">NFData</span><span> </span><span class="hs-identifier">CostMatrix2d</span><span>
</span><a name="line-188"></a><span>
</span><a name="line-189"></a><span>
</span><a name="line-190"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier">Show</span><span> </span><span class="hs-identifier">CostMatrix2d</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-191"></a><span>
</span><a name="line-192"></a><span>    </span><span class="hs-identifier">show</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">unlines</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">fieldRendering</span><span> </span><span class="hs-operator">&lt;*&gt;</span><span class="hs-special">)</span><span>  </span><span class="hs-operator">.</span><span> </span><span class="hs-identifier">pure</span><span>
</span><a name="line-193"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-194"></a><span>        </span><span class="hs-identifier">fieldRendering</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-195"></a><span>            </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">alphSize</span><span>
</span><a name="line-196"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">costMatrixDimension</span><span>
</span><a name="line-197"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">gapChar</span><span>
</span><a name="line-198"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">costModelType</span><span>
</span><a name="line-199"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">include_ambiguities</span><span>
</span><a name="line-200"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">show</span><span> </span><span class="hs-operator">.</span><span> </span><span class="hs-identifier">gapOpenCost</span><span>
</span><a name="line-201"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">show</span><span> </span><span class="hs-operator">.</span><span> </span><span class="hs-identifier">isMetric</span><span>
</span><a name="line-202"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">show</span><span> </span><span class="hs-operator">.</span><span> </span><span class="hs-identifier">allElems</span><span>
</span><a name="line-203"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">show</span><span> </span><a href="Analysis.Parsimony.Dynamic.DirectOptimization.Pairwise.FFI.html#CostMatrix2d"><span class="hs-operator hs-type">.</span></a><span> </span><a href="Analysis.Parsimony.Dynamic.DirectOptimization.Pairwise.FFI.html#CostMatrix2d"><span class="hs-identifier hs-type">bestCost</span></a><span>
</span><a name="line-204"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">show</span><span> </span><span class="hs-operator">.</span><span> </span><span class="hs-identifier">medians</span><span>
</span><a name="line-205"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">show</span><span> </span><span class="hs-operator">.</span><span> </span><span class="hs-identifier">worstCost</span><span>
</span><a name="line-206"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">show</span><span> </span><span class="hs-operator">.</span><span> </span><span class="hs-identifier">prependCost</span><span>
</span><a name="line-207"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">show</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">tailCost</span><span>
</span><a name="line-208"></a><span>            </span><span class="hs-special">]</span><span>
</span><a name="line-209"></a><span>
</span><a name="line-210"></a><span>
</span><a name="line-211"></a><span class="hs-keyword">instance</span><span> </span><a name="local-6989586621679227594"><a href="#local-6989586621679227594"><span class="hs-identifier">Storable</span></a></a><span> </span><a name="local-6989586621679227594"><a href="#local-6989586621679227594"><span class="hs-identifier">CostMatrix2d</span></a></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-212"></a><span>
</span><a name="line-213"></a><span>    </span><span class="hs-identifier">sizeOf</span><span> </span><a name="local-6989586621679227598"><a href="#local-6989586621679227598"><span class="hs-identifier">_</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-number">88</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-214"></a><span class="hs-pragma">{-# LINE 206 &quot;ffi/Analysis/Parsimony/Dynamic/DirectOptimization/Pairwise/FFI.hsc&quot; #-}</span><span>
</span><a name="line-215"></a><span>
</span><a name="line-216"></a><span>    </span><span class="hs-identifier">alignment</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">sizeOf</span><span> </span><span class="hs-comment">-- alignment (undefined :: StablePtr CostMatrix2d)</span><span>
</span><a name="line-217"></a><span>
</span><a name="line-218"></a><span>    </span><span class="hs-identifier">peek</span><span> </span><a name="local-6989586621679227608"><a href="#local-6989586621679227608"><span class="hs-identifier">ptr</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-219"></a><span>        </span><span class="hs-identifier">aSizeVal</span><span>               </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679227609"><a href="#local-6989586621679227609"><span class="hs-identifier">hsc_ptr</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">peekByteOff</span><span> </span><a href="#local-6989586621679227609"><span class="hs-identifier hs-var">hsc_ptr</span></a><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">ptr</span><span>
</span><a name="line-220"></a><span class="hs-pragma">{-# LINE 211 &quot;ffi/Analysis/Parsimony/Dynamic/DirectOptimization/Pairwise/FFI.hsc&quot; #-}</span><span>
</span><a name="line-221"></a><span>        </span><span class="hs-identifier">costMatrixDimensionVal</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679227613"><a href="#local-6989586621679227613"><span class="hs-identifier">hsc_ptr</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">peekByteOff</span><span> </span><a href="#local-6989586621679227613"><span class="hs-identifier hs-var">hsc_ptr</span></a><span> </span><span class="hs-number">8</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">ptr</span><span>
</span><a name="line-222"></a><span class="hs-pragma">{-# LINE 212 &quot;ffi/Analysis/Parsimony/Dynamic/DirectOptimization/Pairwise/FFI.hsc&quot; #-}</span><span>
</span><a name="line-223"></a><span>        </span><span class="hs-identifier">gapcharVal</span><span>             </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">hsc_ptr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">peekByteOff</span><span> </span><span class="hs-identifier">hsc_ptr</span><span> </span><span class="hs-number">16</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">ptr</span><span>
</span><a name="line-224"></a><span class="hs-pragma">{-# LINE 213 &quot;ffi/Analysis/Parsimony/Dynamic/DirectOptimization/Pairwise/FFI.hsc&quot; #-}</span><span>
</span><a name="line-225"></a><span>        </span><span class="hs-identifier">costModelVal</span><span>           </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-glyph">\</span><a href="#local-6989586621679227594"><span class="hs-identifier hs-var">hsc_ptr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">peekByteOff</span><span> </span><span class="hs-identifier">hsc_ptr</span><span> </span><span class="hs-number">20</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">ptr</span><span>
</span><a name="line-226"></a><span class="hs-pragma">{-# LINE 214 &quot;ffi/Analysis/Parsimony/Dynamic/DirectOptimization/Pairwise/FFI.hsc&quot; #-}</span><span>
</span><a name="line-227"></a><span>        </span><span class="hs-identifier">combosVal</span><span>              </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-glyph">\</span><a href="#local-6989586621679227598"><span class="hs-identifier hs-var">hsc_ptr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">peekByteOff</span><span> </span><span class="hs-identifier">hsc_ptr</span><span> </span><span class="hs-number">24</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">ptr</span><span>
</span><a name="line-228"></a><span class="hs-pragma">{-# LINE 215 &quot;ffi/Analysis/Parsimony/Dynamic/DirectOptimization/Pairwise/FFI.hsc&quot; #-}</span><span>
</span><a name="line-229"></a><span>        </span><span class="hs-identifier">gapOpenVal</span><span>             </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-glyph">\</span><a href="#local-6989586621679227602"><span class="hs-identifier hs-var">hsc_ptr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">peekByteOff</span><span> </span><span class="hs-identifier">hsc_ptr</span><span> </span><span class="hs-number">28</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">ptr</span><span>
</span><a name="line-230"></a><span class="hs-pragma">{-# LINE 216 &quot;ffi/Analysis/Parsimony/Dynamic/DirectOptimization/Pairwise/FFI.hsc&quot; #-}</span><span>
</span><a name="line-231"></a><span>        </span><span class="hs-identifier">metricVal</span><span>              </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-glyph">\</span><a href="#local-6989586621679227606"><span class="hs-identifier hs-var">hsc_ptr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">peekByteOff</span><span> </span><span class="hs-identifier">hsc_ptr</span><span> </span><span class="hs-number">32</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">ptr</span><span>
</span><a name="line-232"></a><span class="hs-pragma">{-# LINE 217 &quot;ffi/Analysis/Parsimony/Dynamic/DirectOptimization/Pairwise/FFI.hsc&quot; #-}</span><span>
</span><a name="line-233"></a><span>        </span><span class="hs-identifier">elemsVal</span><span>               </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">hsc_ptr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">peekByteOff</span><span> </span><span class="hs-identifier">hsc_ptr</span><span> </span><span class="hs-number">40</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">ptr</span><span>
</span><a name="line-234"></a><span class="hs-pragma">{-# LINE 218 &quot;ffi/Analysis/Parsimony/Dynamic/DirectOptimization/Pairwise/FFI.hsc&quot; #-}</span><span>
</span><a name="line-235"></a><span>        </span><span class="hs-identifier">bestVal</span><span>                </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-glyph">\</span><a href="#local-6989586621679227614"><span class="hs-identifier hs-var">hsc_ptr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">peekByteOff</span><span> </span><span class="hs-identifier">hsc_ptr</span><span> </span><span class="hs-number">48</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">ptr</span><span>
</span><a name="line-236"></a><span class="hs-pragma">{-# LINE 219 &quot;ffi/Analysis/Parsimony/Dynamic/DirectOptimization/Pairwise/FFI.hsc&quot; #-}</span><span>
</span><a name="line-237"></a><span>        </span><span class="hs-identifier">medsVal</span><span>                </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">hsc_ptr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">peekByteOff</span><span> </span><span class="hs-identifier">hsc_ptr</span><span> </span><span class="hs-number">56</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">ptr</span><span>
</span><a name="line-238"></a><span class="hs-pragma">{-# LINE 220 &quot;ffi/Analysis/Parsimony/Dynamic/DirectOptimization/Pairwise/FFI.hsc&quot; #-}</span><span>
</span><a name="line-239"></a><span>        </span><span class="hs-identifier">worstVal</span><span>               </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">hsc_ptr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">peekByteOff</span><span> </span><span class="hs-identifier">hsc_ptr</span><span> </span><span class="hs-number">64</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">ptr</span><span>
</span><a name="line-240"></a><span class="hs-pragma">{-# LINE 221 &quot;ffi/Analysis/Parsimony/Dynamic/DirectOptimization/Pairwise/FFI.hsc&quot; #-}</span><span>
</span><a name="line-241"></a><span>        </span><span class="hs-identifier">prependVal</span><span>             </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">hsc_ptr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">peekByteOff</span><span> </span><span class="hs-identifier">hsc_ptr</span><span> </span><span class="hs-number">72</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">ptr</span><span>
</span><a name="line-242"></a><span class="hs-pragma">{-# LINE 222 &quot;ffi/Analysis/Parsimony/Dynamic/DirectOptimization/Pairwise/FFI.hsc&quot; #-}</span><span>
</span><a name="line-243"></a><span>        </span><span class="hs-identifier">tailVal</span><span>                </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">hsc_ptr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">peekByteOff</span><span> </span><span class="hs-identifier">hsc_ptr</span><span> </span><span class="hs-number">80</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">ptr</span><span>
</span><a name="line-244"></a><span class="hs-pragma">{-# LINE 223 &quot;ffi/Analysis/Parsimony/Dynamic/DirectOptimization/Pairwise/FFI.hsc&quot; #-}</span><span>
</span><a name="line-245"></a><span>        </span><span class="hs-identifier">pure</span><span> </span><span class="hs-identifier">CostMatrix2d</span><span>
</span><a name="line-246"></a><span>            </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">alphSize</span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">aSizeVal</span><span>
</span><a name="line-247"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">costMatrixDimension</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">costMatrixDimensionVal</span><span>
</span><a name="line-248"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">gapChar</span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">gapcharVal</span><span>
</span><a name="line-249"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">costModelType</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">costModelVal</span><span>
</span><a name="line-250"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">include_ambiguities</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">combosVal</span><span>
</span><a name="line-251"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">gapOpenCost</span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">gapOpenVal</span><span>
</span><a name="line-252"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">isMetric</span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">metricVal</span><span>
</span><a name="line-253"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">allElems</span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">elemsVal</span><span>
</span><a name="line-254"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">bestCost</span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">bestVal</span><span>
</span><a name="line-255"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">medians</span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">medsVal</span><span>
</span><a name="line-256"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">worstCost</span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">worstVal</span><span>
</span><a name="line-257"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">prependCost</span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">prependVal</span><span>
</span><a name="line-258"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">tailCost</span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">tailVal</span><span>
</span><a name="line-259"></a><span>            </span><span class="hs-special">}</span><span>
</span><a name="line-260"></a><span>
</span><a name="line-261"></a><span>    </span><span class="hs-identifier">poke</span><span> </span><span class="hs-identifier">ptr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">CostMatrix2d</span><span>
</span><a name="line-262"></a><span>                  </span><span class="hs-identifier">alphSizeVal</span><span>
</span><a name="line-263"></a><span>                  </span><span class="hs-identifier">costMatrixDimensionVal</span><span>
</span><a name="line-264"></a><span>                  </span><span class="hs-identifier">gapCharVal</span><span>
</span><a name="line-265"></a><span>                  </span><span class="hs-identifier">costModelTypeVal</span><span>
</span><a name="line-266"></a><span>                  </span><span class="hs-identifier">include_ambiguitiesVal</span><span>
</span><a name="line-267"></a><span>                  </span><span class="hs-identifier">gapOpenVal</span><span>
</span><a name="line-268"></a><span>                  </span><span class="hs-identifier">isMetricVal</span><span>
</span><a name="line-269"></a><span>                  </span><a href="Analysis.Parsimony.Dynamic.DirectOptimization.Pairwise.FFI.html#CostMatrix3d"><span class="hs-identifier hs-type">elemsVal</span></a><span>
</span><a name="line-270"></a><span>                  </span><span class="hs-identifier">bestCostVal</span><span>
</span><a name="line-271"></a><span>                  </span><span class="hs-identifier">mediansVal</span><span>
</span><a name="line-272"></a><span>                  </span><span class="hs-identifier">worstCostVal</span><span>
</span><a name="line-273"></a><span>                  </span><span class="hs-identifier">prependCostVal</span><span>
</span><a name="line-274"></a><span>                  </span><span class="hs-identifier">tailCostVal</span><span>
</span><a name="line-275"></a><span>              </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-comment">-- to modify values in the C app</span><span>
</span><a name="line-276"></a><span>        </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679227589"><a href="#local-6989586621679227589"><span class="hs-identifier">hsc_ptr</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">pokeByteOff</span><span> </span><span class="hs-identifier">hsc_ptr</span><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">ptr</span><span> </span><span class="hs-identifier">alphSizeVal</span><span>
</span><a name="line-277"></a><span class="hs-pragma">{-# LINE 255 &quot;ffi/Analysis/Parsimony/Dynamic/DirectOptimization/Pairwise/FFI.hsc&quot; #-}</span><span>
</span><a name="line-278"></a><span>        </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">hsc_ptr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">pokeByteOff</span><span> </span><span class="hs-identifier">hsc_ptr</span><span> </span><span class="hs-number">8</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">ptr</span><span> </span><span class="hs-identifier">costMatrixDimensionVal</span><span>
</span><a name="line-279"></a><span class="hs-pragma">{-# LINE 256 &quot;ffi/Analysis/Parsimony/Dynamic/DirectOptimization/Pairwise/FFI.hsc&quot; #-}</span><span>
</span><a name="line-280"></a><span>        </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">hsc_ptr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">pokeByteOff</span><span> </span><span class="hs-identifier">hsc_ptr</span><span> </span><span class="hs-number">16</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">ptr</span><span> </span><span class="hs-identifier">gapCharVal</span><span>
</span><a name="line-281"></a><span class="hs-pragma">{-# LINE 257 &quot;ffi/Analysis/Parsimony/Dynamic/DirectOptimization/Pairwise/FFI.hsc&quot; #-}</span><span>
</span><a name="line-282"></a><span>        </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">hsc_ptr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">pokeByteOff</span><span> </span><span class="hs-identifier">hsc_ptr</span><span> </span><span class="hs-number">20</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">ptr</span><span> </span><span class="hs-identifier">costModelTypeVal</span><span>
</span><a name="line-283"></a><span class="hs-pragma">{-# LINE 258 &quot;ffi/Analysis/Parsimony/Dynamic/DirectOptimization/Pairwise/FFI.hsc&quot; #-}</span><span>
</span><a name="line-284"></a><span>        </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">hsc_ptr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">pokeByteOff</span><span> </span><span class="hs-identifier">hsc_ptr</span><span> </span><span class="hs-number">24</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">ptr</span><span> </span><span class="hs-identifier">include_ambiguitiesVal</span><span>
</span><a name="line-285"></a><span class="hs-pragma">{-# LINE 259 &quot;ffi/Analysis/Parsimony/Dynamic/DirectOptimization/Pairwise/FFI.hsc&quot; #-}</span><span>
</span><a name="line-286"></a><span>        </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">hsc_ptr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">pokeByteOff</span><span> </span><span class="hs-identifier">hsc_ptr</span><span> </span><span class="hs-number">28</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">ptr</span><span> </span><span class="hs-identifier">gapOpenVal</span><span>
</span><a name="line-287"></a><span class="hs-pragma">{-# LINE 260 &quot;ffi/Analysis/Parsimony/Dynamic/DirectOptimization/Pairwise/FFI.hsc&quot; #-}</span><span>
</span><a name="line-288"></a><span>        </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">hsc_ptr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">pokeByteOff</span><span> </span><span class="hs-identifier">hsc_ptr</span><span> </span><span class="hs-number">32</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">ptr</span><span> </span><span class="hs-identifier">isMetricVal</span><span>
</span><a name="line-289"></a><span class="hs-pragma">{-# LINE 261 &quot;ffi/Analysis/Parsimony/Dynamic/DirectOptimization/Pairwise/FFI.hsc&quot; #-}</span><span>
</span><a name="line-290"></a><span>        </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">hsc_ptr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">pokeByteOff</span><span> </span><span class="hs-identifier">hsc_ptr</span><span> </span><span class="hs-number">40</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">ptr</span><span> </span><span class="hs-identifier">elemsVal</span><span>
</span><a name="line-291"></a><span class="hs-pragma">{-# LINE 262 &quot;ffi/Analysis/Parsimony/Dynamic/DirectOptimization/Pairwise/FFI.hsc&quot; #-}</span><span>
</span><a name="line-292"></a><span>        </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">hsc_ptr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">pokeByteOff</span><span> </span><span class="hs-identifier">hsc_ptr</span><span> </span><span class="hs-number">48</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">ptr</span><span> </span><span class="hs-identifier">bestCostVal</span><span>
</span><a name="line-293"></a><span class="hs-pragma">{-# LINE 263 &quot;ffi/Analysis/Parsimony/Dynamic/DirectOptimization/Pairwise/FFI.hsc&quot; #-}</span><span>
</span><a name="line-294"></a><span>        </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">hsc_ptr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">pokeByteOff</span><span> </span><span class="hs-identifier">hsc_ptr</span><span> </span><span class="hs-number">56</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">ptr</span><span> </span><span class="hs-identifier">mediansVal</span><span>
</span><a name="line-295"></a><span class="hs-pragma">{-# LINE 264 &quot;ffi/Analysis/Parsimony/Dynamic/DirectOptimization/Pairwise/FFI.hsc&quot; #-}</span><span>
</span><a name="line-296"></a><span>        </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">hsc_ptr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">pokeByteOff</span><span> </span><span class="hs-identifier">hsc_ptr</span><span> </span><span class="hs-number">64</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">ptr</span><span> </span><span class="hs-identifier">worstCostVal</span><span>
</span><a name="line-297"></a><span class="hs-pragma">{-# LINE 265 &quot;ffi/Analysis/Parsimony/Dynamic/DirectOptimization/Pairwise/FFI.hsc&quot; #-}</span><span>
</span><a name="line-298"></a><span>        </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679227557"><a href="#local-6989586621679227557"><span class="hs-identifier">hsc_ptr</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">pokeByteOff</span><span> </span><span class="hs-identifier">hsc_ptr</span><span> </span><span class="hs-number">72</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">ptr</span><span> </span><span class="hs-identifier">prependCostVal</span><span>
</span><a name="line-299"></a><span class="hs-pragma">{-# LINE 266 &quot;ffi/Analysis/Parsimony/Dynamic/DirectOptimization/Pairwise/FFI.hsc&quot; #-}</span><span>
</span><a name="line-300"></a><span>        </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">hsc_ptr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">pokeByteOff</span><span> </span><span class="hs-identifier">hsc_ptr</span><span> </span><span class="hs-number">80</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">ptr</span><span> </span><span class="hs-identifier">tailCostVal</span><span>
</span><a name="line-301"></a><span class="hs-pragma">{-# LINE 267 &quot;ffi/Analysis/Parsimony/Dynamic/DirectOptimization/Pairwise/FFI.hsc&quot; #-}</span><span>
</span><a name="line-302"></a><span>
</span><a name="line-303"></a><span>
</span><a name="line-304"></a><span class="hs-keyword">instance</span><span> </span><a name="local-6989586621679227569"><a href="#local-6989586621679227569"><span class="hs-identifier">NFData</span></a></a><span> </span><span class="hs-identifier">CostMatrix3d</span><span>
</span><a name="line-305"></a><span>
</span><a name="line-306"></a><span>
</span><a name="line-307"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier">Show</span><span> </span><span class="hs-identifier">CostMatrix3d</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-308"></a><span>
</span><a name="line-309"></a><span>    </span><span class="hs-identifier">show</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">unlines</span><span> </span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">fieldRendering</span><span> </span><span class="hs-operator">&lt;*&gt;</span><span class="hs-special">)</span><span>  </span><a href="#local-6989586621679227559"><span class="hs-operator hs-var">.</span></a><span> </span><a href="#local-6989586621679227559"><span class="hs-identifier hs-var">pure</span></a><span>
</span><a name="line-310"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-311"></a><span>        </span><span class="hs-identifier">fieldRendering</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-312"></a><span>            </span><span class="hs-special">[</span><span> </span><span class="hs-identifier">show</span><span> </span><span class="hs-operator">.</span><span> </span><span class="hs-identifier">alphSize3D</span><span>
</span><a name="line-313"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">show</span><span> </span><span class="hs-operator">.</span><span> </span><span class="hs-identifier">costMatrixDimension3D</span><span>
</span><a name="line-314"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">show</span><span> </span><span class="hs-operator">.</span><span> </span><span class="hs-identifier">gapChar3D</span><span>
</span><a name="line-315"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">show</span><span> </span><span class="hs-operator">.</span><span> </span><span class="hs-identifier">costModelType3D</span><span>
</span><a name="line-316"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">show</span><span> </span><span class="hs-operator">.</span><span> </span><span class="hs-identifier">include_ambiguities3D</span><span>
</span><a name="line-317"></a><span>            </span><span class="hs-special">,</span><span> </span><a href="Analysis.Parsimony.Dynamic.DirectOptimization.Pairwise.FFI.html#CostMatrix3d"><span class="hs-identifier hs-var">show</span></a><span> </span><a href="Analysis.Parsimony.Dynamic.DirectOptimization.Pairwise.FFI.html#CostMatrix3d"><span class="hs-operator hs-var">.</span></a><span> </span><span class="hs-identifier">gapOpenCost3D</span><span>
</span><a name="line-318"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">show</span><span> </span><a name="local-6989586621679227571"><a href="#local-6989586621679227571"><span class="hs-operator">.</span></a></a><span> </span><span class="hs-identifier">allElems3D</span><span>
</span><a name="line-319"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">show</span><span> </span><a name="local-6989586621679227572"><a href="#local-6989586621679227572"><span class="hs-operator">.</span></a></a><span> </span><a name="local-6989586621679227572"><a href="#local-6989586621679227572"><span class="hs-identifier">bestCost3D</span></a></a><span>
</span><a name="line-320"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">show</span><span> </span><a name="local-6989586621679227573"><a href="#local-6989586621679227573"><span class="hs-operator">.</span></a></a><span> </span><span class="hs-identifier">medians3D</span><span>
</span><a name="line-321"></a><span>            </span><span class="hs-special">]</span><span>
</span><a name="line-322"></a><span>
</span><a name="line-323"></a><span>
</span><a name="line-324"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier">Storable</span><span> </span><span class="hs-identifier">CostMatrix3d</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-325"></a><span>
</span><a name="line-326"></a><span>    </span><span class="hs-identifier">sizeOf</span><span> </span><span class="hs-identifier">_</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-number">88</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-327"></a><span class="hs-pragma">{-# LINE 292 &quot;ffi/Analysis/Parsimony/Dynamic/DirectOptimization/Pairwise/FFI.hsc&quot; #-}</span><span>
</span><a name="line-328"></a><span>
</span><a name="line-329"></a><span>    </span><span class="hs-identifier">alignment</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">sizeOf</span><span> </span><span class="hs-comment">-- alignment (undefined :: StablePtr CostMatrix2d)</span><span>
</span><a name="line-330"></a><span>
</span><a name="line-331"></a><span>    </span><span class="hs-identifier">peek</span><span> </span><span class="hs-identifier">ptr</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-332"></a><span>        </span><span class="hs-identifier">aSizeVal</span><span>               </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">hsc_ptr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">peekByteOff</span><span> </span><a href="#local-6989586621679227575"><span class="hs-identifier hs-var">hsc_ptr</span></a><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">ptr</span><span>
</span><a name="line-333"></a><span class="hs-pragma">{-# LINE 297 &quot;ffi/Analysis/Parsimony/Dynamic/DirectOptimization/Pairwise/FFI.hsc&quot; #-}</span><span>
</span><a name="line-334"></a><span>        </span><span class="hs-identifier">costMatrixDimensionVal</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">hsc_ptr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">peekByteOff</span><span> </span><span class="hs-identifier">hsc_ptr</span><span> </span><span class="hs-number">8</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">ptr</span><span>
</span><a name="line-335"></a><span class="hs-pragma">{-# LINE 298 &quot;ffi/Analysis/Parsimony/Dynamic/DirectOptimization/Pairwise/FFI.hsc&quot; #-}</span><span>
</span><a name="line-336"></a><span>        </span><span class="hs-identifier">gapcharVal</span><span>             </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">hsc_ptr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">peekByteOff</span><span> </span><span class="hs-identifier">hsc_ptr</span><span> </span><span class="hs-number">16</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">ptr</span><span>
</span><a name="line-337"></a><span class="hs-pragma">{-# LINE 299 &quot;ffi/Analysis/Parsimony/Dynamic/DirectOptimization/Pairwise/FFI.hsc&quot; #-}</span><span>
</span><a name="line-338"></a><span>        </span><span class="hs-identifier">costModelVal</span><span>           </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">hsc_ptr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">peekByteOff</span><span> </span><span class="hs-identifier">hsc_ptr</span><span> </span><span class="hs-number">20</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">ptr</span><span>
</span><a name="line-339"></a><span class="hs-pragma">{-# LINE 300 &quot;ffi/Analysis/Parsimony/Dynamic/DirectOptimization/Pairwise/FFI.hsc&quot; #-}</span><span>
</span><a name="line-340"></a><span>        </span><span class="hs-identifier">combosVal</span><span>              </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">hsc_ptr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">peekByteOff</span><span> </span><span class="hs-identifier">hsc_ptr</span><span> </span><span class="hs-number">24</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">ptr</span><span>
</span><a name="line-341"></a><span class="hs-pragma">{-# LINE 301 &quot;ffi/Analysis/Parsimony/Dynamic/DirectOptimization/Pairwise/FFI.hsc&quot; #-}</span><span>
</span><a name="line-342"></a><span>        </span><span class="hs-identifier">gapOpenVal</span><span>             </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">hsc_ptr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">peekByteOff</span><span> </span><span class="hs-identifier">hsc_ptr</span><span> </span><span class="hs-number">28</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">ptr</span><span>
</span><a name="line-343"></a><span class="hs-pragma">{-# LINE 302 &quot;ffi/Analysis/Parsimony/Dynamic/DirectOptimization/Pairwise/FFI.hsc&quot; #-}</span><span>
</span><a name="line-344"></a><span>        </span><span class="hs-identifier">elemsVal</span><span>               </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">hsc_ptr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">peekByteOff</span><span> </span><span class="hs-identifier">hsc_ptr</span><span> </span><span class="hs-number">32</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">ptr</span><span>
</span><a name="line-345"></a><span class="hs-pragma">{-# LINE 303 &quot;ffi/Analysis/Parsimony/Dynamic/DirectOptimization/Pairwise/FFI.hsc&quot; #-}</span><span>
</span><a name="line-346"></a><span>        </span><span class="hs-identifier">bestVal</span><span>                </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">hsc_ptr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">peekByteOff</span><span> </span><span class="hs-identifier">hsc_ptr</span><span> </span><span class="hs-number">40</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">ptr</span><span>
</span><a name="line-347"></a><span class="hs-pragma">{-# LINE 304 &quot;ffi/Analysis/Parsimony/Dynamic/DirectOptimization/Pairwise/FFI.hsc&quot; #-}</span><span>
</span><a name="line-348"></a><span>        </span><span class="hs-identifier">medsVal</span><span>                </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">hsc_ptr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">peekByteOff</span><span> </span><span class="hs-identifier">hsc_ptr</span><span> </span><span class="hs-number">48</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">ptr</span><span>
</span><a name="line-349"></a><span class="hs-pragma">{-# LINE 305 &quot;ffi/Analysis/Parsimony/Dynamic/DirectOptimization/Pairwise/FFI.hsc&quot; #-}</span><span>
</span><a name="line-350"></a><span>        </span><span class="hs-identifier">pure</span><span> </span><span class="hs-identifier">CostMatrix3d</span><span>
</span><a name="line-351"></a><span>            </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">alphSize3D</span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">aSizeVal</span><span>
</span><a name="line-352"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">costMatrixDimension3D</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">costMatrixDimensionVal</span><span>
</span><a name="line-353"></a><span>            </span><span class="hs-special">,</span><span> </span><a href="Analysis.Parsimony.Dynamic.DirectOptimization.Pairwise.FFI.html#MedianContext"><span class="hs-identifier hs-type">gapChar3D</span></a><span>             </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">gapcharVal</span><span>
</span><a name="line-354"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">costModelType3D</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">costModelVal</span><span>
</span><a name="line-355"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">include_ambiguities3D</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">combosVal</span><span>
</span><a name="line-356"></a><span>            </span><span class="hs-special">,</span><span> </span><a href="Analysis.Parsimony.Dynamic.DirectOptimization.Pairwise.FFI.html#DoNotComputeMedians"><span class="hs-identifier hs-var">gapOpenCost3D</span></a><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">gapOpenVal</span><span>
</span><a name="line-357"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">allElems3D</span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">elemsVal</span><span>
</span><a name="line-358"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">bestCost3D</span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">bestVal</span><span>
</span><a name="line-359"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">medians3D</span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">medsVal</span><span>
</span><a name="line-360"></a><span>            </span><span class="hs-special">}</span><span>
</span><a name="line-361"></a><span>
</span><a name="line-362"></a><span>    </span><span class="hs-identifier">poke</span><span> </span><span class="hs-identifier hs-type">ptr</span><span> </span><span class="hs-special">(</span><a href="Analysis.Parsimony.Dynamic.DirectOptimization.Pairwise.FFI.html#UnionContext"><span class="hs-identifier hs-type">CostMatrix3d</span></a><span>
</span><a name="line-363"></a><span>                  </span><span class="hs-identifier">alphSizeVal</span><span>
</span><a name="line-364"></a><span>                  </span><span class="hs-identifier">costMatrixDimensionVal</span><span>
</span><a name="line-365"></a><span>                  </span><a href="Analysis.Parsimony.Dynamic.DirectOptimization.Pairwise.FFI.html#DoNotComputeUnions"><span class="hs-identifier hs-var">gapCharVal</span></a><span>
</span><a name="line-366"></a><span>                  </span><span class="hs-identifier">costModelTypeVal</span><span>
</span><a name="line-367"></a><span>                  </span><span class="hs-identifier">include_ambiguitiesVal</span><span>
</span><a name="line-368"></a><span>                  </span><span class="hs-identifier">gapOpenVal</span><span>
</span><a name="line-369"></a><span>                  </span><span class="hs-identifier">elemsVal</span><span>
</span><a name="line-370"></a><span>                  </span><span class="hs-identifier">bestCostVal</span><span>
</span><a name="line-371"></a><span>                  </span><span class="hs-identifier">mediansVal</span><span>
</span><a name="line-372"></a><span>              </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-comment">-- to modify values in the C app</span><span>
</span><a name="line-373"></a><span>        </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">hsc_ptr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">pokeByteOff</span><span> </span><span class="hs-identifier">hsc_ptr</span><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">ptr</span><span> </span><span class="hs-identifier">alphSizeVal</span><span>
</span><a name="line-374"></a><span class="hs-pragma">{-# LINE 329 &quot;ffi/Analysis/Parsimony/Dynamic/DirectOptimization/Pairwise/FFI.hsc&quot; #-}</span><span>
</span><a name="line-375"></a><span>        </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">hsc_ptr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">pokeByteOff</span><span> </span><span class="hs-identifier">hsc_ptr</span><span> </span><span class="hs-number">8</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">ptr</span><span> </span><span class="hs-identifier">costMatrixDimensionVal</span><span>
</span><a name="line-376"></a><span class="hs-pragma">{-# LINE 330 &quot;ffi/Analysis/Parsimony/Dynamic/DirectOptimization/Pairwise/FFI.hsc&quot; #-}</span><span>
</span><a name="line-377"></a><span>        </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">hsc_ptr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">pokeByteOff</span><span> </span><span class="hs-identifier">hsc_ptr</span><span> </span><span class="hs-number">16</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">ptr</span><span> </span><span class="hs-identifier">gapCharVal</span><span>
</span><a name="line-378"></a><span class="hs-pragma">{-# LINE 331 &quot;ffi/Analysis/Parsimony/Dynamic/DirectOptimization/Pairwise/FFI.hsc&quot; #-}</span><span>
</span><a name="line-379"></a><span>        </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">hsc_ptr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">pokeByteOff</span><span> </span><span class="hs-identifier">hsc_ptr</span><span> </span><span class="hs-number">20</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">ptr</span><span> </span><span class="hs-identifier">costModelTypeVal</span><span>
</span><a name="line-380"></a><span class="hs-pragma">{-# LINE 332 &quot;ffi/Analysis/Parsimony/Dynamic/DirectOptimization/Pairwise/FFI.hsc&quot; #-}</span><span>
</span><a name="line-381"></a><span>        </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">hsc_ptr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">pokeByteOff</span><span> </span><span class="hs-identifier">hsc_ptr</span><span> </span><span class="hs-number">24</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">ptr</span><span> </span><span class="hs-identifier">include_ambiguitiesVal</span><span>
</span><a name="line-382"></a><span class="hs-pragma">{-# LINE 333 &quot;ffi/Analysis/Parsimony/Dynamic/DirectOptimization/Pairwise/FFI.hsc&quot; #-}</span><span>
</span><a name="line-383"></a><span>        </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">hsc_ptr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">pokeByteOff</span><span> </span><span class="hs-identifier">hsc_ptr</span><span> </span><span class="hs-number">28</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">ptr</span><span> </span><span class="hs-identifier">gapOpenVal</span><span>
</span><a name="line-384"></a><span class="hs-pragma">{-# LINE 334 &quot;ffi/Analysis/Parsimony/Dynamic/DirectOptimization/Pairwise/FFI.hsc&quot; #-}</span><span>
</span><a name="line-385"></a><span>        </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">hsc_ptr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">pokeByteOff</span><span> </span><span class="hs-identifier">hsc_ptr</span><span> </span><span class="hs-number">32</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">ptr</span><span> </span><span class="hs-identifier">elemsVal</span><span>
</span><a name="line-386"></a><span class="hs-pragma">{-# LINE 335 &quot;ffi/Analysis/Parsimony/Dynamic/DirectOptimization/Pairwise/FFI.hsc&quot; #-}</span><span>
</span><a name="line-387"></a><span>        </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">hsc_ptr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">pokeByteOff</span><span> </span><a href="Analysis.Parsimony.Dynamic.DirectOptimization.Pairwise.FFI.html#CostMatrix3d"><span class="hs-identifier hs-type">hsc_ptr</span></a><span> </span><span class="hs-number">40</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">ptr</span><span> </span><span class="hs-identifier">bestCostVal</span><span>
</span><a name="line-388"></a><span class="hs-pragma">{-# LINE 336 &quot;ffi/Analysis/Parsimony/Dynamic/DirectOptimization/Pairwise/FFI.hsc&quot; #-}</span><span>
</span><a name="line-389"></a><span>        </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">hsc_ptr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">pokeByteOff</span><span> </span><span class="hs-identifier">hsc_ptr</span><span> </span><span class="hs-number">48</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">ptr</span><span> </span><span class="hs-identifier">mediansVal</span><span>
</span><a name="line-390"></a><span class="hs-pragma">{-# LINE 337 &quot;ffi/Analysis/Parsimony/Dynamic/DirectOptimization/Pairwise/FFI.hsc&quot; #-}</span><span>
</span><a name="line-391"></a><span>
</span><a name="line-392"></a><span>
</span><a name="line-393"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier">NFData</span><span> </span><span class="hs-identifier">DenseTransitionCostMatrix</span><span>
</span><a name="line-394"></a><span>
</span><a name="line-395"></a><span>
</span><a name="line-396"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier">Enum</span><span> </span><span class="hs-identifier">AlignmentStrategy</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-397"></a><span>
</span><a name="line-398"></a><span>    </span><span class="hs-identifier">fromEnum</span><span> </span><span class="hs-identifier">Linear</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-399"></a><span>    </span><span class="hs-identifier">fromEnum</span><span> </span><span class="hs-identifier">Affine</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">3</span><span>
</span><a name="line-400"></a><span>    </span><span class="hs-identifier">fromEnum</span><span> </span><span class="hs-identifier">Other</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">-</span><span class="hs-number">1</span><span>
</span><a name="line-401"></a><span>
</span><a name="line-402"></a><span>    </span><span class="hs-identifier">toEnum</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">Linear</span><span>
</span><a name="line-403"></a><span>    </span><span class="hs-identifier">toEnum</span><span> </span><span class="hs-number">3</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">Affine</span><span>
</span><a name="line-404"></a><span>    </span><span class="hs-identifier">toEnum</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">Other</span><span>
</span><a name="line-405"></a><span>
</span><a name="line-406"></a><span>
</span><a name="line-407"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier">Enum</span><span> </span><span class="hs-identifier">MedianContext</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-408"></a><span>
</span><a name="line-409"></a><span>    </span><span class="hs-identifier">fromEnum</span><span>      </span><span class="hs-identifier">ComputeMedians</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">1</span><span>
</span><a name="line-410"></a><span>    </span><span class="hs-identifier">fromEnum</span><span> </span><span class="hs-identifier">DoNotComputeMedians</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-411"></a><span>
</span><a name="line-412"></a><span>    </span><span class="hs-identifier">toEnum</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">DoNotComputeMedians</span><span>
</span><a name="line-413"></a><span>    </span><span class="hs-identifier">toEnum</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span>      </span><span class="hs-identifier">ComputeMedians</span><span>
</span><a name="line-414"></a><span>
</span><a name="line-415"></a><span>
</span><a name="line-416"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier">Enum</span><span> </span><span class="hs-identifier">UnionContext</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-417"></a><span>
</span><a name="line-418"></a><span>    </span><span class="hs-identifier">fromEnum</span><span>      </span><span class="hs-identifier">ComputeUnions</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">1</span><span>
</span><a name="line-419"></a><span>    </span><span class="hs-identifier">fromEnum</span><span> </span><span class="hs-identifier">DoNotComputeUnions</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-420"></a><span>
</span><a name="line-421"></a><span>    </span><span class="hs-identifier">toEnum</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">DoNotComputeUnions</span><span>
</span><a name="line-422"></a><span>    </span><span class="hs-identifier">toEnum</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span>      </span><span class="hs-identifier">ComputeUnions</span><span>
</span><a name="line-423"></a><span>
</span><a name="line-424"></a><span>
</span><a name="line-425"></a><span class="hs-comment">-- |</span><span>
</span><a name="line-426"></a><span class="hs-comment">-- Create and allocate cost matrix first argument, TCM, is only for non-ambiguous</span><span>
</span><a name="line-427"></a><span class="hs-comment">-- nucleotides, and it used to generate the entire cost matrix, which includes ambiguous elements.</span><span>
</span><a name="line-428"></a><span class="hs-comment">-- TCM is row-major, with each row being the left character element.</span><span>
</span><a name="line-429"></a><span class="hs-comment">-- It is therefore indexed not by powers of two, but by cardinal integer.</span><span>
</span><a name="line-430"></a><span class="hs-identifier">foreign</span><span> </span><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">ccall</span><span> </span><span class="hs-identifier">unsafe</span><span> </span><span class="hs-string">&quot;c_code_alloc_setup.h setUp2dCostMtx&quot;</span><span>
</span><a name="line-431"></a><span>
</span><a name="line-432"></a><span>    </span><span class="hs-identifier">setUpCostMatrix2dFn_c</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">Ptr</span><span> </span><span class="hs-identifier">CostMatrix2d</span><span>
</span><a name="line-433"></a><span>                          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Analysis.Parsimony.Dynamic.DirectOptimization.Pairwise.FFI.html#CostMatrix3d"><span class="hs-identifier hs-type">Ptr</span></a><span> </span><span class="hs-identifier">CUInt</span><span>         </span><span class="hs-comment">-- ^ tcm</span><span>
</span><a name="line-434"></a><span>                          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">CSize</span><span>             </span><span class="hs-comment">-- ^ alphSize</span><span>
</span><a name="line-435"></a><span>                          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">CInt</span><span>              </span><span class="hs-comment">-- ^ gap_open_cost</span><span>
</span><a name="line-436"></a><span>                          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-437"></a><span>
</span><a name="line-438"></a><span>
</span><a name="line-439"></a><span class="hs-identifier">foreign</span><span> </span><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">ccall</span><span> </span><span class="hs-identifier">unsafe</span><span> </span><span class="hs-string">&quot;c_code_alloc_setup.h setUp3dCostMtx&quot;</span><span>
</span><a name="line-440"></a><span>
</span><a name="line-441"></a><span>    </span><span class="hs-identifier">setUpCostMatrix3dFn_c</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">Ptr</span><span> </span><span class="hs-identifier">CostMatrix3d</span><span>
</span><a name="line-442"></a><span>                          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Ptr</span><span> </span><span class="hs-identifier">CUInt</span><span>         </span><span class="hs-comment">-- ^ tcm</span><span>
</span><a name="line-443"></a><span>                          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">CSize</span><span>             </span><span class="hs-comment">-- ^ alphSize</span><span>
</span><a name="line-444"></a><span>                          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">CInt</span><span>              </span><span class="hs-comment">-- ^ gap_open_cost</span><span>
</span><a name="line-445"></a><span>                          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-446"></a><span>
</span><a name="line-447"></a><span>
</span><a name="line-448"></a><span class="hs-identifier">foreign</span><span> </span><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">ccall</span><span> </span><span class="hs-identifier">unsafe</span><span> </span><span class="hs-string">&quot;c_alignment_interface.h align2d&quot;</span><span>
</span><a name="line-449"></a><span>
</span><a name="line-450"></a><span>    </span><span class="hs-identifier">align2dFn_c</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">Ptr</span><span> </span><span class="hs-identifier">Align_io</span><span> </span><span class="hs-comment">-- ^ character1, input &amp; output</span><span>
</span><a name="line-451"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Ptr</span><span> </span><span class="hs-identifier">Align_io</span><span> </span><span class="hs-comment">-- ^ character2, input &amp; output</span><span>
</span><a name="line-452"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Analysis.Parsimony.Dynamic.DirectOptimization.Pairwise.FFI.html#DenseTransitionCostMatrix"><span class="hs-identifier hs-type">Ptr</span></a><span> </span><span class="hs-identifier">Align_io</span><span> </span><span class="hs-comment">-- ^ gapped median output</span><span>
</span><a name="line-453"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><a name="generateDenseTransitionCostMatrix"><a href="Analysis.Parsimony.Dynamic.DirectOptimization.Pairwise.FFI.html#generateDenseTransitionCostMatrix"><span class="hs-identifier">Ptr</span></a></a><span> </span><a name="generateDenseTransitionCostMatrix"><a href="Analysis.Parsimony.Dynamic.DirectOptimization.Pairwise.FFI.html#generateDenseTransitionCostMatrix"><span class="hs-identifier">Align_io</span></a></a><span> </span><span class="hs-comment">-- ^ ungapped median output</span><span>
</span><a name="line-454"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Ptr</span><span> </span><span class="hs-identifier">CostMatrix2d</span><span>
</span><a name="line-455"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Analysis.Parsimony.Dynamic.DirectOptimization.Pairwise.FFI.html#getCostMatrix2dNonAffine"><span class="hs-identifier hs-var">CInt</span></a><span>        </span><span class="hs-comment">-- ^ compute ungapped &amp; not   gapped medians</span><span>
</span><a name="line-456"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Analysis.Parsimony.Dynamic.DirectOptimization.Pairwise.FFI.html#getCostMatrix2dAffine"><span class="hs-identifier hs-var">CInt</span></a><span>        </span><span class="hs-comment">-- ^ compute   gapped &amp; not ungapped medians</span><span>
</span><a name="line-457"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">CInt</span><span>        </span><span class="hs-comment">-- ^ compute union</span><span>
</span><a name="line-458"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">CInt</span><span>        </span><span class="hs-comment">-- ^ cost</span><span>
</span><a name="line-459"></a><span>
</span><a name="line-460"></a><span>
</span><a name="line-461"></a><span class="hs-identifier">foreign</span><span> </span><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">ccall</span><span> </span><span class="hs-identifier">unsafe</span><span> </span><span class="hs-string">&quot;c_alignment_interface.h align2dAffine&quot;</span><span>
</span><a name="line-462"></a><span>
</span><a name="line-463"></a><span>    </span><span class="hs-identifier">align2dAffineFn_c</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">Ptr</span><span> </span><span class="hs-identifier">Align_io</span><span> </span><span class="hs-comment">-- ^ character1, input &amp; output</span><span>
</span><a name="line-464"></a><span>                      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Ptr</span><span> </span><span class="hs-identifier">Align_io</span><span> </span><span class="hs-comment">-- ^ character2, input &amp; output</span><span>
</span><a name="line-465"></a><span>                      </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Bio.Character.Encodable.Dynamic.Class.html#EncodableDynamicCharacter"><span class="hs-identifier hs-type">Ptr</span></a><span> </span><a href="Bio.Character.Encodable.Dynamic.Class.html#EncodableDynamicCharacter"><span class="hs-identifier hs-type">Align_io</span></a><span> </span><span class="hs-comment">-- ^ gapped median output</span><span>
</span><a name="line-466"></a><span>                      </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Bio.Character.Exportable.Class.html#Exportable"><span class="hs-identifier hs-type">Ptr</span></a><span> </span><span class="hs-identifier">Align_io</span><span> </span><span class="hs-comment">-- ^ ungapped median output</span><span>
</span><a name="line-467"></a><span>                      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Ptr</span><span> </span><span class="hs-identifier">CostMatrix2d</span><span>
</span><a name="line-468"></a><span>                      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">CInt</span><span>        </span><span class="hs-comment">-- ^ compute medians</span><span>
</span><a name="line-469"></a><span>                      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">CInt</span><span>        </span><span class="hs-comment">-- ^ cost</span><span>
</span><a name="line-470"></a><span>
</span><a name="line-471"></a><span>
</span><a name="line-472"></a><span class="hs-comment">-- | Create and allocate cost matrix</span><span>
</span><a name="line-473"></a><span class="hs-comment">-- first argument, TCM, is only for non-ambiguous nucleotides, and it used to generate</span><span>
</span><a name="line-474"></a><span class="hs-comment">-- the entire cost matrix, which includes ambiguous elements.</span><span>
</span><a name="line-475"></a><span class="hs-comment">-- TCM is row-major, with each row being the left character element.</span><span>
</span><a name="line-476"></a><span class="hs-comment">-- It is therefore indexed not by powers of two, but by cardinal integer.</span><span>
</span><a name="line-477"></a><span class="hs-identifier">foreign</span><span> </span><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">ccall</span><span> </span><span class="hs-identifier">unsafe</span><span> </span><span class="hs-string">&quot;c_alignment_interface.h align3d&quot;</span><span>
</span><a name="line-478"></a><span>
</span><a name="line-479"></a><span>    </span><span class="hs-identifier">align3dFn_c</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">Ptr</span><span> </span><span class="hs-identifier">Align_io</span><span> </span><span class="hs-comment">-- ^ character1, input</span><span>
</span><a name="line-480"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Ptr</span><span> </span><span class="hs-identifier">Align_io</span><span> </span><span class="hs-comment">-- ^ character2, input</span><span>
</span><a name="line-481"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Ptr</span><span> </span><span class="hs-identifier">Align_io</span><span> </span><span class="hs-comment">-- ^ character3, input</span><span>
</span><a name="line-482"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Ptr</span><span> </span><a href="Bio.Character.Encodable.Dynamic.Class.html#EncodableDynamicCharacter"><span class="hs-identifier hs-type">Align_io</span></a><span> </span><span class="hs-comment">-- ^ character1, output</span><span>
</span><a name="line-483"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Ptr</span><span> </span><a href="Bio.Character.Exportable.Class.html#Exportable"><span class="hs-identifier hs-type">Align_io</span></a><span> </span><span class="hs-comment">-- ^ character2, output</span><span>
</span><a name="line-484"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Ptr</span><span> </span><span class="hs-identifier">Align_io</span><span> </span><span class="hs-comment">-- ^ character3, output</span><span>
</span><a name="line-485"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Ptr</span><span> </span><span class="hs-identifier">Align_io</span><span> </span><span class="hs-comment">-- ^ gapped median output</span><span>
</span><a name="line-486"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Ptr</span><span> </span><span class="hs-identifier">Align_io</span><span> </span><span class="hs-comment">-- ^ ungapped median output</span><span>
</span><a name="line-487"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Ptr</span><span> </span><span class="hs-identifier">CostMatrix3d</span><span>
</span><a name="line-488"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">CInt</span><span>        </span><span class="hs-comment">-- ^ substitution cost</span><span>
</span><a name="line-489"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">CInt</span><span>        </span><span class="hs-comment">-- ^ gap open cost</span><span>
</span><a name="line-490"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">CInt</span><span>        </span><span class="hs-comment">-- ^ indel cost</span><span>
</span><a name="line-491"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">CInt</span><span>        </span><span class="hs-comment">-- ^ alignment cost</span><span>
</span><a name="line-492"></a><span>
</span><a name="line-493"></a><span>
</span><a name="line-494"></a><span class="hs-comment">{- Exported Functions -}</span><span>
</span><a name="line-495"></a><span>
</span><a name="line-496"></a><span>
</span><a name="line-497"></a><span class="hs-comment">-- TODO: Collapse this definition and defer branching to the C side of the FFI call.</span><span>
</span><a name="line-498"></a><span>
</span><a name="line-499"></a><span class="hs-comment">-- |</span><span>
</span><a name="line-500"></a><span class="hs-comment">-- Generate the 2D and 3D dense TCM matricies used for FFI calls to</span><span>
</span><a name="line-501"></a><span class="hs-comment">-- 'foreignPairwiseDO' and 'foreignThreeWayDO'.</span><span>
</span><a name="line-502"></a><span class="hs-identifier">generateDenseTransitionCostMatrix</span><span>
</span><a name="line-503"></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">Word</span><span>                   </span><span class="hs-comment">-- ^ The gap open cost. A zero value indicates non-affine alignment context</span><span>
</span><a name="line-504"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Word</span><span>                   </span><span class="hs-comment">-- ^ The character alphabet size</span><span>
</span><a name="line-505"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a name="getCostMatrix2dNonAffine"><a href="Analysis.Parsimony.Dynamic.DirectOptimization.Pairwise.FFI.html#getCostMatrix2dNonAffine"><span class="hs-identifier">Word</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a name="getCostMatrix2dNonAffine"><a href="Analysis.Parsimony.Dynamic.DirectOptimization.Pairwise.FFI.html#getCostMatrix2dNonAffine"><span class="hs-identifier">Word</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Word</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- ^ The function defining the cost to transition between two symbols</span><span>
</span><a name="line-506"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">DenseTransitionCostMatrix</span><span>
</span><a name="line-507"></a><span class="hs-identifier">generateDenseTransitionCostMatrix</span><span> </span><span class="hs-identifier">affineCost</span><span> </span><span class="hs-identifier">alphabetSize</span><span> </span><span class="hs-identifier">costFunction</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-508"></a><span>    </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">affineCost</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-509"></a><span>      </span><span class="hs-number">0</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">getCostMatrix2dNonAffine</span><span>            </span><span class="hs-identifier">alphabetSize</span><span> </span><span class="hs-identifier">costFunction</span><span>
</span><a name="line-510"></a><span>      </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">getCostMatrix2dAffine</span><span>    </span><span class="hs-identifier">affineCost</span><span> </span><span class="hs-identifier">alphabetSize</span><span> </span><span class="hs-identifier">costFunction</span><span>
</span><a name="line-511"></a><span>
</span><a name="line-512"></a><span>
</span><a name="line-513"></a><span class="hs-comment">-- |</span><span>
</span><a name="line-514"></a><span class="hs-comment">-- Align two dynamic characters using an FFI call for more efficient computation</span><span>
</span><a name="line-515"></a><span class="hs-comment">-- on small alphabet sizes.</span><span>
</span><a name="line-516"></a><span class="hs-comment">--</span><span>
</span><a name="line-517"></a><span class="hs-comment">-- Requires a pre-generated 'DenseTransitionCostMatrix' from a call to</span><span>
</span><a name="line-518"></a><span class="hs-comment">-- 'generateDenseTransitionCostMatrix' defining the alphabet and transition costs.</span><span>
</span><a name="line-519"></a><span class="hs-identifier">foreignPairwiseDO</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier">EncodableDynamicCharacter</span><span> </span><span class="hs-identifier">s</span><span>
</span><a name="line-520"></a><span>                     </span><span class="hs-special">,</span><span> </span><a href="Analysis.Parsimony.Dynamic.DirectOptimization.Pairwise.FFI.html#setUpCostMatrix2dFn_c"><span class="hs-identifier hs-var">Exportable</span></a><span> </span><a href="Analysis.Parsimony.Dynamic.DirectOptimization.Pairwise.FFI.html#setUpCostMatrix2dFn_c"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-521"></a><span class="hs-comment">--                     , Show s</span><span>
</span><a name="line-522"></a><span>                     </span><span class="hs-special">)</span><span>
</span><a name="line-523"></a><span>                  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier">s</span><span>                         </span><span class="hs-comment">-- ^ First  dynamic character</span><span>
</span><a name="line-524"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">s</span><span>                         </span><span class="hs-comment">-- ^ Second dynamic character</span><span>
</span><a name="line-525"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">DenseTransitionCostMatrix</span><span> </span><span class="hs-comment">-- ^ Structure defining the transition costs between character states</span><span>
</span><a name="line-526"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">Word</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">s</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">s</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">s</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">s</span><span class="hs-special">)</span><span>        </span><span class="hs-comment">-- ^ The /ungapped/ character derived from the the input characters' N-W-esque matrix traceback</span><span>
</span><a name="line-527"></a><span class="hs-identifier">foreignPairwiseDO</span><span> </span><a name="local-6989586621679227679"><a href="#local-6989586621679227679"><span class="hs-identifier">lhs</span></a></a><span> </span><span class="hs-identifier">rhs</span><span> </span><a href="Analysis.Parsimony.Dynamic.DirectOptimization.Pairwise.FFI.html#coerceEnum"><span class="hs-identifier hs-var">costMatrix</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679227677"><span class="hs-identifier hs-var">algn2d</span></a><span> </span><a href="#local-6989586621679227677"><span class="hs-identifier hs-var">lhs</span></a><span> </span><span class="hs-identifier">rhs</span><span> </span><span class="hs-identifier">costMatrix</span><span> </span><span class="hs-identifier">DoNotComputeUnions</span><span> </span><span class="hs-identifier">ComputeMedians</span><span>
</span><a name="line-528"></a><span>
</span><a name="line-529"></a><span>
</span><a name="line-530"></a><span class="hs-comment">-- |</span><span>
</span><a name="line-531"></a><span class="hs-comment">-- Align three dynamic characters using an FFI call for more efficient computation</span><span>
</span><a name="line-532"></a><span class="hs-comment">-- on small (or smallish) alphabet sizes.</span><span>
</span><a name="line-533"></a><span class="hs-comment">--</span><span>
</span><a name="line-534"></a><span class="hs-comment">-- Requires a pre-generated 'DenseTransitionCostMatrix' from a call to</span><span>
</span><a name="line-535"></a><span class="hs-comment">-- 'generateDenseTransitionCostMatrix' defining the alphabet and transition costs.</span><span>
</span><a name="line-536"></a><span class="hs-identifier">foreignThreeWayDO</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier">EncodableDynamicCharacter</span><span> </span><span class="hs-identifier">s</span><span>
</span><a name="line-537"></a><span>                     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">Exportable</span><span> </span><span class="hs-identifier">s</span><span>
</span><a name="line-538"></a><span class="hs-comment">--                     , Show s</span><span>
</span><a name="line-539"></a><span>                     </span><span class="hs-special">)</span><span>
</span><a name="line-540"></a><span>                  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier">s</span><span>                         </span><span class="hs-comment">-- ^ First  dynamic character</span><span>
</span><a name="line-541"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">s</span><span>                         </span><span class="hs-comment">-- ^ Second dynamic character</span><span>
</span><a name="line-542"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">s</span><span>                         </span><span class="hs-comment">-- ^ Third  dynamic character</span><span>
</span><a name="line-543"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Bio.Character.Encodable.Dynamic.Class.html#EncodableDynamicCharacter"><span class="hs-identifier hs-type">Int</span></a><span>                       </span><span class="hs-comment">-- ^ Mismatch cost</span><span>
</span><a name="line-544"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Int</span><span>                       </span><span class="hs-comment">-- ^ Gap open cost</span><span>
</span><a name="line-545"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Int</span><span>                       </span><span class="hs-comment">-- ^ Indel cost</span><span>
</span><a name="line-546"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">DenseTransitionCostMatrix</span><span> </span><span class="hs-comment">-- ^ Structure defining the transition costs between character states</span><span>
</span><a name="line-547"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">Word</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">s</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">s</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">s</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">s</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">s</span><span class="hs-special">)</span><span>     </span><span class="hs-comment">-- ^ The /ungapped/ character derived from the the input characters' N-W-esque matrix traceback</span><span>
</span><a name="line-548"></a><span class="hs-identifier">foreignThreeWayDO</span><span> </span><span class="hs-identifier">char1</span><span> </span><span class="hs-identifier">char2</span><span> </span><span class="hs-identifier">char3</span><span> </span><span class="hs-identifier">costMatrix</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">algn3d</span><span> </span><span class="hs-identifier">char1</span><span> </span><span class="hs-identifier">char2</span><span> </span><span class="hs-identifier">char3</span><span> </span><span class="hs-identifier">costMatrix</span><span>
</span><a name="line-549"></a><span>
</span><a name="line-550"></a><span>
</span><a name="line-551"></a><span class="hs-comment">{- Matrix allocation functionality -}</span><span>
</span><a name="line-552"></a><span>
</span><a name="line-553"></a><span>
</span><a name="line-554"></a><span class="hs-comment">-- |</span><span>
</span><a name="line-555"></a><span class="hs-comment">-- Set up and return a non-affine cost matrix</span><span>
</span><a name="line-556"></a><span class="hs-comment">--</span><span>
</span><a name="line-557"></a><span class="hs-comment">-- The cost matrix is allocated strictly.</span><span>
</span><a name="line-558"></a><span class="hs-identifier">getCostMatrix2dNonAffine</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">Word</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">Word</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Word</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Word</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">DenseTransitionCostMatrix</span><span>
</span><a name="line-559"></a><span class="hs-identifier">getCostMatrix2dNonAffine</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">performMatrixAllocation</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-560"></a><span>
</span><a name="line-561"></a><span>
</span><a name="line-562"></a><span class="hs-comment">-- |</span><span>
</span><a name="line-563"></a><span class="hs-comment">-- Set up and return a non-affine cost matrix</span><span>
</span><a name="line-564"></a><span class="hs-comment">--</span><span>
</span><a name="line-565"></a><span class="hs-comment">-- The cost matrix is allocated strictly.</span><span>
</span><a name="line-566"></a><span class="hs-identifier">getCostMatrix2dAffine</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">Word</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Word</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">Word</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Word</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Word</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">DenseTransitionCostMatrix</span><span>
</span><a name="line-567"></a><span class="hs-identifier">getCostMatrix2dAffine</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">performMatrixAllocation</span><span>
</span><a name="line-568"></a><span>
</span><a name="line-569"></a><span>
</span><a name="line-570"></a><span class="hs-identifier">performMatrixAllocation</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">Word</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Word</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">Word</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Word</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Word</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">DenseTransitionCostMatrix</span><span>
</span><a name="line-571"></a><span class="hs-identifier">performMatrixAllocation</span><span> </span><span class="hs-identifier">openningCost</span><span> </span><span class="hs-identifier">alphabetSize</span><span> </span><a href="#local-6989586621679227701"><span class="hs-identifier hs-var">costFn</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">unsafePerformIO</span><span> </span><a href="#local-6989586621679227699"><span class="hs-operator hs-var">.</span></a><span> </span><span class="hs-identifier">withArray</span><span> </span><span class="hs-identifier">rowMajorList</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-glyph">\</span><span class="hs-identifier">allocedTCM</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-572"></a><span>        </span><span class="hs-glyph">!</span><span class="hs-identifier">ptr2D</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a name="local-6989586621679227703"><a href="#local-6989586621679227703"><span class="hs-identifier">malloc</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">IO</span><span> </span><span class="hs-special">(</span><a href="Analysis.Parsimony.Dynamic.DirectOptimization.Pairwise.FFI.html#allocInitAlign_io"><span class="hs-identifier hs-var">Ptr</span></a><span> </span><a href="Analysis.Parsimony.Dynamic.DirectOptimization.Pairwise.FFI.html#allocInitAlign_io"><span class="hs-identifier hs-var">CostMatrix2d</span></a><span class="hs-special">)</span><span>
</span><a name="line-573"></a><span>        </span><span class="hs-glyph">!</span><span class="hs-identifier">ptr3D</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a name="local-6989586621679227704"><a href="#local-6989586621679227704"><span class="hs-identifier">malloc</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">IO</span><span> </span><span class="hs-special">(</span><a href="Analysis.Parsimony.Dynamic.DirectOptimization.Pairwise.FFI.html#allocInitAlign_io"><span class="hs-identifier hs-var">Ptr</span></a><span> </span><a href="Analysis.Parsimony.Dynamic.DirectOptimization.Pairwise.FFI.html#allocInitAlign_io"><span class="hs-identifier hs-var">CostMatrix3d</span></a><span class="hs-special">)</span><span>
</span><a name="line-574"></a><span>        </span><span class="hs-glyph">!</span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">setUpCostMatrix2dFn_c</span><span> </span><a href="Analysis.Parsimony.Dynamic.DirectOptimization.Pairwise.FFI.html#allocInitAlign_io"><span class="hs-identifier hs-var">ptr2D</span></a><span> </span><span class="hs-identifier">allocedTCM</span><span> </span><span class="hs-identifier">matrixDimension</span><span> </span><span class="hs-identifier">gapOpen</span><span>
</span><a name="line-575"></a><span>        </span><span class="hs-glyph">!</span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">setUpCostMatrix3dFn_c</span><span> </span><span class="hs-identifier">ptr3D</span><span> </span><span class="hs-identifier">allocedTCM</span><span> </span><span class="hs-identifier">matrixDimension</span><span> </span><span class="hs-identifier">gapOpen</span><span>
</span><a name="line-576"></a><span>        </span><span class="hs-identifier">pure</span><span> </span><span class="hs-identifier">DenseTransitionCostMatrix</span><span>
</span><a name="line-577"></a><span>             </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">costMatrix2D</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ptr2D</span><span>
</span><a name="line-578"></a><span>             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">costMatrix3D</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ptr3D</span><span>
</span><a name="line-579"></a><span>             </span><span class="hs-special">}</span><span>
</span><a name="line-580"></a><span>    </span><span class="hs-keyword">where</span><span>
</span><a name="line-581"></a><span>        </span><span class="hs-identifier">matrixDimension</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">coerceEnum</span><span> </span><span class="hs-identifier">alphabetSize</span><span>
</span><a name="line-582"></a><span>        </span><span class="hs-identifier">gapOpen</span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">coerceEnum</span><span> </span><span class="hs-identifier">openningCost</span><span>
</span><a name="line-583"></a><span>        </span><span class="hs-identifier">range</span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-number">0</span><span> </span><span class="hs-glyph">..</span><span> </span><span class="hs-identifier">alphabetSize</span><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-number">1</span><span class="hs-special">]</span><span>
</span><a name="line-584"></a><span>        </span><span class="hs-comment">-- This *should* be in row major order due to the manner in which list comprehensions are performed.</span><span>
</span><a name="line-585"></a><span>        </span><span class="hs-identifier">rowMajorList</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier">coerceEnum</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-identifier">costFn</span><span> </span><span class="hs-identifier">i</span><span> </span><span class="hs-identifier">j</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">i</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">range</span><span class="hs-special">,</span><span>  </span><span class="hs-identifier">j</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">range</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-586"></a><span>
</span><a name="line-587"></a><span>
</span><a name="line-588"></a><span class="hs-comment">{- Alignment functionality -}</span><span>
</span><a name="line-589"></a><span>
</span><a name="line-590"></a><span>
</span><a name="line-591"></a><span class="hs-comment">-- |</span><span>
</span><a name="line-592"></a><span class="hs-comment">-- Performs a naive direct optimization</span><span>
</span><a name="line-593"></a><span class="hs-comment">-- Takes in two characters to run DO on and a metadata object</span><span>
</span><a name="line-594"></a><span class="hs-comment">-- Returns an assignment character, the cost of that assignment, the assignment character with gaps included,</span><span>
</span><a name="line-595"></a><span class="hs-comment">-- the aligned version of the first input character, and the aligned version of the second input character</span><span>
</span><a name="line-596"></a><span class="hs-comment">-- The process for this algorithm is to generate a traversal matrix then perform a traceback.</span><span>
</span><a name="line-597"></a><span class="hs-identifier">algn2d</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier">EncodableDynamicCharacter</span><span> </span><span class="hs-identifier">s</span><span>
</span><a name="line-598"></a><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">Exportable</span><span> </span><span class="hs-identifier">s</span><span>
</span><a name="line-599"></a><span class="hs-comment">--          , Show s</span><span>
</span><a name="line-600"></a><span>          </span><span class="hs-special">)</span><span>
</span><a name="line-601"></a><span>       </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier">s</span><span>                         </span><span class="hs-comment">-- ^ First  dynamic character</span><span>
</span><a name="line-602"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">s</span><span>                         </span><span class="hs-comment">-- ^ Second dynamic character</span><span>
</span><a name="line-603"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">DenseTransitionCostMatrix</span><span> </span><span class="hs-comment">-- ^ Structure defining the transition costs between character states</span><span>
</span><a name="line-604"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">UnionContext</span><span>
</span><a name="line-605"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">MedianContext</span><span>
</span><a name="line-606"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">Word</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">s</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">s</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">s</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">s</span><span class="hs-special">)</span><span>        </span><span class="hs-comment">-- ^ The cost of the alignment</span><span>
</span><a name="line-607"></a><span>                                    </span><span class="hs-comment">--</span><span>
</span><a name="line-608"></a><span>                                    </span><span class="hs-comment">--   The /ungapped/ character derived from the the input characters' N-W-esque matrix traceback</span><span>
</span><a name="line-609"></a><span>                                    </span><span class="hs-comment">--</span><span>
</span><a name="line-610"></a><span>                                    </span><span class="hs-comment">--   The /gapped/ character derived from the the input characters' N-W-esque matrix traceback</span><span>
</span><a name="line-611"></a><span>                                    </span><span class="hs-comment">--</span><span>
</span><a name="line-612"></a><span>                                    </span><span class="hs-comment">--   The gapped alignment of the /first/ input character when aligned with the second character</span><span>
</span><a name="line-613"></a><span>                                    </span><span class="hs-comment">--</span><span>
</span><a name="line-614"></a><span>                                    </span><span class="hs-comment">--   The gapped alignment of the /second/ input character when aligned with the first character</span><span>
</span><a name="line-615"></a><span>                                    </span><span class="hs-comment">--</span><span>
</span><a name="line-616"></a><span class="hs-identifier">algn2d</span><span> </span><span class="hs-identifier">char1</span><span> </span><span class="hs-identifier">char2</span><span> </span><span class="hs-identifier">denseTCMs</span><span> </span><span class="hs-identifier">computeUnion</span><span> </span><span class="hs-identifier">computeMedians</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">handleMissingCharacter</span><span> </span><span class="hs-identifier">char1</span><span> </span><span class="hs-identifier">char2</span><span> </span><span class="hs-operator">$</span><span>
</span><a name="line-617"></a><span>    </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">toExportableElements</span><span> </span><span class="hs-identifier">char1</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">toExportableElements</span><span> </span><span class="hs-identifier">char2</span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-618"></a><span>      </span><span class="hs-special">(</span><span class="hs-identifier">Just</span><span> </span><span class="hs-identifier">x</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">Just</span><span> </span><span class="hs-identifier">y</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">f</span><span> </span><span class="hs-identifier">x</span><span> </span><span class="hs-identifier">y</span><span>
</span><a name="line-619"></a><span>      </span><span class="hs-special">(</span><span>     </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span>      </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">error</span><span> </span><span class="hs-string">&quot;2DO: There's a dynamic character missing!&quot;</span><span>
</span><a name="line-620"></a><span>    </span><span class="hs-keyword">where</span><span>
</span><a name="line-621"></a><span>        </span><span class="hs-identifier">f</span><span> </span><span class="hs-identifier">exportedChar1</span><span> </span><span class="hs-identifier">exportedChar2</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">unsafePerformIO</span><span> </span><span class="hs-operator">$</span><span>
</span><a name="line-622"></a><span>            </span><span class="hs-keyword">do</span><span>
</span><a name="line-623"></a><span class="hs-comment">--                !_ &lt;- trace (&quot;char 1: &quot; &lt;&gt; show char1) $ pure ()</span><span>
</span><a name="line-624"></a><span class="hs-comment">--                !_ &lt;- trace (&quot;char 2: &quot; &lt;&gt; show char2) $ pure ()</span><span>
</span><a name="line-625"></a><span>                </span><span class="hs-identifier">char1ToSend</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">allocInitAlign_io</span><span> </span><span class="hs-identifier">maxAllocLen</span><span> </span><span class="hs-identifier">exportedChar1Len</span><span> </span><span class="hs-operator">.</span><span> </span><span class="hs-identifier">fmap</span><span> </span><span class="hs-identifier">coerceEnum</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-identifier">exportedCharacterElements</span><span> </span><span class="hs-identifier">exportedChar1</span><span>
</span><a name="line-626"></a><span>                </span><span class="hs-identifier">char2ToSend</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">allocInitAlign_io</span><span> </span><span class="hs-identifier">maxAllocLen</span><span> </span><span class="hs-identifier">exportedChar2Len</span><span> </span><span class="hs-operator">.</span><span> </span><span class="hs-identifier">fmap</span><span> </span><span class="hs-identifier">coerceEnum</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-identifier">exportedCharacterElements</span><span> </span><span class="hs-identifier">exportedChar2</span><span>
</span><a name="line-627"></a><span>                </span><a name="local-6989586621679227708"><a href="#local-6989586621679227708"><span class="hs-identifier">retGapped</span></a></a><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">allocInitAlign_io</span><span> </span><a href="Analysis.Parsimony.Dynamic.DirectOptimization.Pairwise.FFI.html#extractFromAlign_io"><span class="hs-identifier hs-var">maxAllocLen</span></a><span> </span><span class="hs-number">0</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-628"></a><span>                </span><a name="local-6989586621679227709"><a href="#local-6989586621679227709"><span class="hs-identifier">retUngapped</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">allocInitAlign_io</span><span> </span><a href="Analysis.Parsimony.Dynamic.DirectOptimization.Pairwise.FFI.html#extractFromAlign_io"><span class="hs-identifier hs-var">maxAllocLen</span></a><span> </span><span class="hs-number">0</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-629"></a><span>                </span><span class="hs-comment">-- retUnion    &lt;- allocInitALignIO 0 []</span><span>
</span><a name="line-630"></a><span>
</span><a name="line-631"></a><span class="hs-comment">{--
                Align_io char1Ptr char1Len buffer1Len &lt;- peek char1ToSend
                Align_io char2Ptr char2Len buffer2Len &lt;- peek char2ToSend
                input1CharArr &lt;- peekArray (fromEnum buffer1Len) char1Ptr
                input2CharArr &lt;- peekArray (fromEnum buffer2Len) char2Ptr
                !_ &lt;- trace (mconcat [&quot; Input LHS : { &quot;, show char1Len, &quot; / &quot;, show buffer1Len, &quot; } &quot;, renderBuffer input1CharArr]) $ pure ()
                !_ &lt;- trace (mconcat [&quot; Input RHS : { &quot;, show char2Len, &quot; / &quot;, show buffer2Len, &quot; } &quot;, renderBuffer input2CharArr]) $ pure ()
--}</span><span>
</span><a name="line-639"></a><span>
</span><a name="line-640"></a><span>                </span><span class="hs-identifier">strategy</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">getAlignmentStrategy</span><span> </span><span class="hs-operator">&lt;$&gt;</span><span> </span><span class="hs-identifier">peek</span><span> </span><span class="hs-identifier">costStruct</span><span>
</span><a name="line-641"></a><span>                </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier">cost</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">strategy</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-642"></a><span>                              </span><span class="hs-identifier">Affine</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">align2dAffineFn_c</span><span> </span><span class="hs-identifier">char1ToSend</span><span> </span><span class="hs-identifier">char2ToSend</span><span> </span><a href="#local-6989586621679227709"><span class="hs-identifier hs-var">retGapped</span></a><span> </span><span class="hs-identifier">retUngapped</span><span> </span><a href="#local-6989586621679227708"><span class="hs-identifier hs-var">costStruct</span></a><span>                        </span><span class="hs-special">(</span><span class="hs-identifier">coerceEnum</span><span> </span><span class="hs-identifier">computeMedians</span><span class="hs-special">)</span><span>
</span><a name="line-643"></a><span>                              </span><span class="hs-identifier">_</span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">align2dFn_c</span><span>       </span><span class="hs-identifier">char1ToSend</span><span> </span><span class="hs-identifier">char2ToSend</span><span> </span><span class="hs-identifier">retGapped</span><span> </span><span class="hs-identifier">retUngapped</span><span> </span><span class="hs-identifier">costStruct</span><span> </span><span class="hs-identifier">neverComputeOnlyGapped</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">coerceEnum</span><span> </span><span class="hs-identifier">computeMedians</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">coerceEnum</span><span> </span><span class="hs-identifier">computeUnion</span><span class="hs-special">)</span><span>
</span><a name="line-644"></a><span>
</span><a name="line-645"></a><span class="hs-comment">{-
                Align_io ungappedCharArr ungappedLen _ &lt;- peek retUngapped
                Align_io gappedCharArr   gappedLen   _ &lt;- peek retGapped
                Align_io retChar1CharArr char1Len    _ &lt;- peek char1ToSend
                Align_io retChar2CharArr char2Len    _ &lt;- peek char2ToSend
                -- Align_io unionCharArr    unionLen    _ &lt;- peek retUnion

                -- A sanity check to ensure that the sequences were aligned
                _ &lt;- if gappedLen == char1Len &amp;&amp; gappedLen == char2Len
                     then pure ()
                     else error $ unlines
                         [ &quot;Sequences returned from POY C code were not actually \&quot;aligned.\&quot;&quot;
                         , &quot;gappedLen = &quot; &lt;&gt; show gappedLen
                         , &quot; char1Len = &quot; &lt;&gt; show char1Len
                         , &quot; char2Len = &quot; &lt;&gt; show char2Len
                         ]
--                ungappedChar &lt;- peekArray (fromEnum ungappedLen) ungappedCharArr
                gappedChar   &lt;- reverse &lt;$&gt; peekArray (fromEnum gappedArrLen)   gappedCharArr
                char1Aligned &lt;- reverse &lt;$&gt; peekArray (fromEnum  char1ArrLen) retChar1CharArr
                char2Aligned &lt;- reverse &lt;$&gt; peekArray (fromEnum  char2ArrLen) retChar2CharArr
                -- unionChar    &lt;- peekArray (fromEnum unionLen)    unionCharArr

--                !_ &lt;- trace (&quot; Gapped Char : &quot; &lt;&gt; renderBuffer   gappedChar) $ pure ()
--                !_ &lt;- trace (&quot; Aligned LHS : &quot; &lt;&gt; renderBuffer char1Aligned) $ pure ()
--                !_ &lt;- trace (&quot; Aligned RHS : &quot; &lt;&gt; renderBuffer char2Aligned) $ pure ()
-}</span><span>
</span><a name="line-671"></a><span>
</span><a name="line-672"></a><span class="hs-comment">{-
                Align_io char1Ptr' char1Len' buffer1Len' &lt;- peek char1ToSend
                Align_io char2Ptr' char2Len' buffer2Len' &lt;- peek char2ToSend
                output1Buffer &lt;- peekArray (fromEnum buffer1Len') char1Ptr'
                output2Buffer &lt;- peekArray (fromEnum buffer2Len') char2Ptr'
                !_ &lt;- trace (mconcat [&quot; Output LHS : { &quot;, show char1Len', &quot; / &quot;, show buffer1Len', &quot; } &quot;, renderBuffer output1Buffer]) $ pure ()
                !_ &lt;- trace (mconcat [&quot; Output RHS : { &quot;, show char2Len', &quot; / &quot;, show buffer2Len', &quot; } &quot;, renderBuffer output2Buffer]) $ pure ()
-}</span><span>
</span><a name="line-680"></a><span>
</span><a name="line-681"></a><span>                </span><a href="Bio.Character.Encodable.Dynamic.Class.html#EncodableDynamicCharacter"><span class="hs-identifier hs-type">resultingAlignedChar1</span></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">extractFromAlign_io</span><span> </span><span class="hs-identifier">elemWidth</span><span> </span><span class="hs-identifier">char1ToSend</span><span>
</span><a name="line-682"></a><span>                </span><span class="hs-identifier">resultingAlignedChar2</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">extractFromAlign_io</span><span> </span><span class="hs-identifier">elemWidth</span><span> </span><span class="hs-identifier">char2ToSend</span><span>
</span><a name="line-683"></a><span>                </span><span class="hs-identifier">resultingGapped</span><span>       </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">extractFromAlign_io</span><span> </span><span class="hs-identifier">elemWidth</span><span> </span><span class="hs-identifier">retGapped</span><span>
</span><a name="line-684"></a><span>                </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier">resultingUngapped</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">filterGaps</span><span> </span><span class="hs-identifier">resultingGapped</span><span>
</span><a name="line-685"></a><span>
</span><a name="line-686"></a><span class="hs-comment">{--
                !_ &lt;- trace (&quot;Ungapped Char: &quot; &lt;&gt; show     resultingUngapped) $ pure ()
                !_ &lt;- trace (&quot;  Gapped Char: &quot; &lt;&gt; show       resultingGapped) $ pure ()
                !_ &lt;- trace (&quot; Aligned LHS : &quot; &lt;&gt; show resultingAlignedChar1) $ pure ()
                !_ &lt;- trace (&quot; Aligned RHS : &quot; &lt;&gt; show resultingAlignedChar2) $ pure ()
--}</span><span>
</span><a name="line-692"></a><span class="hs-comment">--                !_ &lt;- trace  &quot; &gt; Done with FFI Alignment\n&quot; $ pure ()</span><span>
</span><a name="line-693"></a><span>
</span><a name="line-694"></a><span>                </span><span class="hs-comment">-- NOTE: We swapped resultingAlignedChar1 &amp; resultingAlignedChar2</span><span>
</span><a name="line-695"></a><span>                </span><span class="hs-comment">-- because the C code returns the values in the wrong order!</span><span>
</span><a name="line-696"></a><span>                </span><span class="hs-identifier">pure</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">fromIntegral</span><span> </span><span class="hs-identifier">cost</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">resultingUngapped</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">resultingGapped</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">resultingAlignedChar2</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">resultingAlignedChar1</span><span class="hs-special">)</span><span>
</span><a name="line-697"></a><span>
</span><a name="line-698"></a><span>            </span><span class="hs-keyword">where</span><span>
</span><a name="line-699"></a><span>                </span><span class="hs-identifier">costStruct</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">costMatrix2D</span><span> </span><span class="hs-identifier">denseTCMs</span><span>
</span><a name="line-700"></a><span>                </span><span class="hs-identifier">neverComputeOnlyGapped</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-701"></a><span>
</span><a name="line-702"></a><span>                </span><span class="hs-identifier">elemWidth</span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">exportedChar1</span><span> </span><span class="hs-operator">^.</span><span> </span><span class="hs-identifier">exportedElementWidth</span><span>
</span><a name="line-703"></a><span>
</span><a name="line-704"></a><span>                </span><span class="hs-identifier">exportedChar1Len</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">coerceEnum</span><span> </span><a href="Bio.Character.Exportable.Class.html#toExportableElements"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-identifier">exportedChar1</span><span> </span><a href="#local-6989586621679227715"><span class="hs-operator hs-var">^.</span></a><span> </span><span class="hs-identifier">exportedElementCount</span><span>
</span><a name="line-705"></a><span>                </span><span class="hs-identifier">exportedChar2Len</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">coerceEnum</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-identifier">exportedChar2</span><span> </span><span class="hs-operator">^.</span><span> </span><span class="hs-identifier">exportedElementCount</span><span>
</span><a name="line-706"></a><span>                </span><span class="hs-comment">-- Add two because the C code needs stupid gap prepended to each character.</span><span>
</span><a name="line-707"></a><span>                </span><span class="hs-comment">-- Forgetting to do this will eventually corrupt the heap memory</span><span>
</span><a name="line-708"></a><span>                </span><span class="hs-identifier">maxAllocLen</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">exportedChar1Len</span><span> </span><span class="hs-operator">+</span><span> </span><span class="hs-identifier">exportedChar2Len</span><span> </span><span class="hs-operator">+</span><span> </span><span class="hs-number">2</span><span>
</span><a name="line-709"></a><span>
</span><a name="line-710"></a><span>                </span><span class="hs-comment">-- allocInitAlign_io :: CSize -&gt; [CUInt] -&gt; IO (Ptr Align_io)</span><span>
</span><a name="line-711"></a><span>                </span><span class="hs-comment">-- allocInitAlign_io elemCount elemArr  =</span><span>
</span><a name="line-712"></a><span>                </span><span class="hs-comment">--     do</span><span>
</span><a name="line-713"></a><span>                </span><span class="hs-comment">--         output   &lt;- malloc :: IO (Ptr Align_io)</span><span>
</span><a name="line-714"></a><span>                </span><span class="hs-comment">--         outArray &lt;- newArray paddedArr</span><span>
</span><a name="line-715"></a><span>                </span><span class="hs-comment">--         poke output $ Align_io outArray elemCount maxAllocLen</span><span>
</span><a name="line-716"></a><span>                </span><span class="hs-comment">--         pure output</span><span>
</span><a name="line-717"></a><span>                </span><span class="hs-comment">--     where</span><span>
</span><a name="line-718"></a><span>                </span><span class="hs-comment">--         paddedArr = replicate (max 0 (fromEnum (maxAllocLen - elemCount))) 0 &lt;&gt; elemArr</span><span>
</span><a name="line-719"></a><span>
</span><a name="line-720"></a><span>                </span><span class="hs-comment">-- Used for debugging</span><span>
</span><a name="line-721"></a><span class="hs-comment">{-
                renderBuffer buf = &quot;[&quot; &lt;&gt; intercalate &quot;,&quot; (fmap pad shownElems) &lt;&gt; &quot;]&quot;
                  where
                    maxElemChars = maximum $ fmap length shownElems
                    shownElems   = fmap show buf
                    pad e        = replicate (maxElemChars - length e) ' ' &lt;&gt; e
-}</span><span>
</span><a name="line-728"></a><span>
</span><a name="line-729"></a><span class="hs-comment">-- |</span><span>
</span><a name="line-730"></a><span class="hs-comment">-- Performs a naive direct optimization</span><span>
</span><a name="line-731"></a><span class="hs-comment">-- Takes in three characters to run DO on and a metadata object.</span><span>
</span><a name="line-732"></a><span class="hs-comment">-- Returns an assignment character, the cost of that assignment, the assignment character with gaps included,</span><span>
</span><a name="line-733"></a><span class="hs-comment">-- the aligned versions of the three input characters.</span><span>
</span><a name="line-734"></a><span class="hs-comment">-- The process for this algorithm is to generate a traversal matrix, then perform a traceback.</span><span>
</span><a name="line-735"></a><span class="hs-identifier">algn3d</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier">EncodableDynamicCharacter</span><span> </span><span class="hs-identifier">s</span><span>
</span><a name="line-736"></a><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">Exportable</span><span> </span><span class="hs-identifier">s</span><span>
</span><a name="line-737"></a><span>          </span><span class="hs-special">)</span><span>
</span><a name="line-738"></a><span>       </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier">s</span><span>                         </span><span class="hs-comment">-- ^ First  dynamic character</span><span>
</span><a name="line-739"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">s</span><span>                         </span><span class="hs-comment">-- ^ Second dynamic character</span><span>
</span><a name="line-740"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">s</span><span>                         </span><span class="hs-comment">-- ^ Third  dynamic character</span><span>
</span><a name="line-741"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Int</span><span>                       </span><span class="hs-comment">-- ^ Mismatch cost</span><span>
</span><a name="line-742"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Int</span><span>                       </span><span class="hs-comment">-- ^ Gap open cost</span><span>
</span><a name="line-743"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Int</span><span>                       </span><span class="hs-comment">-- ^ Indel cost</span><span>
</span><a name="line-744"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">DenseTransitionCostMatrix</span><span> </span><span class="hs-comment">-- ^ Structure defining the transition costs between character states</span><span>
</span><a name="line-745"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">Word</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">s</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">s</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">s</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">s</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">s</span><span class="hs-special">)</span><span>     </span><span class="hs-comment">-- ^ The cost of the alignment</span><span>
</span><a name="line-746"></a><span>                                    </span><span class="hs-comment">--</span><span>
</span><a name="line-747"></a><span>                                    </span><span class="hs-comment">--   The /ungapped/ character derived from the the input characters' N-W-esque matrix traceback</span><span>
</span><a name="line-748"></a><span>                                    </span><span class="hs-comment">--</span><span>
</span><a name="line-749"></a><span>                                    </span><span class="hs-comment">--   The /gapped/ character derived from the the input characters' N-W-esque matrix traceback</span><span>
</span><a name="line-750"></a><span>                                    </span><span class="hs-comment">--</span><span>
</span><a name="line-751"></a><span>                                    </span><span class="hs-comment">--   The gapped alignment of the /first/ input character when aligned with the second &amp; third character</span><span>
</span><a name="line-752"></a><span>                                    </span><span class="hs-comment">--</span><span>
</span><a name="line-753"></a><span>                                    </span><span class="hs-comment">--   The gapped alignment of the /second/ input character when aligned with the first &amp; third character</span><span>
</span><a name="line-754"></a><span>                                    </span><span class="hs-comment">--</span><span>
</span><a name="line-755"></a><span>                                    </span><span class="hs-comment">--   The gapped alignment of the /third/ input character when aligned with the first &amp; second character</span><span>
</span><a name="line-756"></a><span>                                    </span><span class="hs-comment">--</span><span>
</span><a name="line-757"></a><span class="hs-identifier">algn3d</span><span> </span><span class="hs-identifier">char1</span><span> </span><span class="hs-identifier">char2</span><span> </span><span class="hs-identifier">char3</span><span> </span><span class="hs-identifier">mismatchCost</span><span> </span><span class="hs-identifier">openningGapCost</span><span> </span><span class="hs-identifier">indelCost</span><span> </span><span class="hs-identifier">denseTCMs</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">handleMissingCharacterThreeway</span><span> </span><span class="hs-identifier">someFun</span><span> </span><span class="hs-identifier">char1</span><span> </span><span class="hs-identifier">char2</span><span> </span><span class="hs-identifier">char3</span><span> </span><span class="hs-operator">$</span><span>
</span><a name="line-758"></a><span>    </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">toExportableElements</span><span> </span><span class="hs-identifier">char1</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">toExportableElements</span><span> </span><span class="hs-identifier">char2</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">toExportableElements</span><span> </span><span class="hs-identifier">char3</span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-759"></a><span>      </span><span class="hs-special">(</span><span class="hs-identifier">Just</span><span> </span><span class="hs-identifier">x</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">Just</span><span> </span><span class="hs-identifier">y</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">Just</span><span> </span><span class="hs-identifier">z</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">f</span><span> </span><span class="hs-identifier">x</span><span> </span><span class="hs-identifier">y</span><span> </span><span class="hs-identifier hs-type">z</span><span>
</span><a name="line-760"></a><span>      </span><span class="hs-special">(</span><span>     </span><a name="allocInitAlign_io"><a href="Analysis.Parsimony.Dynamic.DirectOptimization.Pairwise.FFI.html#allocInitAlign_io"><span class="hs-identifier">_</span></a></a><span class="hs-special">,</span><span>      </span><a name="local-6989586621679227749"><a href="#local-6989586621679227749"><span class="hs-identifier">_</span></a></a><span class="hs-special">,</span><span>      </span><a name="local-6989586621679227749"><a href="#local-6989586621679227749"><span class="hs-identifier">_</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a name="local-6989586621679227750"><a href="#local-6989586621679227750"><span class="hs-identifier">error</span></a></a><span> </span><span class="hs-string">&quot;3DO: There's a dynamic character missing!&quot;</span><span>
</span><a name="line-761"></a><span>    </span><span class="hs-keyword">where</span><span>
</span><a name="line-762"></a><span>        </span><span class="hs-identifier">someFun</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">undefined</span><span>
</span><a name="line-763"></a><span>        </span><a name="local-6989586621679227754"><a href="#local-6989586621679227754"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-identifier">exportedChar1</span><span> </span><span class="hs-identifier">exportedChar2</span><span> </span><span class="hs-identifier">exportedChar3</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">unsafePerformIO</span><span> </span><span class="hs-operator">$</span><span>
</span><a name="line-764"></a><span>            </span><span class="hs-keyword">do</span><span>
</span><a name="line-765"></a><span class="hs-comment">--                !_ &lt;- trace (&quot;char 1: &quot; &lt;&gt; show char1) $ pure ()</span><span>
</span><a name="line-766"></a><span class="hs-comment">--                !_ &lt;- trace (&quot;char 2: &quot; &lt;&gt; show char2) $ pure ()</span><span>
</span><a name="line-767"></a><span>                </span><span class="hs-identifier">char1ToSend</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">allocInitAlign_io</span><span> </span><span class="hs-identifier">maxAllocLen</span><span> </span><span class="hs-identifier">exportedChar1Len</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="#local-6989586621679227751"><span class="hs-identifier hs-var">fmap</span></a><span> </span><span class="hs-identifier">coerceEnum</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-identifier">exportedCharacterElements</span><span> </span><span class="hs-identifier">exportedChar1</span><span>
</span><a name="line-768"></a><span>                </span><span class="hs-identifier">char2ToSend</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">allocInitAlign_io</span><span> </span><span class="hs-identifier">maxAllocLen</span><span> </span><span class="hs-identifier">exportedChar2Len</span><span> </span><span class="hs-operator">.</span><span> </span><span class="hs-identifier">fmap</span><span> </span><span class="hs-identifier">coerceEnum</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-identifier">exportedCharacterElements</span><span> </span><span class="hs-identifier">exportedChar2</span><span>
</span><a name="line-769"></a><span>                </span><span class="hs-identifier">char3ToSend</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">allocInitAlign_io</span><span> </span><span class="hs-identifier">maxAllocLen</span><span> </span><span class="hs-identifier">exportedChar3Len</span><span> </span><span class="hs-operator">.</span><span> </span><span class="hs-identifier">fmap</span><span> </span><span class="hs-identifier">coerceEnum</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-identifier">exportedCharacterElements</span><span> </span><span class="hs-identifier">exportedChar3</span><span>
</span><a name="line-770"></a><span>                </span><span class="hs-identifier">char1Return</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">allocInitAlign_io</span><span> </span><span class="hs-identifier">maxAllocLen</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>    </span><span class="hs-comment">-- Note that the next six can be empty as their C-side</span><span>
</span><a name="line-771"></a><span>                </span><span class="hs-identifier">char2Return</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">allocInitAlign_io</span><span> </span><span class="hs-identifier">maxAllocLen</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>    </span><span class="hs-comment">-- internal arrays are alloc'ed</span><span>
</span><a name="line-772"></a><span>                </span><span class="hs-identifier">char3Return</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">allocInitAlign_io</span><span> </span><span class="hs-identifier">maxAllocLen</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-773"></a><span>                </span><span class="hs-identifier">retGapped</span><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">allocInitAlign_io</span><span> </span><span class="hs-identifier">maxAllocLen</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-774"></a><span>                </span><span class="hs-identifier">retUngapped</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">allocInitAlign_io</span><span> </span><span class="hs-identifier">maxAllocLen</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-775"></a><span>                </span><span class="hs-comment">-- retUnion    &lt;- allocInitALignIO 0 []</span><span>
</span><a name="line-776"></a><span>
</span><a name="line-777"></a><span>                </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier">cost</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">align3dFn_c</span><span> </span><span class="hs-identifier">char1ToSend</span><span> </span><span class="hs-identifier">char2ToSend</span><span> </span><span class="hs-identifier">char3ToSend</span><span>
</span><a name="line-778"></a><span>                                        </span><span class="hs-identifier">char1Return</span><span> </span><span class="hs-identifier">char2Return</span><span> </span><span class="hs-identifier">char3Return</span><span>
</span><a name="line-779"></a><span>                                        </span><span class="hs-identifier">retGapped</span><span>   </span><span class="hs-identifier">retUngapped</span><span>
</span><a name="line-780"></a><span>                                        </span><span class="hs-identifier">costStruct</span><span>
</span><a name="line-781"></a><span>                                        </span><span class="hs-special">(</span><span class="hs-identifier">coerceEnum</span><span> </span><span class="hs-identifier">mismatchCost</span><span class="hs-special">)</span><span>
</span><a name="line-782"></a><span>                                        </span><span class="hs-special">(</span><span class="hs-identifier">coerceEnum</span><span> </span><span class="hs-identifier">openningGapCost</span><span class="hs-special">)</span><span>
</span><a name="line-783"></a><span>                                        </span><span class="hs-special">(</span><span class="hs-identifier">coerceEnum</span><span> </span><span class="hs-identifier">indelCost</span><span class="hs-special">)</span><span>
</span><a name="line-784"></a><span>
</span><a name="line-785"></a><span>                </span><span class="hs-identifier">resultingAlignedChar1</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">extractFromAlign_io</span><span> </span><span class="hs-identifier">elemWidth</span><span> </span><span class="hs-identifier">char1Return</span><span>
</span><a name="line-786"></a><span>                </span><span class="hs-identifier">resultingAlignedChar2</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">extractFromAlign_io</span><span> </span><span class="hs-identifier">elemWidth</span><span> </span><span class="hs-identifier">char2Return</span><span>
</span><a name="line-787"></a><span>                </span><span class="hs-identifier">resultingAlignedChar3</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">extractFromAlign_io</span><span> </span><span class="hs-identifier">elemWidth</span><span> </span><span class="hs-identifier">char3Return</span><span>
</span><a name="line-788"></a><span>                </span><span class="hs-identifier">resultingGapped</span><span>       </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">extractFromAlign_io</span><span> </span><span class="hs-identifier">elemWidth</span><span> </span><span class="hs-identifier">retGapped</span><span>
</span><a name="line-789"></a><span>                </span><span class="hs-identifier">resultingUngapped</span><span>     </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">extractFromAlign_io</span><span> </span><span class="hs-identifier">elemWidth</span><span> </span><span class="hs-identifier">retUngapped</span><span>
</span><a name="line-790"></a><span>
</span><a name="line-791"></a><span>                </span><span class="hs-identifier">pure</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier">fromIntegral</span><span> </span><span class="hs-identifier">cost</span><span>
</span><a name="line-792"></a><span>                     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">resultingUngapped</span><span>
</span><a name="line-793"></a><span>                     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">resultingGapped</span><span>
</span><a name="line-794"></a><span>                     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">resultingAlignedChar1</span><span>
</span><a name="line-795"></a><span>                     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">resultingAlignedChar2</span><span>
</span><a name="line-796"></a><span>                     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">resultingAlignedChar3</span><span>
</span><a name="line-797"></a><span>                     </span><span class="hs-special">)</span><span>
</span><a name="line-798"></a><span>
</span><a name="line-799"></a><span>            </span><span class="hs-keyword">where</span><span>
</span><a name="line-800"></a><span>                </span><span class="hs-identifier">costStruct</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">costMatrix3D</span><span> </span><span class="hs-identifier">denseTCMs</span><span> </span><span class="hs-comment">-- TODO: get memoized matrix wedged in here</span><span>
</span><a name="line-801"></a><span>
</span><a name="line-802"></a><span>                </span><span class="hs-identifier">elemWidth</span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">exportedChar1</span><span> </span><span class="hs-operator">^.</span><span> </span><span class="hs-identifier">exportedElementWidth</span><span>
</span><a name="line-803"></a><span>
</span><a name="line-804"></a><span>                </span><span class="hs-identifier">exportedChar1Len</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">coerceEnum</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-identifier">exportedChar1</span><span> </span><span class="hs-operator">^.</span><span> </span><span class="hs-identifier">exportedElementCount</span><span>
</span><a name="line-805"></a><span>                </span><span class="hs-identifier">exportedChar2Len</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">coerceEnum</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-identifier">exportedChar2</span><span> </span><span class="hs-operator">^.</span><span> </span><span class="hs-identifier">exportedElementCount</span><span>
</span><a name="line-806"></a><span>                </span><span class="hs-identifier">exportedChar3Len</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">coerceEnum</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-identifier">exportedChar3</span><span> </span><span class="hs-operator">^.</span><span> </span><span class="hs-identifier">exportedElementCount</span><span>
</span><a name="line-807"></a><span>
</span><a name="line-808"></a><span>                </span><span class="hs-identifier">maxAllocLen</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">exportedChar1Len</span><span> </span><span class="hs-operator">+</span><span> </span><span class="hs-identifier">exportedChar2Len</span><span> </span><span class="hs-operator">+</span><span> </span><span class="hs-identifier">exportedChar3Len</span><span>
</span><a name="line-809"></a><span>
</span><a name="line-810"></a><span>
</span><a name="line-811"></a><span class="hs-comment">-- |</span><span>
</span><a name="line-812"></a><span class="hs-comment">-- Allocates space for an align_io struct to be sent to C.</span><span>
</span><a name="line-813"></a><span class="hs-identifier">allocInitAlign_io</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">CSize</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">CSize</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier">CUInt</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">Ptr</span><span> </span><span class="hs-identifier">Align_io</span><span class="hs-special">)</span><span>
</span><a name="line-814"></a><span class="hs-identifier">allocInitAlign_io</span><span> </span><span class="hs-identifier">maxAllocLen</span><span> </span><span class="hs-identifier">elemCount</span><span> </span><span class="hs-identifier">elemArr</span><span>  </span><span class="hs-glyph">=</span><span>
</span><a name="line-815"></a><span>    </span><span class="hs-keyword">do</span><span>
</span><a name="line-816"></a><span>        </span><span class="hs-identifier">output</span><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">malloc</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">Ptr</span><span> </span><span class="hs-identifier">Align_io</span><span class="hs-special">)</span><span>
</span><a name="line-817"></a><span>        </span><span class="hs-identifier">outArray</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">newArray</span><span> </span><span class="hs-identifier">paddedArr</span><span>
</span><a name="line-818"></a><span>        </span><span class="hs-identifier">poke</span><span> </span><span class="hs-identifier">output</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-identifier">Align_io</span><span> </span><span class="hs-identifier">outArray</span><span> </span><span class="hs-identifier">elemCount</span><span> </span><span class="hs-identifier">maxAllocLen</span><span>
</span><a name="line-819"></a><span>        </span><span class="hs-identifier">pure</span><span> </span><span class="hs-identifier">output</span><span>
</span><a name="line-820"></a><span>    </span><span class="hs-keyword">where</span><span>
</span><a name="line-821"></a><span>        </span><span class="hs-identifier">paddedArr</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">replicate</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">max</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">fromEnum</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">maxAllocLen</span><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-identifier">elemCount</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-operator">&lt;&gt;</span><span> </span><span class="hs-identifier">elemArr</span><span>
</span><a name="line-822"></a><span>
</span><a name="line-823"></a><span class="hs-comment">{-
-- | A C binding that computes only the cost of a 2d alignment
align2dCostOnly
  :: ( EncodableDynamicCharacter s
     , Exportable s
     , Show s
     )
  =&gt; s
  -&gt; s
  -&gt; DenseTransitionCostMatrix
  -&gt; (Word, s, s, s, s)
align2dCostOnly c1 c2 cm = algn2d c1 c2 cm DoNotComputeUnions DoNotComputeMedians


-- | A C binding that aligns two DO characters and returns the cost and the ungapped median sequence
align2dGetUngapped
  :: ( EncodableDynamicCharacter s
     , Exportable s
     , Show s
     )
  =&gt; s
  -&gt; s
  -&gt; DenseTransitionCostMatrix
  -&gt; (Word, s, s, s, s)
align2dGetUngapped c1 c2 cm = algn2d c1 c2 cm DoNotComputeUnions ComputeMedians


-- | A C binding that aligns two DO characters and returns the cost and the union median
align2dGetUnion
  :: ( EncodableDynamicCharacter s
     , Exportable s
     , Show s
     )
  =&gt; s
  -&gt; s
  -&gt; DenseTransitionCostMatrix
  -&gt; (Word, s, s, s, s)
align2dGetUnion c1 c2 cm = algn2d c1 c2 cm ComputeUnions DoNotComputeMedians


-- | A C binding that aligns two DO characters and returns the cost and the gapped and ungapped median sequences
align2dGappedUngapped
  :: ( EncodableDynamicCharacter s
     , Exportable s
     , Show s
     )
  =&gt; s
  -&gt; s
  -&gt; DenseTransitionCostMatrix
  -&gt; (Word, s, s, s, s)
align2dGappedUngapped c1 c2 cm = algn2d c1 c2 cm ComputeUnions ComputeMedians
-}</span><span>
</span><a name="line-875"></a><span>
</span><a name="line-876"></a><span>
</span><a name="line-877"></a><span class="hs-comment">{- Generic helper functions -}</span><span>
</span><a name="line-878"></a><span>
</span><a name="line-879"></a><span>
</span><a name="line-880"></a><span class="hs-comment">-- |</span><span>
</span><a name="line-881"></a><span class="hs-comment">-- Coercing one 'Enum' to another through their corresponding 'Int' values.</span><span>
</span><a name="line-882"></a><span class="hs-identifier">coerceEnum</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">Enum</span><span> </span><span class="hs-identifier">a</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">Enum</span><span> </span><span class="hs-identifier">b</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier">a</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">b</span><span>
</span><a name="line-883"></a><span class="hs-identifier">coerceEnum</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">toEnum</span><span> </span><span class="hs-operator">.</span><span> </span><span class="hs-identifier">fromEnum</span><span>
</span><a name="line-884"></a><span>
</span><a name="line-885"></a><span>
</span><a name="line-886"></a><span class="hs-comment">-- |</span><span>
</span><a name="line-887"></a><span class="hs-comment">-- Converts the data behind an 'Align_io' pointer to an 'Exportable' type.</span><span>
</span><a name="line-888"></a><span class="hs-identifier">extractFromAlign_io</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">Exportable</span><span> </span><span class="hs-identifier">s</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier">Word</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Ptr</span><span> </span><span class="hs-identifier">Align_io</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">IO</span><span> </span><span class="hs-identifier">s</span><span>
</span><a name="line-889"></a><span class="hs-identifier">extractFromAlign_io</span><span> </span><span class="hs-identifier">elemWidth</span><span> </span><span class="hs-identifier">ptr</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-890"></a><span>    </span><span class="hs-identifier">Align_io</span><span> </span><span class="hs-identifier">bufferPtr</span><span> </span><span class="hs-identifier">charLenC</span><span> </span><span class="hs-identifier">bufferLenC</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">peek</span><span> </span><span class="hs-identifier">ptr</span><span>
</span><a name="line-891"></a><span>    </span><span class="hs-keyword">let</span><span>    </span><span class="hs-identifier">charLength</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">fromEnum</span><span>   </span><span class="hs-identifier">charLenC</span><span>
</span><a name="line-892"></a><span>    </span><span class="hs-keyword">let</span><span>  </span><span class="hs-identifier">bufferLength</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">fromEnum</span><span> </span><span class="hs-identifier">bufferLenC</span><span>
</span><a name="line-893"></a><span>    </span><span class="hs-identifier">buffer</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">peekArray</span><span> </span><span class="hs-identifier">bufferLength</span><span> </span><span class="hs-identifier">bufferPtr</span><span>
</span><a name="line-894"></a><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier">charElems</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">drop</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">bufferLength</span><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-identifier">charLength</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">buffer</span><span>
</span><a name="line-895"></a><span>    </span><span class="hs-keyword">let</span><span>  </span><span class="hs-identifier">exportVal</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ExportableCharacterElements</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">toEnum</span><span> </span><span class="hs-identifier">charLength</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">elemWidth</span><span> </span><span class="hs-identifier">charElems</span><span>
</span><a name="line-896"></a><span>    </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">free</span><span> </span><span class="hs-identifier">bufferPtr</span><span>
</span><a name="line-897"></a><span>    </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">free</span><span> </span><span class="hs-identifier">ptr</span><span>
</span><a name="line-898"></a><span>    </span><span class="hs-identifier">pure</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-identifier">fromExportableElements</span><span> </span><span class="hs-identifier">exportVal</span><span>
</span><a name="line-899"></a><span>
</span><a name="line-900"></a><span>
</span><a name="line-901"></a><span class="hs-comment">-- |</span><span>
</span><a name="line-902"></a><span class="hs-comment">-- Determine the alignment strategy encoded for the matrix.</span><span>
</span><a name="line-903"></a><span class="hs-identifier">getAlignmentStrategy</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">CostMatrix2d</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">AlignmentStrategy</span><span>
</span><a name="line-904"></a><span class="hs-identifier">getAlignmentStrategy</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">toEnum</span><span> </span><span class="hs-operator">.</span><span> </span><span class="hs-identifier">fromEnum</span><span> </span><span class="hs-operator">.</span><span> </span><span class="hs-identifier">costModelType</span><span>
</span><a name="line-905"></a></pre></body></html>