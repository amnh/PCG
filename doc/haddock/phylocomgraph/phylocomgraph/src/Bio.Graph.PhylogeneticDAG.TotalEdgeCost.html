<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><a name="line-2"></a><span class="hs-comment">-- |</span><span>
</span><a name="line-3"></a><span class="hs-comment">-- Module      :  Bio.Graph.PhylogeneticDAG.TotalEdgeCost</span><span>
</span><a name="line-4"></a><span class="hs-comment">-- Copyright   :  (c) 2015-2015 Ward Wheeler</span><span>
</span><a name="line-5"></a><span class="hs-comment">-- License     :  BSD-style</span><span>
</span><a name="line-6"></a><span class="hs-comment">--</span><span>
</span><a name="line-7"></a><span class="hs-comment">-- Maintainer  :  wheeler@amnh.org</span><span>
</span><a name="line-8"></a><span class="hs-comment">-- Stability   :  provisional</span><span>
</span><a name="line-9"></a><span class="hs-comment">-- Portability :  portable</span><span>
</span><a name="line-10"></a><span class="hs-comment">--</span><span>
</span><a name="line-11"></a><span class="hs-comment">-- Containing the master command for unifying all input types: tree, metadata, and sequence</span><span>
</span><a name="line-12"></a><span class="hs-comment">--</span><span>
</span><a name="line-13"></a><span class="hs-comment">-----------------------------------------------------------------------------</span><span>
</span><a name="line-14"></a><span>
</span><a name="line-15"></a><span class="hs-pragma">{-# LANGUAGE BangPatterns, FlexibleContexts, MonoLocalBinds #-}</span><span>
</span><a name="line-16"></a><span>
</span><a name="line-17"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Bio</span><span class="hs-operator">.</span><span class="hs-identifier">Graph</span><span class="hs-operator">.</span><span class="hs-identifier">PhylogeneticDAG</span><span class="hs-operator">.</span><span class="hs-identifier">TotalEdgeCost</span><span>
</span><a name="line-18"></a><span>  </span><span class="hs-special">(</span><span> </span><a href="Bio.Graph.PhylogeneticDAG.TotalEdgeCost.html#totalEdgeCosts"><span class="hs-identifier hs-var">totalEdgeCosts</span></a><span>
</span><a name="line-19"></a><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-20"></a><span>
</span><a name="line-21"></a><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span>           </span><a href="Analysis.Parsimony.Dynamic.DirectOptimization.html"><span class="hs-identifier">Analysis</span><span class="hs-operator">.</span><span class="hs-identifier">Parsimony</span><span class="hs-operator">.</span><span class="hs-identifier">Dynamic</span><span class="hs-operator">.</span><span class="hs-identifier">DirectOptimization</span></a><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span>           </span><a href="Bio.Character.Decoration.Additive.html"><span class="hs-identifier">Bio</span><span class="hs-operator">.</span><span class="hs-identifier">Character</span><span class="hs-operator">.</span><span class="hs-identifier">Decoration</span><span class="hs-operator">.</span><span class="hs-identifier">Additive</span></a><span>
</span><a name="line-24"></a><span class="hs-keyword">import</span><span>           </span><a href="Bio.Character.Decoration.Dynamic.html"><span class="hs-identifier">Bio</span><span class="hs-operator">.</span><span class="hs-identifier">Character</span><span class="hs-operator">.</span><span class="hs-identifier">Decoration</span><span class="hs-operator">.</span><span class="hs-identifier">Dynamic</span></a><span>
</span><a name="line-25"></a><span class="hs-keyword">import</span><span>           </span><a href="Bio.Character.Encodable.html"><span class="hs-identifier">Bio</span><span class="hs-operator">.</span><span class="hs-identifier">Character</span><span class="hs-operator">.</span><span class="hs-identifier">Encodable</span></a><span>
</span><a name="line-26"></a><span class="hs-keyword">import</span><span>           </span><a href="Bio.Character.Exportable.html"><span class="hs-identifier">Bio</span><span class="hs-operator">.</span><span class="hs-identifier">Character</span><span class="hs-operator">.</span><span class="hs-identifier">Exportable</span></a><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span>           </span><a href="Bio.Sequence.html"><span class="hs-identifier">Bio</span><span class="hs-operator">.</span><span class="hs-identifier">Sequence</span></a><span>
</span><a name="line-28"></a><span class="hs-keyword">import</span><span>           </span><a href="Bio.Graph.Node.html"><span class="hs-identifier">Bio</span><span class="hs-operator">.</span><span class="hs-identifier">Graph</span><span class="hs-operator">.</span><span class="hs-identifier">Node</span></a><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span>           </span><a href="Bio.Graph.PhylogeneticDAG.Internal.html"><span class="hs-identifier">Bio</span><span class="hs-operator">.</span><span class="hs-identifier">Graph</span><span class="hs-operator">.</span><span class="hs-identifier">PhylogeneticDAG</span><span class="hs-operator">.</span><span class="hs-identifier">Internal</span></a><span>
</span><a name="line-30"></a><span class="hs-keyword">import</span><span>           </span><a href="Bio.Graph.ReferenceDAG.Internal.html"><span class="hs-identifier">Bio</span><span class="hs-operator">.</span><span class="hs-identifier">Graph</span><span class="hs-operator">.</span><span class="hs-identifier">ReferenceDAG</span><span class="hs-operator">.</span><span class="hs-identifier">Internal</span></a><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Applicative</span><span>
</span><a name="line-32"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">DeepSeq</span><span>
</span><a name="line-33"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Lens</span><span>
</span><a name="line-34"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span><span class="hs-operator">.</span><span class="hs-identifier">State</span><span class="hs-operator">.</span><span class="hs-identifier">Lazy</span><span>
</span><a name="line-35"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Foldable</span><span>
</span><a name="line-36"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">IntMap</span><span>        </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">IM</span><span>
</span><a name="line-37"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">IntSet</span><span>        </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">IS</span><span>
</span><a name="line-38"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Key</span><span>
</span><a name="line-39"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">List</span><span class="hs-operator">.</span><span class="hs-identifier">NonEmpty</span><span>        </span><span class="hs-special">(</span><span class="hs-identifier hs-type">NonEmpty</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-40"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">List</span><span class="hs-operator">.</span><span class="hs-identifier">NonEmpty</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">NE</span><span>
</span><a name="line-41"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">MonoTraversable</span><span>
</span><a name="line-42"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Semigroup</span><span>
</span><a name="line-43"></a><span class="hs-keyword">import</span><span>           </span><a href="Data.TCM.Memoized.html"><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">TCM</span><span class="hs-operator">.</span><span class="hs-identifier">Memoized</span></a><span>
</span><a name="line-44"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Prelude</span><span>            </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">zipWith</span><span class="hs-special">)</span><span>
</span><a name="line-45"></a><span>
</span><a name="line-46"></a><span class="hs-comment">--import Debug.Trace</span><span>
</span><a name="line-47"></a><span>
</span><a name="line-48"></a><span>
</span><a name="line-49"></a><span class="hs-comment">-- |</span><span>
</span><a name="line-50"></a><span class="hs-comment">-- Computes the total edge cost over all the disambiguated final assignments.</span><span>
</span><a name="line-51"></a><span class="hs-identifier">totalEdgeCosts</span><span>
</span><a name="line-52"></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span> </span><a href="Bio.Character.Encodable.Dynamic.Class.html#EncodableDynamicCharacter"><span class="hs-identifier hs-type">EncodableDynamicCharacter</span></a><span> </span><a href="#local-6989586621679289364"><span class="hs-identifier hs-type">c</span></a><span>
</span><a name="line-53"></a><span>     </span><span class="hs-special">,</span><span> </span><a href="Bio.Character.Exportable.Class.html#Exportable"><span class="hs-identifier hs-type">Exportable</span></a><span> </span><a href="#local-6989586621679289364"><span class="hs-identifier hs-type">c</span></a><span>
</span><a name="line-54"></a><span>     </span><span class="hs-special">,</span><span> </span><a href="Bio.Character.Exportable.Class.html#Exportable"><span class="hs-identifier hs-type">Exportable</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Element</span><span> </span><a href="#local-6989586621679289364"><span class="hs-identifier hs-type">c</span></a><span class="hs-special">)</span><span>
</span><a name="line-55"></a><span>     </span><span class="hs-special">,</span><span> </span><a href="Bio.Metadata.General.Class.html#HasCharacterWeight"><span class="hs-identifier hs-type">HasCharacterWeight</span></a><span>            </span><a href="#local-6989586621679289365"><span class="hs-identifier hs-type">z</span></a><span> </span><a href="#local-6989586621679289366"><span class="hs-identifier hs-type">r</span></a><span>
</span><a name="line-56"></a><span>     </span><span class="hs-special">,</span><span> </span><a href="Bio.Metadata.Dynamic.Class.html#HasDenseTransitionCostMatrix"><span class="hs-identifier hs-type">HasDenseTransitionCostMatrix</span></a><span>  </span><a href="#local-6989586621679289365"><span class="hs-identifier hs-type">z</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="Analysis.Parsimony.Dynamic.DirectOptimization.Pairwise.FFI.html#DenseTransitionCostMatrix"><span class="hs-identifier hs-type">DenseTransitionCostMatrix</span></a><span class="hs-special">)</span><span>
</span><a name="line-57"></a><span>     </span><span class="hs-special">,</span><span> </span><a href="Bio.Character.Decoration.Dynamic.Class.html#HasSingleDisambiguation"><span class="hs-identifier hs-type">HasSingleDisambiguation</span></a><span>       </span><a href="#local-6989586621679289365"><span class="hs-identifier hs-type">z</span></a><span> </span><a href="#local-6989586621679289364"><span class="hs-identifier hs-type">c</span></a><span>
</span><a name="line-58"></a><span>     </span><span class="hs-special">,</span><span> </span><a href="Bio.Metadata.DiscreteWithTCM.Class.html#HasSparseTransitionCostMatrix"><span class="hs-identifier hs-type">HasSparseTransitionCostMatrix</span></a><span> </span><a href="#local-6989586621679289365"><span class="hs-identifier hs-type">z</span></a><span> </span><a href="Data.TCM.Memoized.FFI.html#MemoizedCostMatrix"><span class="hs-identifier hs-type">MemoizedCostMatrix</span></a><span>
</span><a name="line-59"></a><span class="hs-comment">--     , Integral i</span><span>
</span><a name="line-60"></a><span class="hs-comment">--     , Show i</span><span>
</span><a name="line-61"></a><span class="hs-comment">--     , NFData i</span><span>
</span><a name="line-62"></a><span>     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">NFData</span><span> </span><a href="#local-6989586621679289366"><span class="hs-identifier hs-type">r</span></a><span>
</span><a name="line-63"></a><span>     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Num</span><span> </span><a href="#local-6989586621679289366"><span class="hs-identifier hs-type">r</span></a><span>
</span><a name="line-64"></a><span>     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Ord</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Element</span><span> </span><a href="#local-6989586621679289364"><span class="hs-identifier hs-type">c</span></a><span class="hs-special">)</span><span>
</span><a name="line-65"></a><span>     </span><span class="hs-special">)</span><span>
</span><a name="line-66"></a><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Bio.Graph.PhylogeneticDAG.Internal.html#PhylogeneticDAG2"><span class="hs-identifier hs-type">PhylogeneticDAG2</span></a><span> </span><a href="#local-6989586621679289367"><span class="hs-identifier hs-type">e</span></a><span> </span><a href="#local-6989586621679289368"><span class="hs-identifier hs-type">n</span></a><span> </span><a href="#local-6989586621679289369"><span class="hs-identifier hs-type">u</span></a><span> </span><a href="#local-6989586621679289370"><span class="hs-identifier hs-type">v</span></a><span> </span><a href="#local-6989586621679289371"><span class="hs-identifier hs-type">w</span></a><span> </span><a href="#local-6989586621679289372"><span class="hs-identifier hs-type">x</span></a><span> </span><a href="#local-6989586621679289373"><span class="hs-identifier hs-type">y</span></a><span> </span><a href="#local-6989586621679289365"><span class="hs-identifier hs-type">z</span></a><span>
</span><a name="line-67"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">NonEmpty</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679289366"><span class="hs-identifier hs-type">r</span></a><span class="hs-special">]</span><span>
</span><a name="line-68"></a><span class="hs-comment">--totalEdgeCosts _ (PDAG2 dag) | trace (&quot;Before Total Edge Cost: &quot; &lt;&gt; referenceRendering dag) False = undefined</span><span>
</span><a name="line-69"></a><a name="totalEdgeCosts"><a href="Bio.Graph.PhylogeneticDAG.TotalEdgeCost.html#totalEdgeCosts"><span class="hs-identifier">totalEdgeCosts</span></a></a><span> </span><span class="hs-special">(</span><a href="Bio.Graph.PhylogeneticDAG.Internal.html#PDAG2"><span class="hs-identifier hs-var">PDAG2</span></a><span> </span><a name="local-6989586621679289374"><a href="#local-6989586621679289374"><span class="hs-identifier">dag</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679289383"><span class="hs-identifier hs-var">applyWeights</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">foldlWithKey</span><span> </span><a href="#local-6989586621679289384"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621679289377"><span class="hs-identifier hs-var">initAcc</span></a><span> </span><a href="#local-6989586621679289375"><span class="hs-identifier hs-var">refVec</span></a><span>
</span><a name="line-70"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-71"></a><span>    </span><a name="local-6989586621679289375"><a href="#local-6989586621679289375"><span class="hs-identifier">refVec</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">references</span><span> </span><a href="#local-6989586621679289374"><span class="hs-identifier hs-var">dag</span></a><span>
</span><a name="line-72"></a><span>
</span><a name="line-73"></a><span>    </span><a name="local-6989586621679289376"><a href="#local-6989586621679289376"><span class="hs-identifier">roots</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">rootRefs</span><span> </span><a href="#local-6989586621679289374"><span class="hs-identifier hs-var">dag</span></a><span>
</span><a name="line-74"></a><span>
</span><a name="line-75"></a><span class="hs-comment">--    pariwiseFunction' lhs rhs tcm = (\(!x,_,_,_,_) -&gt; {- trace (&quot;Cost &quot; &lt;&gt; show x) -} x) $ pariwiseFunction lhs rhs tcm</span><span>
</span><a name="line-76"></a><span>
</span><a name="line-77"></a><span>    </span><a name="local-6989586621679289377"><a href="#local-6989586621679289377"><span class="hs-identifier">initAcc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-number">0</span><span> </span><span class="hs-operator hs-var">&lt;$</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">toList</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">dynamicCharacters</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-6989586621679289378"><span class="hs-identifier hs-var">sequencesWLOG</span></a><span>
</span><a name="line-78"></a><span>
</span><a name="line-79"></a><span>    </span><a name="local-6989586621679289378"><a href="#local-6989586621679289378"><span class="hs-identifier">sequencesWLOG</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679289379"><span class="hs-identifier hs-var">getSequence</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">NE</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">head</span><span> </span><a href="#local-6989586621679289376"><span class="hs-identifier hs-var">roots</span></a><span>
</span><a name="line-80"></a><span>
</span><a name="line-81"></a><span>    </span><a name="local-6989586621679289379"><a href="#local-6989586621679289379"><span class="hs-identifier">getSequence</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">NE</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">fromList</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">otoList</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">characterSequence</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">NE</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">head</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">resolutions</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">nodeDecoration</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679289375"><span class="hs-identifier hs-var">refVec</span></a><span> </span><span class="hs-glyph">!</span><span class="hs-special">)</span><span>
</span><a name="line-82"></a><span>
</span><a name="line-83"></a><span>    </span><a name="local-6989586621679289380"><a href="#local-6989586621679289380"><span class="hs-identifier">getFields</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">^.</span><span> </span><a href="Bio.Character.Decoration.Dynamic.Class.html#singleDisambiguation"><span class="hs-identifier hs-var">singleDisambiguation</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">toList</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">dynamicCharacters</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="#local-6989586621679289379"><span class="hs-identifier hs-var">getSequence</span></a><span>
</span><a name="line-84"></a><span>
</span><a name="line-85"></a><span>    </span><a name="local-6989586621679289381"><a href="#local-6989586621679289381"><span class="hs-identifier">weightSequence</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">^.</span><span> </span><a href="Bio.Metadata.General.Class.html#characterWeight"><span class="hs-identifier hs-var">characterWeight</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">toList</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">dynamicCharacters</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-6989586621679289378"><span class="hs-identifier hs-var">sequencesWLOG</span></a><span>
</span><a name="line-86"></a><span>
</span><a name="line-87"></a><span class="hs-comment">--    tcmSequence = (fmap (^. symbolChangeMatrix) . toList . dynamicCharacters) &lt;$&gt; sequencesWLOG</span><span>
</span><a name="line-88"></a><span class="hs-comment">--    functionSequence = fmap (\tcm x y -&gt; pariwiseFunction' x y tcm) &lt;$&gt; tcmSequence </span><span>
</span><a name="line-89"></a><span>
</span><a name="line-90"></a><span>    </span><a name="local-6989586621679289382"><a href="#local-6989586621679289382"><span class="hs-identifier">functionSequence</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fmap</span><span> </span><a href="#local-6989586621679289385"><span class="hs-identifier hs-var">getDynamicMetric</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">toList</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">dynamicCharacters</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-6989586621679289378"><span class="hs-identifier hs-var">sequencesWLOG</span></a><span>
</span><a name="line-91"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-92"></a><span>        </span><a name="local-6989586621679289385"><a href="#local-6989586621679289385"><span class="hs-identifier">getDynamicMetric</span></a></a><span> </span><a name="local-6989586621679289386"><a href="#local-6989586621679289386"><span class="hs-identifier">dec</span></a></a><span> </span><a name="local-6989586621679289387"><a href="#local-6989586621679289387"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621679289388"><a href="#local-6989586621679289388"><span class="hs-identifier">y</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">!</span><a name="local-6989586621679289389"><a href="#local-6989586621679289389"><span class="hs-identifier">c</span></a></a><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Analysis.Parsimony.Dynamic.DirectOptimization.Internal.html#selectDynamicMetric"><span class="hs-identifier hs-var">selectDynamicMetric</span></a><span> </span><a href="#local-6989586621679289386"><span class="hs-identifier hs-var">dec</span></a><span> </span><a href="#local-6989586621679289387"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621679289388"><span class="hs-identifier hs-var">y</span></a><span> </span><span class="hs-keyword">in</span><span> </span><span class="hs-comment">{- trace (&quot;Cost &quot; &lt;&gt; show c) -}</span><span> </span><a href="#local-6989586621679289389"><span class="hs-identifier hs-var">c</span></a><span>
</span><a name="line-93"></a><span>
</span><a name="line-94"></a><span class="hs-comment">--    showChar = showStream alphabet</span><span>
</span><a name="line-95"></a><span>
</span><a name="line-96"></a><span class="hs-comment">--    alphabet = A.fromSymbols [&quot;A&quot;,&quot;C&quot;,&quot;G&quot;,&quot;T&quot;]</span><span>
</span><a name="line-97"></a><span>
</span><a name="line-98"></a><span>    </span><a name="local-6989586621679289383"><a href="#local-6989586621679289383"><span class="hs-identifier">applyWeights</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">force</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">zipWith</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">zipWith</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679289390"><a href="#local-6989586621679289390"><span class="hs-identifier">d</span></a></a><span> </span><a name="local-6989586621679289391"><a href="#local-6989586621679289391"><span class="hs-identifier">w</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679289390"><span class="hs-identifier hs-var">d</span></a><span> </span><span class="hs-operator hs-var">*</span><span> </span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><a href="#local-6989586621679289391"><span class="hs-identifier hs-var">w</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679289381"><span class="hs-identifier hs-var">weightSequence</span></a><span>
</span><a name="line-99"></a><span>
</span><a name="line-100"></a><span>    </span><span class="hs-comment">-- For each node in the DAG, fold over the connected edges that have not yet been traversed</span><span>
</span><a name="line-101"></a><span>    </span><span class="hs-comment">-- and accumulate the total edge cost of each dynamic character.</span><span>
</span><a name="line-102"></a><span class="hs-comment">--    f :: NonEmpty [i] -&gt; Int -&gt; IndexData e n -&gt; NonEmpty [i]</span><span>
</span><a name="line-103"></a><span>    </span><a name="local-6989586621679289384"><a href="#local-6989586621679289384"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621679289392"><a href="#local-6989586621679289392"><span class="hs-identifier">acc</span></a></a><span> </span><a name="local-6989586621679289393"><a href="#local-6989586621679289393"><span class="hs-identifier">key</span></a></a><span> </span><a name="local-6989586621679289394"><a href="#local-6989586621679289394"><span class="hs-identifier">node</span></a></a><span>
</span><a name="line-104"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679289393"><span class="hs-identifier hs-var">key</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elem</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679289376"><span class="hs-identifier hs-var">roots</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679289392"><span class="hs-identifier hs-var">acc</span></a><span>
</span><a name="line-105"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ofoldl'</span><span> </span><a href="#local-6989586621679289398"><span class="hs-identifier hs-var">g</span></a><span> </span><a href="#local-6989586621679289392"><span class="hs-identifier hs-var">acc</span></a><span> </span><a href="#local-6989586621679289396"><span class="hs-identifier hs-var">applicableNodes</span></a><span>
</span><a name="line-106"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-107"></a><span>        </span><a name="local-6989586621679289395"><a href="#local-6989586621679289395"><span class="hs-identifier">adjacentNodes</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">IS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621679289399"><span class="hs-identifier hs-var">collapseRootEdge</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-108"></a><span>                              </span><span class="hs-identifier">parentRefs</span><span> </span><a href="#local-6989586621679289394"><span class="hs-identifier hs-var">node</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span>
</span><a name="line-109"></a><span>                              </span><span class="hs-identifier hs-var">IM</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">keysSet</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">childRefs</span><span> </span><a href="#local-6989586621679289394"><span class="hs-identifier hs-var">node</span></a><span class="hs-special">)</span><span>
</span><a name="line-110"></a><span>        </span><a name="local-6989586621679289396"><a href="#local-6989586621679289396"><span class="hs-identifier">applicableNodes</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">{- IS.map (\x -&gt; trace (&quot;Edge: &quot; &lt;&gt; show (key, x)) x) $ -}</span><span> </span><span class="hs-identifier hs-var">IS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">&gt;</span><span> </span><a href="#local-6989586621679289393"><span class="hs-identifier hs-var">key</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679289395"><span class="hs-identifier hs-var">adjacentNodes</span></a><span>
</span><a name="line-111"></a><span>        </span><a name="local-6989586621679289397"><a href="#local-6989586621679289397"><span class="hs-identifier">nodeSequence</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679289380"><span class="hs-identifier hs-var">getFields</span></a><span> </span><a href="#local-6989586621679289393"><span class="hs-identifier hs-var">key</span></a><span>
</span><a name="line-112"></a><span>
</span><a name="line-113"></a><span>        </span><span class="hs-comment">-- Folding function for adjacent nodes. Should apply the sum strictly.</span><span>
</span><a name="line-114"></a><span class="hs-comment">--        g seqAcc = force . zipWith (zipWith (+)) seqAcc . zipWith (zipWith pariwiseFunction') . nodeSequence . getFields</span><span>
</span><a name="line-115"></a><span>        </span><a name="local-6989586621679289398"><a href="#local-6989586621679289398"><span class="hs-identifier">g</span></a></a><span> </span><a name="local-6989586621679289400"><a href="#local-6989586621679289400"><span class="hs-identifier">seqAcc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">force</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">zipWith</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">zipWith</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">+</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679289400"><span class="hs-identifier hs-var">seqAcc</span></a><span> </span><span class="hs-operator hs-var">.</span><span>
</span><a name="line-116"></a><span>                           </span><span class="hs-identifier hs-var">zipWith</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">zipWith</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">$</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">zipWith</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">zipWith</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">$</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679289382"><span class="hs-identifier hs-var">functionSequence</span></a><span> </span><a href="#local-6989586621679289397"><span class="hs-identifier hs-var">nodeSequence</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="#local-6989586621679289380"><span class="hs-identifier hs-var">getFields</span></a><span>
</span><a name="line-117"></a><span>        </span><span>
</span><a name="line-118"></a><span>        </span><a name="local-6989586621679289399"><a href="#local-6989586621679289399"><span class="hs-identifier">collapseRootEdge</span></a></a><span> </span><a name="local-6989586621679289401"><a href="#local-6989586621679289401"><span class="hs-identifier">i</span></a></a><span>
</span><a name="line-119"></a><span>          </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679289401"><span class="hs-identifier hs-var">i</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">notElem</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679289376"><span class="hs-identifier hs-var">roots</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679289401"><span class="hs-identifier hs-var">i</span></a><span>
</span><a name="line-120"></a><span>          </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">{- (\x-&gt; trace (unwords [ show i
                                             , &quot; is a root index, so the edge&quot;
                                             , show (i, key)
                                             , &quot;is invalid!&quot;
                                             , show x
                                             , &quot;is the incident node index, so the replacement edge is&quot;
                                             , show (x, key)
                                             ]) x) .
                        -}</span><span>
</span><a name="line-129"></a><span>                        </span><span class="hs-identifier hs-var">head</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">/=</span><span> </span><a href="#local-6989586621679289393"><span class="hs-identifier hs-var">key</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.</span><span>  </span><span class="hs-identifier hs-var">IM</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">keys</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">childRefs</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679289375"><span class="hs-identifier hs-var">refVec</span></a><span> </span><span class="hs-glyph">!</span><span> </span><a href="#local-6989586621679289401"><span class="hs-identifier hs-var">i</span></a><span>
</span><a name="line-130"></a><span>            </span><span>
</span><a name="line-131"></a></pre></body></html>