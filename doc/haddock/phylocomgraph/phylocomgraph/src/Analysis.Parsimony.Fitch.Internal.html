<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">-----------------------------------------------------------------------------</span><span>
</span><a name="line-2"></a><span class="hs-comment">-- |</span><span>
</span><a name="line-3"></a><span class="hs-comment">-- Module      :  Analysis.Parsimony.Fitch</span><span>
</span><a name="line-4"></a><span class="hs-comment">-- Copyright   :  (c) 2015-2015 Ward Wheeler</span><span>
</span><a name="line-5"></a><span class="hs-comment">-- License     :  BSD-style</span><span>
</span><a name="line-6"></a><span class="hs-comment">--</span><span>
</span><a name="line-7"></a><span class="hs-comment">-- Maintainer  :  wheeler@amnh.org</span><span>
</span><a name="line-8"></a><span class="hs-comment">-- Stability   :  provisional</span><span>
</span><a name="line-9"></a><span class="hs-comment">-- Portability :  portable</span><span>
</span><a name="line-10"></a><span class="hs-comment">--</span><span>
</span><a name="line-11"></a><span class="hs-comment">-- Standard Fitch (non-additive) character analysis (cost and medians).</span><span>
</span><a name="line-12"></a><span class="hs-comment">--</span><span>
</span><a name="line-13"></a><span class="hs-comment">-- This only works on static characters, and due to the traversal, only one</span><span>
</span><a name="line-14"></a><span class="hs-comment">-- character will be received at a time.</span><span>
</span><a name="line-15"></a><span class="hs-comment">--</span><span>
</span><a name="line-16"></a><span class="hs-comment">-- Assumes binary trees.</span><span>
</span><a name="line-17"></a><span class="hs-comment">--</span><span>
</span><a name="line-18"></a><span class="hs-comment">-----------------------------------------------------------------------------</span><span>
</span><a name="line-19"></a><span>
</span><a name="line-20"></a><span class="hs-pragma">{-# LANGUAGE FlexibleContexts #-}</span><span>
</span><a name="line-21"></a><span>
</span><a name="line-22"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Analysis</span><span class="hs-operator">.</span><span class="hs-identifier">Parsimony</span><span class="hs-operator">.</span><span class="hs-identifier">Fitch</span><span class="hs-operator">.</span><span class="hs-identifier">Internal</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-23"></a><span>
</span><a name="line-24"></a><span class="hs-keyword">import</span><span> </span><a href="Bio.Character.Decoration.Discrete.html"><span class="hs-identifier">Bio</span><span class="hs-operator">.</span><span class="hs-identifier">Character</span><span class="hs-operator">.</span><span class="hs-identifier">Decoration</span><span class="hs-operator">.</span><span class="hs-identifier">Discrete</span></a><span>
</span><a name="line-25"></a><span class="hs-keyword">import</span><span> </span><a href="Bio.Character.Decoration.Fitch.html"><span class="hs-identifier">Bio</span><span class="hs-operator">.</span><span class="hs-identifier">Character</span><span class="hs-operator">.</span><span class="hs-identifier">Decoration</span><span class="hs-operator">.</span><span class="hs-identifier">Fitch</span></a><span>
</span><a name="line-26"></a><span class="hs-keyword">import</span><span> </span><a href="Bio.Character.Encodable.html"><span class="hs-identifier">Bio</span><span class="hs-operator">.</span><span class="hs-identifier">Character</span><span class="hs-operator">.</span><span class="hs-identifier">Encodable</span></a><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Lens</span><span>
</span><a name="line-28"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Bits</span><span>
</span><a name="line-29"></a><span class="hs-comment">-- import Data.Key</span><span>
</span><a name="line-30"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">List</span><span class="hs-operator">.</span><span class="hs-identifier">NonEmpty</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">NonEmpty</span><span class="hs-special">(</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">:|</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-31"></a><span class="hs-comment">-- import Debug.Trace</span><span>
</span><a name="line-32"></a><span>
</span><a name="line-33"></a><span>
</span><a name="line-34"></a><span class="hs-comment">-- | Used on the post-order (i.e. first) traversal.</span><span>
</span><a name="line-35"></a><span class="hs-identifier">fitchPostOrder</span><span> </span><span class="hs-glyph">::</span><span>  </span><a href="Bio.Character.Decoration.Discrete.html#DiscreteCharacterDecoration"><span class="hs-identifier hs-type">DiscreteCharacterDecoration</span></a><span> </span><a href="#local-6989586621679222854"><span class="hs-identifier hs-type">d</span></a><span> </span><a href="#local-6989586621679222855"><span class="hs-identifier hs-type">c</span></a><span>
</span><a name="line-36"></a><span>               </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679222854"><span class="hs-identifier hs-type">d</span></a><span>
</span><a name="line-37"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Bio.Character.Decoration.Fitch.Internal.html#FitchOptimizationDecoration"><span class="hs-identifier hs-type">FitchOptimizationDecoration</span></a><span> </span><a href="#local-6989586621679222855"><span class="hs-identifier hs-type">c</span></a><span class="hs-special">]</span><span>
</span><a name="line-38"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Bio.Character.Decoration.Fitch.Internal.html#FitchOptimizationDecoration"><span class="hs-identifier hs-type">FitchOptimizationDecoration</span></a><span> </span><a href="#local-6989586621679222855"><span class="hs-identifier hs-type">c</span></a><span>
</span><a name="line-39"></a><a name="fitchPostOrder"><a href="Analysis.Parsimony.Fitch.Internal.html#fitchPostOrder"><span class="hs-identifier">fitchPostOrder</span></a></a><span> </span><a name="local-6989586621679222856"><a href="#local-6989586621679222856"><span class="hs-identifier">parentDecoration</span></a></a><span> </span><a name="local-6989586621679222857"><a href="#local-6989586621679222857"><span class="hs-identifier">xs</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-40"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679222857"><span class="hs-identifier hs-var">xs</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-41"></a><span>        </span><span class="hs-special">[</span><span class="hs-special">]</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Analysis.Parsimony.Fitch.Internal.html#initializeLeaf"><span class="hs-identifier hs-var">initializeLeaf</span></a><span>  </span><a href="#local-6989586621679222856"><span class="hs-identifier hs-var">parentDecoration</span></a><span>         </span><span class="hs-comment">-- a leaf</span><span>
</span><a name="line-42"></a><span>        </span><a name="local-6989586621679222858"><a href="#local-6989586621679222858"><span class="hs-identifier">y</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621679222859"><a href="#local-6989586621679222859"><span class="hs-identifier">ys</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Analysis.Parsimony.Fitch.Internal.html#updatePostOrder"><span class="hs-identifier hs-var">updatePostOrder</span></a><span> </span><a href="#local-6989586621679222856"><span class="hs-identifier hs-var">parentDecoration</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679222858"><span class="hs-identifier hs-var">y</span></a><span class="hs-operator hs-var">:|</span><a href="#local-6989586621679222859"><span class="hs-identifier hs-var">ys</span></a><span class="hs-special">)</span><span>
</span><a name="line-43"></a><span>
</span><a name="line-44"></a><span>
</span><a name="line-45"></a><span class="hs-comment">-- | Used on the pre-order (i.e. second) traversal.</span><span>
</span><a name="line-46"></a><span class="hs-identifier">fitchPreOrder</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Bio.Character.Encodable.Static.Class.html#EncodableStaticCharacter"><span class="hs-identifier hs-type">EncodableStaticCharacter</span></a><span> </span><a href="#local-6989586621679222853"><span class="hs-identifier hs-type">c</span></a><span>
</span><a name="line-47"></a><span>              </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Bio.Character.Decoration.Fitch.Internal.html#FitchOptimizationDecoration"><span class="hs-identifier hs-type">FitchOptimizationDecoration</span></a><span> </span><a href="#local-6989586621679222853"><span class="hs-identifier hs-type">c</span></a><span>
</span><a name="line-48"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Word</span><span class="hs-special">,</span><span> </span><a href="Bio.Character.Decoration.Fitch.Internal.html#FitchOptimizationDecoration"><span class="hs-identifier hs-type">FitchOptimizationDecoration</span></a><span> </span><a href="#local-6989586621679222853"><span class="hs-identifier hs-type">c</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-49"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Bio.Character.Decoration.Fitch.Internal.html#FitchOptimizationDecoration"><span class="hs-identifier hs-type">FitchOptimizationDecoration</span></a><span> </span><a href="#local-6989586621679222853"><span class="hs-identifier hs-type">c</span></a><span>
</span><a name="line-50"></a><a name="fitchPreOrder"><a href="Analysis.Parsimony.Fitch.Internal.html#fitchPreOrder"><span class="hs-identifier">fitchPreOrder</span></a></a><span> </span><a name="local-6989586621679222860"><a href="#local-6989586621679222860"><span class="hs-identifier">childDecoration</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-glyph">:</span><span class="hs-identifier">_</span><span class="hs-glyph">:</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679222860"><span class="hs-identifier hs-var">childDecoration</span></a><span>   </span><span class="hs-comment">-- two parents; shouldn't be possible, but here for completion</span><span>
</span><a name="line-51"></a><span class="hs-identifier">fitchPreOrder</span><span> </span><a name="local-6989586621679222861"><a href="#local-6989586621679222861"><span class="hs-identifier">childDecoration</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679222861"><span class="hs-identifier hs-var">childDecoration</span></a><span> </span><span class="hs-operator hs-var">&amp;</span><span> </span><a href="Bio.Character.Decoration.Fitch.Class.html#finalMedian"><span class="hs-identifier hs-var">finalMedian</span></a><span> </span><span class="hs-operator hs-var">.~</span><span> </span><a href="#local-6989586621679222862"><span class="hs-identifier hs-var">prelim</span></a><span> </span><span class="hs-operator hs-var">&amp;</span><span> </span><a href="Bio.Character.Decoration.Discrete.html#discreteCharacter"><span class="hs-identifier hs-var">discreteCharacter</span></a><span> </span><span class="hs-operator hs-var">.~</span><span> </span><a href="#local-6989586621679222862"><span class="hs-identifier hs-var">prelim</span></a><span>   </span><span class="hs-comment">-- root</span><span>
</span><a name="line-52"></a><span>    </span><span class="hs-keyword">where</span><span>
</span><a name="line-53"></a><span>        </span><a name="local-6989586621679222862"><a href="#local-6989586621679222862"><span class="hs-identifier">prelim</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679222861"><span class="hs-identifier hs-var">childDecoration</span></a><span> </span><span class="hs-operator hs-var">^.</span><span> </span><a href="Bio.Character.Decoration.Fitch.Class.html#preliminaryMedian"><span class="hs-identifier hs-var">preliminaryMedian</span></a><span>
</span><a name="line-54"></a><span class="hs-identifier">fitchPreOrder</span><span> </span><a name="local-6989586621679222863"><a href="#local-6989586621679222863"><span class="hs-identifier">childDecoration</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621679222864"><a href="#local-6989586621679222864"><span class="hs-identifier">parentDecoration</span></a></a><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-55"></a><span>    </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679222863"><span class="hs-identifier hs-var">childDecoration</span></a><span> </span><span class="hs-operator hs-var">^.</span><span> </span><a href="Bio.Character.Decoration.Shared.html#isLeaf"><span class="hs-identifier hs-var">isLeaf</span></a><span>
</span><a name="line-56"></a><span>        </span><span class="hs-keyword">then</span><span> </span><a href="#local-6989586621679222863"><span class="hs-identifier hs-var">childDecoration</span></a><span> </span><span class="hs-operator hs-var">&amp;</span><span> </span><a href="Bio.Character.Decoration.Fitch.Class.html#finalMedian"><span class="hs-identifier hs-var">finalMedian</span></a><span> </span><span class="hs-operator hs-var">.~</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679222863"><span class="hs-identifier hs-var">childDecoration</span></a><span> </span><span class="hs-operator hs-var">^.</span><span> </span><a href="Bio.Character.Decoration.Fitch.Class.html#preliminaryMedian"><span class="hs-identifier hs-var">preliminaryMedian</span></a><span class="hs-special">)</span><span>                            </span><span class="hs-comment">-- leaf</span><span>
</span><a name="line-57"></a><span>        </span><span class="hs-keyword">else</span><span> </span><a href="Analysis.Parsimony.Fitch.Internal.html#determineFinalState"><span class="hs-identifier hs-var">determineFinalState</span></a><span> </span><a href="#local-6989586621679222864"><span class="hs-identifier hs-var">parentDecoration</span></a><span> </span><a href="#local-6989586621679222863"><span class="hs-identifier hs-var">childDecoration</span></a><span>                                               </span><span class="hs-comment">-- internal node</span><span>
</span><a name="line-58"></a><span>
</span><a name="line-59"></a><span>
</span><a name="line-60"></a><span class="hs-comment">-- |</span><span>
</span><a name="line-61"></a><span class="hs-comment">-- Used in first, postorder, pass. Take in parent and two child nodes. Using the child preliminary decorations,</span><span>
</span><a name="line-62"></a><span class="hs-comment">-- calculate the preliminary character state for the parent node. In addition, calculate the cost of assigning</span><span>
</span><a name="line-63"></a><span class="hs-comment">-- that character state to the parent.</span><span>
</span><a name="line-64"></a><span class="hs-identifier">updatePostOrder</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Bio.Character.Decoration.Discrete.html#DiscreteCharacterDecoration"><span class="hs-identifier hs-type">DiscreteCharacterDecoration</span></a><span> </span><a href="#local-6989586621679222851"><span class="hs-identifier hs-type">d</span></a><span> </span><a href="#local-6989586621679222852"><span class="hs-identifier hs-type">c</span></a><span>
</span><a name="line-65"></a><span>                </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679222851"><span class="hs-identifier hs-type">d</span></a><span>
</span><a name="line-66"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">NonEmpty</span><span> </span><span class="hs-special">(</span><a href="Bio.Character.Decoration.Fitch.Internal.html#FitchOptimizationDecoration"><span class="hs-identifier hs-type">FitchOptimizationDecoration</span></a><span> </span><a href="#local-6989586621679222852"><span class="hs-identifier hs-type">c</span></a><span class="hs-special">)</span><span>
</span><a name="line-67"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Bio.Character.Decoration.Fitch.Internal.html#FitchOptimizationDecoration"><span class="hs-identifier hs-type">FitchOptimizationDecoration</span></a><span> </span><a href="#local-6989586621679222852"><span class="hs-identifier hs-type">c</span></a><span>
</span><a name="line-68"></a><a name="updatePostOrder"><a href="Analysis.Parsimony.Fitch.Internal.html#updatePostOrder"><span class="hs-identifier">updatePostOrder</span></a></a><span> </span><a name="local-6989586621679222865"><a href="#local-6989586621679222865"><span class="hs-identifier">_parentDecoration</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679222866"><a href="#local-6989586621679222866"><span class="hs-identifier">x</span></a></a><span class="hs-operator hs-var">:|</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>                         </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679222866"><span class="hs-identifier hs-var">x</span></a><span>                    </span><span class="hs-comment">-- Shouldn't be possible, but here for completion.</span><span>
</span><a name="line-69"></a><span class="hs-identifier">updatePostOrder</span><span> </span><a name="local-6989586621679222867"><a href="#local-6989586621679222867"><span class="hs-identifier">_parentDecoration</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679222868"><a href="#local-6989586621679222868"><span class="hs-identifier">leftChildDec</span></a></a><span class="hs-operator hs-var">:|</span><a name="local-6989586621679222869"><a href="#local-6989586621679222869"><span class="hs-identifier">rightChildDec</span></a></a><span class="hs-glyph">:</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679222870"><span class="hs-identifier hs-var">returnNodeDecoration</span></a><span> </span><span class="hs-comment">-- Not a leaf</span><span>
</span><a name="line-70"></a><span>    </span><span class="hs-keyword">where</span><span>
</span><a name="line-71"></a><span>        </span><a name="local-6989586621679222870"><a href="#local-6989586621679222870"><span class="hs-identifier">returnNodeDecoration</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-72"></a><span>            </span><a href="Bio.Character.Decoration.Fitch.Class.html#extendDiscreteToFitch"><span class="hs-identifier hs-var">extendDiscreteToFitch</span></a><span> </span><a href="#local-6989586621679222868"><span class="hs-identifier hs-var">leftChildDec</span></a><span> </span><a href="#local-6989586621679222875"><span class="hs-identifier hs-var">totalCost</span></a><span> </span><a href="#local-6989586621679222871"><span class="hs-identifier hs-var">median</span></a><span> </span><a href="#local-6989586621679222876"><span class="hs-identifier hs-var">emptyChar</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679222868"><span class="hs-identifier hs-var">leftChildDec</span></a><span> </span><span class="hs-operator hs-var">^.</span><span> </span><a href="Bio.Character.Decoration.Fitch.Class.html#preliminaryMedian"><span class="hs-identifier hs-var">preliminaryMedian</span></a><span class="hs-special">,</span><span>
</span><a name="line-73"></a><span>                                                                           </span><a href="#local-6989586621679222869"><span class="hs-identifier hs-var">rightChildDec</span></a><span> </span><span class="hs-operator hs-var">^.</span><span> </span><a href="Bio.Character.Decoration.Fitch.Class.html#preliminaryMedian"><span class="hs-identifier hs-var">preliminaryMedian</span></a><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-74"></a><span>        </span><span class="hs-comment">-- fold over states of character. This is Fitch so final cost is either 0 or 1.</span><span>
</span><a name="line-75"></a><span>        </span><span class="hs-comment">-- (median, parentCost) = foldlWithKey f initializedAcc [0..length (leftChildDec ^. characterAlphabet) - 1]</span><span>
</span><a name="line-76"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621679222871"><a href="#local-6989586621679222871"><span class="hs-identifier">median</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679222872"><a href="#local-6989586621679222872"><span class="hs-identifier">parentCost</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-77"></a><span>            </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">popCount</span><span> </span><a href="#local-6989586621679222873"><span class="hs-identifier hs-var">union</span></a><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679222873"><span class="hs-identifier hs-var">union</span></a><span class="hs-special">,</span><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span>
</span><a name="line-78"></a><span>            </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679222874"><span class="hs-identifier hs-var">intersection</span></a><span class="hs-special">,</span><span>  </span><span class="hs-number">1</span><span class="hs-special">)</span><span>
</span><a name="line-79"></a><span>        </span><a name="local-6989586621679222873"><a href="#local-6989586621679222873"><span class="hs-identifier">union</span></a></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679222868"><span class="hs-identifier hs-var">leftChildDec</span></a><span> </span><span class="hs-operator hs-var">^.</span><span> </span><a href="Bio.Character.Decoration.Fitch.Class.html#preliminaryMedian"><span class="hs-identifier hs-var">preliminaryMedian</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.&amp;.</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679222869"><span class="hs-identifier hs-var">rightChildDec</span></a><span> </span><span class="hs-operator hs-var">^.</span><span> </span><a href="Bio.Character.Decoration.Fitch.Class.html#preliminaryMedian"><span class="hs-identifier hs-var">preliminaryMedian</span></a><span class="hs-special">)</span><span>
</span><a name="line-80"></a><span>        </span><a name="local-6989586621679222874"><a href="#local-6989586621679222874"><span class="hs-identifier">intersection</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679222868"><span class="hs-identifier hs-var">leftChildDec</span></a><span> </span><span class="hs-operator hs-var">^.</span><span> </span><a href="Bio.Character.Decoration.Fitch.Class.html#preliminaryMedian"><span class="hs-identifier hs-var">preliminaryMedian</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.|.</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679222869"><span class="hs-identifier hs-var">rightChildDec</span></a><span> </span><span class="hs-operator hs-var">^.</span><span> </span><a href="Bio.Character.Decoration.Fitch.Class.html#preliminaryMedian"><span class="hs-identifier hs-var">preliminaryMedian</span></a><span class="hs-special">)</span><span>
</span><a name="line-81"></a><span>        </span><a name="local-6989586621679222875"><a href="#local-6989586621679222875"><span class="hs-identifier">totalCost</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679222872"><span class="hs-identifier hs-var">parentCost</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679222868"><span class="hs-identifier hs-var">leftChildDec</span></a><span> </span><span class="hs-operator hs-var">^.</span><span> </span><a href="Bio.Character.Decoration.Shared.html#characterCost"><span class="hs-identifier hs-var">characterCost</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679222869"><span class="hs-identifier hs-var">rightChildDec</span></a><span> </span><span class="hs-operator hs-var">^.</span><span> </span><a href="Bio.Character.Decoration.Shared.html#characterCost"><span class="hs-identifier hs-var">characterCost</span></a><span class="hs-special">)</span><span>
</span><a name="line-82"></a><span>        </span><a name="local-6989586621679222876"><a href="#local-6989586621679222876"><span class="hs-identifier">emptyChar</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="Bio.Character.Encodable.Static.Class.html#emptyStatic"><span class="hs-identifier hs-var">emptyStatic</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679222868"><span class="hs-identifier hs-var">leftChildDec</span></a><span> </span><span class="hs-operator hs-var">^.</span><span> </span><a href="Bio.Character.Decoration.Discrete.html#discreteCharacter"><span class="hs-identifier hs-var">discreteCharacter</span></a><span>
</span><a name="line-83"></a><span>
</span><a name="line-84"></a><span>
</span><a name="line-85"></a><span class="hs-comment">-- |</span><span>
</span><a name="line-86"></a><span class="hs-comment">-- A leaf has cost 0 and its preliminary character state is also its final character state.</span><span>
</span><a name="line-87"></a><span class="hs-comment">-- Its &quot;child preliminary medians&quot; are empty lists.</span><span>
</span><a name="line-88"></a><span class="hs-identifier">initializeLeaf</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Bio.Character.Decoration.Discrete.html#DiscreteCharacterDecoration"><span class="hs-identifier hs-type">DiscreteCharacterDecoration</span></a><span> </span><a href="#local-6989586621679222849"><span class="hs-identifier hs-type">d</span></a><span> </span><a href="#local-6989586621679222850"><span class="hs-identifier hs-type">c</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679222849"><span class="hs-identifier hs-type">d</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Bio.Character.Decoration.Fitch.Internal.html#FitchOptimizationDecoration"><span class="hs-identifier hs-type">FitchOptimizationDecoration</span></a><span> </span><a href="#local-6989586621679222850"><span class="hs-identifier hs-type">c</span></a><span>
</span><a name="line-89"></a><a name="initializeLeaf"><a href="Analysis.Parsimony.Fitch.Internal.html#initializeLeaf"><span class="hs-identifier">initializeLeaf</span></a></a><span> </span><a name="local-6989586621679222877"><a href="#local-6989586621679222877"><span class="hs-identifier">leafDecoration</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-90"></a><span>    </span><a href="Bio.Character.Decoration.Fitch.Class.html#extendDiscreteToFitch"><span class="hs-identifier hs-var">extendDiscreteToFitch</span></a><span> </span><a href="#local-6989586621679222877"><span class="hs-identifier hs-var">leafDecoration</span></a><span> </span><span class="hs-number">0</span><span> </span><a href="#local-6989586621679222879"><span class="hs-identifier hs-var">leafChar</span></a><span> </span><a href="#local-6989586621679222878"><span class="hs-identifier hs-var">emptyChar</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679222878"><span class="hs-identifier hs-var">emptyChar</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679222878"><span class="hs-identifier hs-var">emptyChar</span></a><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-91"></a><span>    </span><span class="hs-keyword">where</span><span>
</span><a name="line-92"></a><span>        </span><span class="hs-comment">--label     = leafDecoration ^. discreteCharacter -- can skip this now, because it's set in post order</span><span>
</span><a name="line-93"></a><span>        </span><a name="local-6989586621679222878"><a href="#local-6989586621679222878"><span class="hs-identifier">emptyChar</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Bio.Character.Encodable.Static.Class.html#emptyStatic"><span class="hs-identifier hs-var">emptyStatic</span></a><span> </span><a href="#local-6989586621679222879"><span class="hs-identifier hs-var">leafChar</span></a><span>
</span><a name="line-94"></a><span>        </span><a name="local-6989586621679222879"><a href="#local-6989586621679222879"><span class="hs-identifier">leafChar</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679222877"><span class="hs-identifier hs-var">leafDecoration</span></a><span> </span><span class="hs-operator hs-var">^.</span><span> </span><a href="Bio.Character.Decoration.Discrete.html#discreteCharacter"><span class="hs-identifier hs-var">discreteCharacter</span></a><span>
</span><a name="line-95"></a><span>
</span><a name="line-96"></a><span>
</span><a name="line-97"></a><span class="hs-comment">-- |</span><span>
</span><a name="line-98"></a><span class="hs-comment">-- Using the preliminary state of the current node, as well as the preliminary states of its parent and sibling,</span><span>
</span><a name="line-99"></a><span class="hs-comment">-- compute the final state of the character using Fitch's ordered rules.</span><span>
</span><a name="line-100"></a><span class="hs-identifier">determineFinalState</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Bio.Character.Encodable.Static.Class.html#EncodableStaticCharacter"><span class="hs-identifier hs-type">EncodableStaticCharacter</span></a><span> </span><a href="#local-6989586621679222848"><span class="hs-identifier hs-type">c</span></a><span>
</span><a name="line-101"></a><span>                    </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Bio.Character.Decoration.Fitch.Internal.html#FitchOptimizationDecoration"><span class="hs-identifier hs-type">FitchOptimizationDecoration</span></a><span> </span><a href="#local-6989586621679222848"><span class="hs-identifier hs-type">c</span></a><span>
</span><a name="line-102"></a><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Bio.Character.Decoration.Fitch.Internal.html#FitchOptimizationDecoration"><span class="hs-identifier hs-type">FitchOptimizationDecoration</span></a><span> </span><a href="#local-6989586621679222848"><span class="hs-identifier hs-type">c</span></a><span>
</span><a name="line-103"></a><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Bio.Character.Decoration.Fitch.Internal.html#FitchOptimizationDecoration"><span class="hs-identifier hs-type">FitchOptimizationDecoration</span></a><span> </span><a href="#local-6989586621679222848"><span class="hs-identifier hs-type">c</span></a><span>
</span><a name="line-104"></a><a name="determineFinalState"><a href="Analysis.Parsimony.Fitch.Internal.html#determineFinalState"><span class="hs-identifier">determineFinalState</span></a></a><span> </span><a name="local-6989586621679222880"><a href="#local-6989586621679222880"><span class="hs-identifier">parentDecoration</span></a></a><span> </span><a name="local-6989586621679222881"><a href="#local-6989586621679222881"><span class="hs-identifier">childDecoration</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679222885"><span class="hs-identifier hs-var">finalDecoration</span></a><span>
</span><a name="line-105"></a><span>    </span><span class="hs-keyword">where</span><span>
</span><a name="line-106"></a><span>        </span><span class="hs-comment">-- following two should both short-circuit</span><span>
</span><a name="line-107"></a><span>        </span><a name="local-6989586621679222882"><a href="#local-6989586621679222882"><span class="hs-identifier">curIsSuperset</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679222889"><span class="hs-identifier hs-var">ancestor</span></a><span> </span><span class="hs-special">`</span><a href="#local-6989586621679222893"><span class="hs-identifier hs-var">intersect</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621679222888"><span class="hs-identifier hs-var">preliminary</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621679222889"><span class="hs-identifier hs-var">ancestor</span></a><span>
</span><a name="line-108"></a><span>
</span><a name="line-109"></a><span>        </span><a name="local-6989586621679222883"><a href="#local-6989586621679222883"><span class="hs-identifier">curIsUnion</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679222890"><span class="hs-identifier hs-var">left</span></a><span> </span><span class="hs-special">`</span><a href="#local-6989586621679222892"><span class="hs-identifier hs-var">union</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621679222891"><span class="hs-identifier hs-var">right</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621679222888"><span class="hs-identifier hs-var">preliminary</span></a><span>
</span><a name="line-110"></a><span>
</span><a name="line-111"></a><span>            </span><span class="hs-comment">-- using parentDecoration here because I need a DiscreteCharacterDecoration.</span><span>
</span><a name="line-112"></a><span>            </span><span class="hs-comment">-- Safe because new char is created.</span><span>
</span><a name="line-113"></a><span>        </span><a name="local-6989586621679222884"><a href="#local-6989586621679222884"><span class="hs-identifier">interimDecoration</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Bio.Character.Decoration.Fitch.Class.html#extendDiscreteToFitch"><span class="hs-identifier hs-var">extendDiscreteToFitch</span></a><span> </span><a href="#local-6989586621679222880"><span class="hs-identifier hs-var">parentDecoration</span></a><span> </span><a href="#local-6989586621679222887"><span class="hs-identifier hs-var">cost</span></a><span> </span><a href="#local-6989586621679222888"><span class="hs-identifier hs-var">preliminary</span></a><span> </span><a href="#local-6989586621679222894"><span class="hs-identifier hs-var">median</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679222890"><span class="hs-identifier hs-var">left</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679222891"><span class="hs-identifier hs-var">right</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679222886"><span class="hs-identifier hs-var">leafVal</span></a><span>
</span><a name="line-114"></a><span>        </span><a name="local-6989586621679222885"><a href="#local-6989586621679222885"><span class="hs-identifier">finalDecoration</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679222884"><span class="hs-identifier hs-var">interimDecoration</span></a><span> </span><span class="hs-operator hs-var">&amp;</span><span> </span><a href="Bio.Character.Decoration.Discrete.html#discreteCharacter"><span class="hs-identifier hs-var">discreteCharacter</span></a><span> </span><span class="hs-operator hs-var">.~</span><span> </span><a href="#local-6989586621679222894"><span class="hs-identifier hs-var">median</span></a><span>
</span><a name="line-115"></a><span>        </span><a name="local-6989586621679222886"><a href="#local-6989586621679222886"><span class="hs-identifier">leafVal</span></a></a><span>           </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679222881"><span class="hs-identifier hs-var">childDecoration</span></a><span>  </span><span class="hs-operator hs-var">^.</span><span> </span><a href="Bio.Character.Decoration.Shared.html#isLeaf"><span class="hs-identifier hs-var">isLeaf</span></a><span>
</span><a name="line-116"></a><span>        </span><a name="local-6989586621679222887"><a href="#local-6989586621679222887"><span class="hs-identifier">cost</span></a></a><span>              </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679222881"><span class="hs-identifier hs-var">childDecoration</span></a><span>  </span><span class="hs-operator hs-var">^.</span><span> </span><a href="Bio.Character.Decoration.Shared.html#characterCost"><span class="hs-identifier hs-var">characterCost</span></a><span>
</span><a name="line-117"></a><span>        </span><a name="local-6989586621679222888"><a href="#local-6989586621679222888"><span class="hs-identifier">preliminary</span></a></a><span>       </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679222881"><span class="hs-identifier hs-var">childDecoration</span></a><span>  </span><span class="hs-operator hs-var">^.</span><span> </span><a href="Bio.Character.Decoration.Fitch.Class.html#preliminaryMedian"><span class="hs-identifier hs-var">preliminaryMedian</span></a><span>
</span><a name="line-118"></a><span>        </span><a name="local-6989586621679222889"><a href="#local-6989586621679222889"><span class="hs-identifier">ancestor</span></a></a><span>          </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679222880"><span class="hs-identifier hs-var">parentDecoration</span></a><span> </span><span class="hs-operator hs-var">^.</span><span> </span><a href="Bio.Character.Decoration.Fitch.Class.html#preliminaryMedian"><span class="hs-identifier hs-var">preliminaryMedian</span></a><span>
</span><a name="line-119"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621679222890"><a href="#local-6989586621679222890"><span class="hs-identifier">left</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679222891"><a href="#local-6989586621679222891"><span class="hs-identifier">right</span></a></a><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679222881"><span class="hs-identifier hs-var">childDecoration</span></a><span>  </span><span class="hs-operator hs-var">^.</span><span> </span><a href="Bio.Character.Decoration.Fitch.Class.html#childMedians"><span class="hs-identifier hs-var">childMedians</span></a><span>
</span><a name="line-120"></a><span>        </span><a name="local-6989586621679222892"><a href="#local-6989586621679222892"><span class="hs-identifier">union</span></a></a><span>     </span><a name="local-6989586621679222895"><a href="#local-6989586621679222895"><span class="hs-identifier">l</span></a></a><span> </span><a name="local-6989586621679222896"><a href="#local-6989586621679222896"><span class="hs-identifier">r</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679222895"><span class="hs-identifier hs-var">l</span></a><span> </span><span class="hs-operator hs-var">.|.</span><span> </span><a href="#local-6989586621679222896"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-121"></a><span>        </span><a name="local-6989586621679222893"><a href="#local-6989586621679222893"><span class="hs-identifier">intersect</span></a></a><span> </span><a name="local-6989586621679222897"><a href="#local-6989586621679222897"><span class="hs-identifier">l</span></a></a><span> </span><a name="local-6989586621679222898"><a href="#local-6989586621679222898"><span class="hs-identifier">r</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679222897"><span class="hs-identifier hs-var">l</span></a><span> </span><span class="hs-operator hs-var">.&amp;.</span><span> </span><a href="#local-6989586621679222898"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-122"></a><span>        </span><a name="local-6989586621679222894"><a href="#local-6989586621679222894"><span class="hs-identifier">median</span></a></a><span>
</span><a name="line-123"></a><span>            </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679222882"><span class="hs-identifier hs-var">curIsSuperset</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679222889"><span class="hs-identifier hs-var">ancestor</span></a><span>                                                                          </span><span class="hs-comment">-- Fitch rule 1</span><span>
</span><a name="line-124"></a><span>            </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679222883"><span class="hs-identifier hs-var">curIsUnion</span></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679222889"><span class="hs-identifier hs-var">ancestor</span></a><span> </span><span class="hs-special">`</span><a href="#local-6989586621679222892"><span class="hs-identifier hs-var">union</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621679222888"><span class="hs-identifier hs-var">preliminary</span></a><span>                                                      </span><span class="hs-comment">-- Fitch rule 2</span><span>
</span><a name="line-125"></a><span>            </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679222889"><span class="hs-identifier hs-var">ancestor</span></a><span> </span><span class="hs-special">`</span><a href="#local-6989586621679222892"><span class="hs-identifier hs-var">union</span></a><span class="hs-special">`</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679222890"><span class="hs-identifier hs-var">left</span></a><span> </span><span class="hs-special">`</span><a href="#local-6989586621679222893"><span class="hs-identifier hs-var">intersect</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621679222889"><span class="hs-identifier hs-var">ancestor</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><a href="#local-6989586621679222892"><span class="hs-identifier hs-var">union</span></a><span class="hs-special">`</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679222891"><span class="hs-identifier hs-var">right</span></a><span> </span><span class="hs-special">`</span><a href="#local-6989586621679222893"><span class="hs-identifier hs-var">intersect</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621679222889"><span class="hs-identifier hs-var">ancestor</span></a><span class="hs-special">)</span><span> </span><span class="hs-comment">-- Fitch rule 3</span><span>
</span><a name="line-126"></a><span>
</span><a name="line-127"></a></pre></body></html>