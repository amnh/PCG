<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><a name="line-2"></a><span class="hs-comment">-- |</span><span>
</span><a name="line-3"></a><span class="hs-comment">-- Module      :  Bio.Graph.PhylogeneticDAG.NetworkEdgeQuantification</span><span>
</span><a name="line-4"></a><span class="hs-comment">-- Copyright   :  (c) 2015-2015 Ward Wheeler</span><span>
</span><a name="line-5"></a><span class="hs-comment">-- License     :  BSD-style</span><span>
</span><a name="line-6"></a><span class="hs-comment">--</span><span>
</span><a name="line-7"></a><span class="hs-comment">-- Maintainer  :  wheeler@amnh.org</span><span>
</span><a name="line-8"></a><span class="hs-comment">-- Stability   :  provisional</span><span>
</span><a name="line-9"></a><span class="hs-comment">-- Portability :  portable</span><span>
</span><a name="line-10"></a><span class="hs-comment">--</span><span>
</span><a name="line-11"></a><span class="hs-comment">-----------------------------------------------------------------------------</span><span>
</span><a name="line-12"></a><span>
</span><a name="line-13"></a><span class="hs-pragma">{-# LANGUAGE FlexibleContexts #-}</span><span>
</span><a name="line-14"></a><span>
</span><a name="line-15"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Bio</span><span class="hs-operator">.</span><span class="hs-identifier">Graph</span><span class="hs-operator">.</span><span class="hs-identifier">PhylogeneticDAG</span><span class="hs-operator">.</span><span class="hs-identifier">NetworkEdgeQuantification</span><span>
</span><a name="line-16"></a><span>  </span><span class="hs-special">(</span><span> </span><a href="Bio.Graph.PhylogeneticDAG.NetworkEdgeQuantification.html#assignPunitiveNetworkEdgeCost"><span class="hs-identifier hs-var">assignPunitiveNetworkEdgeCost</span></a><span>
</span><a name="line-17"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Bio.Graph.PhylogeneticDAG.NetworkEdgeQuantification.html#extractMostParsimoniusDisplayForest"><span class="hs-identifier hs-var">extractMostParsimoniusDisplayForest</span></a><span>
</span><a name="line-18"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Bio.Graph.PhylogeneticDAG.NetworkEdgeQuantification.html#extractMinimalDisplayForestPerBlock"><span class="hs-identifier hs-var">extractMinimalDisplayForestPerBlock</span></a><span>
</span><a name="line-19"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Bio.Graph.PhylogeneticDAG.NetworkEdgeQuantification.html#gatherDisplayForests"><span class="hs-identifier hs-var">gatherDisplayForests</span></a><span>
</span><a name="line-20"></a><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-21"></a><span>
</span><a name="line-22"></a><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span>           </span><a href="Bio.Metadata.Dynamic.html"><span class="hs-identifier">Bio</span><span class="hs-operator">.</span><span class="hs-identifier">Metadata</span><span class="hs-operator">.</span><span class="hs-identifier">Dynamic</span></a><span>     </span><span class="hs-comment">--(TraversalFoci, TraversalFocusEdge, TraversalTopology, traversalFoci)</span><span>
</span><a name="line-24"></a><span class="hs-keyword">import</span><span>           </span><a href="Bio.Sequence.html"><span class="hs-identifier">Bio</span><span class="hs-operator">.</span><span class="hs-identifier">Sequence</span></a><span>
</span><a name="line-25"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="Bio.Sequence.Block.html"><span class="hs-identifier">Bio</span><span class="hs-operator">.</span><span class="hs-identifier">Sequence</span><span class="hs-operator">.</span><span class="hs-identifier">Block</span></a><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">BLK</span><span>
</span><a name="line-26"></a><span class="hs-keyword">import</span><span>           </span><a href="Bio.Graph.Node.html"><span class="hs-identifier">Bio</span><span class="hs-operator">.</span><span class="hs-identifier">Graph</span><span class="hs-operator">.</span><span class="hs-identifier">Node</span></a><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span>           </span><a href="Bio.Graph.PhylogeneticDAG.Internal.html"><span class="hs-identifier">Bio</span><span class="hs-operator">.</span><span class="hs-identifier">Graph</span><span class="hs-operator">.</span><span class="hs-identifier">PhylogeneticDAG</span><span class="hs-operator">.</span><span class="hs-identifier">Internal</span></a><span>
</span><a name="line-28"></a><span class="hs-keyword">import</span><span>           </span><a href="Bio.Graph.ReferenceDAG.Internal.html"><span class="hs-identifier">Bio</span><span class="hs-operator">.</span><span class="hs-identifier">Graph</span><span class="hs-operator">.</span><span class="hs-identifier">ReferenceDAG</span><span class="hs-operator">.</span><span class="hs-identifier">Internal</span></a><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Lens</span><span>
</span><a name="line-30"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Bits</span><span>
</span><a name="line-31"></a><span class="hs-comment">--import           Data.EdgeSet</span><span>
</span><a name="line-32"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Foldable</span><span>
</span><a name="line-33"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Key</span><span>
</span><a name="line-34"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">List</span><span class="hs-operator">.</span><span class="hs-identifier">NonEmpty</span><span>        </span><span class="hs-special">(</span><span class="hs-identifier hs-type">NonEmpty</span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-operator hs-var">:|</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-35"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">List</span><span class="hs-operator">.</span><span class="hs-identifier">NonEmpty</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">NE</span><span>
</span><a name="line-36"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">List</span><span class="hs-operator">.</span><span class="hs-identifier">Utility</span><span>
</span><a name="line-37"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Maybe</span><span>                </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromJust</span><span class="hs-special">)</span><span>
</span><a name="line-38"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Semigroup</span><span>
</span><a name="line-39"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Semigroup</span><span class="hs-operator">.</span><span class="hs-identifier">Foldable</span><span>
</span><a name="line-40"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Set</span><span>                  </span><span class="hs-special">(</span><span class="hs-identifier hs-var">difference</span><span class="hs-special">)</span><span>
</span><a name="line-41"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Set</span><span>           </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">S</span><span>
</span><a name="line-42"></a><span class="hs-keyword">import</span><span>           </span><a href="Data.TopologyRepresentation.html"><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">TopologyRepresentation</span></a><span>
</span><a name="line-43"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Ord</span><span>
</span><a name="line-44"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Vector</span><span>               </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Vector</span><span class="hs-special">)</span><span>
</span><a name="line-45"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Numeric</span><span class="hs-operator">.</span><span class="hs-identifier">Extended</span><span class="hs-operator">.</span><span class="hs-identifier">Real</span><span>
</span><a name="line-46"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Prelude</span><span>            </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">zipWith</span><span class="hs-special">)</span><span>
</span><a name="line-47"></a><span>
</span><a name="line-48"></a><span class="hs-comment">--import Debug.Trace</span><span>
</span><a name="line-49"></a><span>
</span><a name="line-50"></a><span>
</span><a name="line-51"></a><span class="hs-comment">-- |</span><span>
</span><a name="line-52"></a><span class="hs-comment">-- Calculate and assign the punitive network edge cost for the DAG.</span><span>
</span><a name="line-53"></a><span class="hs-comment">--</span><span>
</span><a name="line-54"></a><span class="hs-comment">-- Consider a network \(N = (V, E)\), as commonly defined with an edge set \(E\)</span><span>
</span><a name="line-55"></a><span class="hs-comment">-- and vertex set \(V\). Let this network be a directed, acyclic graph (DAG) with</span><span>
</span><a name="line-56"></a><span class="hs-comment">-- a single root. Furthermore, consider the set of display trees \(T\), with</span><span>
</span><a name="line-57"></a><span class="hs-comment">-- individual display trees denoted as \(&#964; \in T\), derived from the resolutions</span><span>
</span><a name="line-58"></a><span class="hs-comment">-- of network edges in \(E\) with \(n\) leaf taxa. For a set of \(k\) character</span><span>
</span><a name="line-59"></a><span class="hs-comment">-- blocks \(C = \(C_1, ... , C_k\)\), there is at least one most parsimonious</span><span>
</span><a name="line-60"></a><span class="hs-comment">-- display tree \(&#964;_{min} \in T\) with a cost of \(cost \left(&#964;_{min} \right)\)</span><span>
</span><a name="line-61"></a><span class="hs-comment">-- and with edge set \(E_{min} \subseteq E\) and vertex set</span><span>
</span><a name="line-62"></a><span class="hs-comment">-- \(V_{min} \subseteq V\). We further denote the display tree with minimum cost</span><span>
</span><a name="line-63"></a><span class="hs-comment">-- \(c_i\) for the character block \(C_i \in C\) as \(&#964;_i \in T\) with the</span><span>
</span><a name="line-64"></a><span class="hs-comment">-- corresponding edge set \(E_i \subseteq E\) and vertex set \(V_i \subseteq V\).</span><span>
</span><a name="line-65"></a><span class="hs-comment">--</span><span>
</span><a name="line-66"></a><span class="hs-comment">-- The network edge punative cost is \(\infty\) if there is an &quot;unused&quot; network</span><span>
</span><a name="line-67"></a><span class="hs-comment">-- edge in the DAG. There exists an &quot;unused&quot; edge in the DAG if and only if there</span><span>
</span><a name="line-68"></a><span class="hs-comment">-- exists a network edge \(e \in E\) such that:</span><span>
</span><a name="line-69"></a><span class="hs-comment">--</span><span>
</span><a name="line-70"></a><span class="hs-comment">-- \[ \forall C_i \in C \quad  &#964;_i \in T \; \text{is the minimal display tree for} \; C_i \text{and} \; e \not \in &#964;_i \]</span><span>
</span><a name="line-71"></a><span class="hs-comment">--</span><span>
</span><a name="line-72"></a><span class="hs-comment">-- If there does not exist such a network edge we consider all the network edges</span><span>
</span><a name="line-73"></a><span class="hs-comment">-- in the DAG &quot;used&quot; and the punative network edge cost is defined as follows:</span><span>
</span><a name="line-74"></a><span class="hs-comment">--</span><span>
</span><a name="line-75"></a><span class="hs-comment">-- \[ \frac {\Sigma_{1}^{k} \; c_i \times | E_i \setminus E_{min} |} {2 \times \left( 2n -2 \right)} \]</span><span>
</span><a name="line-76"></a><span class="hs-comment">--</span><span>
</span><a name="line-77"></a><span class="hs-comment">-- For more detail on the quantification of a network with a single root, see:</span><span>
</span><a name="line-78"></a><span class="hs-comment">--</span><span>
</span><a name="line-79"></a><span class="hs-comment">-- /Phylogenetic network analysis as a parsimony optimization problem/, Wheeler 2015</span><span>
</span><a name="line-80"></a><span class="hs-comment">--</span><span>
</span><a name="line-81"></a><span class="hs-comment">-- We must also consider the cases of multi-rooted DAGs, extending the method</span><span>
</span><a name="line-82"></a><span class="hs-comment">-- described above. Unlike in the single rooted DAG context where we find a</span><span>
</span><a name="line-83"></a><span class="hs-comment">-- minimum display tree over all character blocks, in a multi-rooted DAG we find</span><span>
</span><a name="line-84"></a><span class="hs-comment">-- the &quot;minimal display forest&quot; over all character blocks. In the multi-rooted</span><span>
</span><a name="line-85"></a><span class="hs-comment">-- DAG, let \( \left\{r_1, r_2, ... r_k \right\} = \mathcal{R}\) be the set of</span><span>
</span><a name="line-86"></a><span class="hs-comment">-- \(k\) set roots.</span><span>
</span><a name="line-87"></a><span class="hs-comment">--</span><span>
</span><a name="line-88"></a><span class="hs-comment">-- The minimal display forest is the set</span><span>
</span><a name="line-89"></a><span class="hs-comment">--</span><span>
</span><a name="line-90"></a><span class="hs-comment">-- </span><span>
</span><a name="line-91"></a><span class="hs-comment">--</span><span>
</span><a name="line-92"></a><span class="hs-comment">-- This function performs this punative network edge cost calculation and updates</span><span>
</span><a name="line-93"></a><span class="hs-comment">-- the DAG metadata to reflect the cost of the network context.</span><span>
</span><a name="line-94"></a><span class="hs-identifier">assignPunitiveNetworkEdgeCost</span><span>
</span><a name="line-95"></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span> </span><a href="Bio.Sequence.Block.html#HasBlockCost"><span class="hs-identifier hs-type">HasBlockCost</span></a><span> </span><a href="#local-6989586621679296171"><span class="hs-identifier hs-type">u</span></a><span> </span><a href="#local-6989586621679296172"><span class="hs-identifier hs-type">v</span></a><span> </span><a href="#local-6989586621679296173"><span class="hs-identifier hs-type">w</span></a><span> </span><a href="#local-6989586621679296174"><span class="hs-identifier hs-type">x</span></a><span> </span><a href="#local-6989586621679296175"><span class="hs-identifier hs-type">y</span></a><span> </span><a href="#local-6989586621679296176"><span class="hs-identifier hs-type">z</span></a><span> </span><a href="#local-6989586621679296177"><span class="hs-identifier hs-type">i</span></a><span> </span><a href="#local-6989586621679296178"><span class="hs-identifier hs-type">r</span></a><span>
</span><a name="line-96"></a><span>     </span><span class="hs-special">,</span><span> </span><a href="Bio.Sequence.Block.html#HasRootCost"><span class="hs-identifier hs-type">HasRootCost</span></a><span>  </span><a href="#local-6989586621679296171"><span class="hs-identifier hs-type">u</span></a><span> </span><a href="#local-6989586621679296172"><span class="hs-identifier hs-type">v</span></a><span> </span><a href="#local-6989586621679296173"><span class="hs-identifier hs-type">w</span></a><span> </span><a href="#local-6989586621679296174"><span class="hs-identifier hs-type">x</span></a><span> </span><a href="#local-6989586621679296175"><span class="hs-identifier hs-type">y</span></a><span> </span><a href="#local-6989586621679296176"><span class="hs-identifier hs-type">z</span></a><span>   </span><a href="#local-6989586621679296178"><span class="hs-identifier hs-type">r</span></a><span>
</span><a name="line-97"></a><span>     </span><span class="hs-special">,</span><span> </span><a href="Bio.Metadata.Dynamic.Class.html#HasTraversalFoci"><span class="hs-identifier hs-type">HasTraversalFoci</span></a><span> </span><a href="#local-6989586621679296176"><span class="hs-identifier hs-type">z</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="Bio.Metadata.Dynamic.Internal.html#TraversalFoci"><span class="hs-identifier hs-type">TraversalFoci</span></a><span class="hs-special">)</span><span>
</span><a name="line-98"></a><span>     </span><span class="hs-special">)</span><span>
</span><a name="line-99"></a><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Bio.Graph.PhylogeneticDAG.Internal.html#PhylogeneticDAG2"><span class="hs-identifier hs-type">PhylogeneticDAG2</span></a><span> </span><a href="#local-6989586621679296179"><span class="hs-identifier hs-type">e</span></a><span> </span><a href="#local-6989586621679296180"><span class="hs-identifier hs-type">n</span></a><span> </span><a href="#local-6989586621679296171"><span class="hs-identifier hs-type">u</span></a><span> </span><a href="#local-6989586621679296172"><span class="hs-identifier hs-type">v</span></a><span> </span><a href="#local-6989586621679296173"><span class="hs-identifier hs-type">w</span></a><span> </span><a href="#local-6989586621679296174"><span class="hs-identifier hs-type">x</span></a><span> </span><a href="#local-6989586621679296175"><span class="hs-identifier hs-type">y</span></a><span> </span><a href="#local-6989586621679296176"><span class="hs-identifier hs-type">z</span></a><span>
</span><a name="line-100"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">NonEmpty</span><span> </span><span class="hs-special">(</span><a href="Bio.Metadata.Dynamic.Internal.html#TraversalTopology"><span class="hs-identifier hs-type">TraversalTopology</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679296178"><span class="hs-identifier hs-type">r</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679296178"><span class="hs-identifier hs-type">r</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679296178"><span class="hs-identifier hs-type">r</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Vector</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">NonEmpty</span><span> </span><a href="Bio.Metadata.Dynamic.Internal.html#TraversalFocusEdge"><span class="hs-identifier hs-type">TraversalFocusEdge</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Bio.Graph.PhylogeneticDAG.Internal.html#PhylogeneticDAG2"><span class="hs-identifier hs-type">PhylogeneticDAG2</span></a><span> </span><a href="#local-6989586621679296179"><span class="hs-identifier hs-type">e</span></a><span> </span><a href="#local-6989586621679296180"><span class="hs-identifier hs-type">n</span></a><span> </span><a href="#local-6989586621679296171"><span class="hs-identifier hs-type">u</span></a><span> </span><a href="#local-6989586621679296172"><span class="hs-identifier hs-type">v</span></a><span> </span><a href="#local-6989586621679296173"><span class="hs-identifier hs-type">w</span></a><span> </span><a href="#local-6989586621679296174"><span class="hs-identifier hs-type">x</span></a><span> </span><a href="#local-6989586621679296175"><span class="hs-identifier hs-type">y</span></a><span> </span><a href="#local-6989586621679296176"><span class="hs-identifier hs-type">z</span></a><span class="hs-special">)</span><span>
</span><a name="line-101"></a><a name="assignPunitiveNetworkEdgeCost"><a href="Bio.Graph.PhylogeneticDAG.NetworkEdgeQuantification.html#assignPunitiveNetworkEdgeCost"><span class="hs-identifier">assignPunitiveNetworkEdgeCost</span></a></a><span> </span><a name="local-6989586621679296181"><a href="#local-6989586621679296181"><span class="hs-identifier">input</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="Bio.Graph.PhylogeneticDAG.Internal.html#PDAG2"><span class="hs-identifier hs-var">PDAG2</span></a><span> </span><a name="local-6989586621679296182"><a href="#local-6989586621679296182"><span class="hs-identifier">dag</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679296194"><span class="hs-identifier hs-var">outputContext</span></a><span class="hs-special">,</span><span> </span><a href="Bio.Graph.PhylogeneticDAG.Internal.html#PDAG2"><span class="hs-identifier hs-var">PDAG2</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679296182"><span class="hs-identifier hs-var">dag</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">graphData</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679296195"><span class="hs-identifier hs-var">newGraphData</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-102"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-103"></a><span>    </span><span class="hs-comment">-- First grab all the valid display forests present in the DAG.</span><span>
</span><a name="line-104"></a><span>    </span><a name="local-6989586621679296183"><a href="#local-6989586621679296183"><span class="hs-identifier">displayForests</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-105"></a><span>        </span><span class="hs-keyword">case</span><span> </span><a href="Bio.Graph.PhylogeneticDAG.NetworkEdgeQuantification.html#gatherDisplayForests"><span class="hs-identifier hs-var">gatherDisplayForests</span></a><span> </span><a href="#local-6989586621679296181"><span class="hs-identifier hs-var">input</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-106"></a><span>          </span><span class="hs-special">[</span><span class="hs-special">]</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">error</span><span> </span><span class="hs-string">&quot;A very interesting error has occurred, There are not valid display forests in the DAG!&quot;</span><span>
</span><a name="line-107"></a><span>          </span><a name="local-6989586621679296196"><a href="#local-6989586621679296196"><span class="hs-identifier">x</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621679296197"><a href="#local-6989586621679296197"><span class="hs-identifier">xs</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679296196"><span class="hs-identifier hs-var">x</span></a><span class="hs-operator hs-var">:|</span><a href="#local-6989586621679296197"><span class="hs-identifier hs-var">xs</span></a><span>
</span><a name="line-108"></a><span>
</span><a name="line-109"></a><span>    </span><span class="hs-comment">-- Use the valid display forests to determine:</span><span>
</span><a name="line-110"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-111"></a><span>    </span><span class="hs-comment">--  * The most parsimonious display forest for /all/ characters.</span><span>
</span><a name="line-112"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-113"></a><span>    </span><span class="hs-comment">--  * The most parsimonious display forest for /each/ characters.</span><span>
</span><a name="line-114"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-115"></a><span>    </span><a name="local-6989586621679296184"><a href="#local-6989586621679296184"><span class="hs-identifier">mostParsimoniousDisplayForest</span></a></a><span>       </span><span class="hs-glyph">=</span><span> </span><a href="Bio.Graph.PhylogeneticDAG.NetworkEdgeQuantification.html#extractMostParsimoniusDisplayForest"><span class="hs-identifier hs-var">extractMostParsimoniusDisplayForest</span></a><span> </span><a href="#local-6989586621679296183"><span class="hs-identifier hs-var">displayForests</span></a><span>
</span><a name="line-116"></a><span>    </span><a name="local-6989586621679296185"><a href="#local-6989586621679296185"><span class="hs-identifier">minimalDisplayForestPerBlockContext</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Bio.Graph.PhylogeneticDAG.NetworkEdgeQuantification.html#extractMinimalDisplayForestPerBlock"><span class="hs-identifier hs-var">extractMinimalDisplayForestPerBlock</span></a><span> </span><a href="#local-6989586621679296183"><span class="hs-identifier hs-var">displayForests</span></a><span>
</span><a name="line-117"></a><span>    </span><a name="local-6989586621679296186"><a href="#local-6989586621679296186"><span class="hs-identifier">minimalDisplayForestPerBlock</span></a></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="Bio.Graph.PhylogeneticDAG.NetworkEdgeQuantification.html#ignoreDynamicCharacterTraversalFoci"><span class="hs-identifier hs-var">ignoreDynamicCharacterTraversalFoci</span></a><span> </span><a href="#local-6989586621679296185"><span class="hs-identifier hs-var">minimalDisplayForestPerBlockContext</span></a><span>
</span><a name="line-118"></a><span>
</span><a name="line-119"></a><span>    </span><span class="hs-comment">-- We need the collection of network edges in the DAG to calculate the</span><span>
</span><a name="line-120"></a><span>    </span><span class="hs-comment">-- numerator of the network edge cost.</span><span>
</span><a name="line-121"></a><span>    </span><a name="local-6989586621679296187"><a href="#local-6989586621679296187"><span class="hs-identifier">networkEdgeSet</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Bio.Graph.ReferenceDAG.Internal.html#referenceNetworkEdgeSet"><span class="hs-identifier hs-var">referenceNetworkEdgeSet</span></a><span> </span><a href="#local-6989586621679296182"><span class="hs-identifier hs-var">dag</span></a><span>
</span><a name="line-122"></a><span>
</span><a name="line-123"></a><span>    </span><span class="hs-comment">-- We also need the size fo the edge set of the DAG to calculate the</span><span>
</span><a name="line-124"></a><span>    </span><span class="hs-comment">-- denominator of the network edge cost.</span><span>
</span><a name="line-125"></a><span>    </span><a name="local-6989586621679296188"><a href="#local-6989586621679296188"><span class="hs-identifier">edgeSetSize</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">toEnum</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Bio.Graph.ReferenceDAG.Internal.html#referenceEdgeSet"><span class="hs-identifier hs-var">referenceEdgeSet</span></a><span> </span><a href="#local-6989586621679296182"><span class="hs-identifier hs-var">dag</span></a><span>
</span><a name="line-126"></a><span>
</span><a name="line-127"></a><span>    </span><span class="hs-comment">-- With all the requisite information in scope we can now compute the</span><span>
</span><a name="line-128"></a><span>    </span><span class="hs-comment">-- punative network edge cost for the DAG.</span><span>
</span><a name="line-129"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621679296189"><a href="#local-6989586621679296189"><span class="hs-identifier">punativeCost</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679296190"><a href="#local-6989586621679296190"><span class="hs-identifier">splitPunativeCosts</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-130"></a><span>        </span><a href="Bio.Graph.PhylogeneticDAG.NetworkEdgeQuantification.html#calculatePunitiveNetworkEdgeCost"><span class="hs-identifier hs-var">calculatePunitiveNetworkEdgeCost</span></a><span>
</span><a name="line-131"></a><span>          </span><a href="#local-6989586621679296188"><span class="hs-identifier hs-var">edgeSetSize</span></a><span>
</span><a name="line-132"></a><span>          </span><a href="#local-6989586621679296187"><span class="hs-identifier hs-var">networkEdgeSet</span></a><span>
</span><a name="line-133"></a><span>          </span><a href="#local-6989586621679296184"><span class="hs-identifier hs-var">mostParsimoniousDisplayForest</span></a><span>
</span><a name="line-134"></a><span>          </span><a href="#local-6989586621679296186"><span class="hs-identifier hs-var">minimalDisplayForestPerBlock</span></a><span>
</span><a name="line-135"></a><span>
</span><a name="line-136"></a><span>    </span><span class="hs-comment">-- We also accumulate the cost of all the character blocks accros the display forests.</span><span>
</span><a name="line-137"></a><span>    </span><a name="local-6989586621679296191"><a href="#local-6989586621679296191"><span class="hs-identifier">cumulativeCharacterCost</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">sum</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">,</span><a name="local-6989586621679296198"><a href="#local-6989586621679296198"><span class="hs-identifier">c</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679296198"><span class="hs-identifier hs-var">c</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-6989586621679296186"><span class="hs-identifier hs-var">minimalDisplayForestPerBlock</span></a><span>
</span><a name="line-138"></a><span>
</span><a name="line-139"></a><span>    </span><span class="hs-comment">-- And accumulate the root cost of all the blocks accross the display forests.</span><span>
</span><a name="line-140"></a><span>    </span><a name="local-6989586621679296192"><a href="#local-6989586621679296192"><span class="hs-identifier">cumulativeRootCost</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">sum</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><a name="local-6989586621679296199"><a href="#local-6989586621679296199"><span class="hs-identifier">c</span></a></a><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679296199"><span class="hs-identifier hs-var">c</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-6989586621679296186"><span class="hs-identifier hs-var">minimalDisplayForestPerBlock</span></a><span>
</span><a name="line-141"></a><span>
</span><a name="line-142"></a><span>    </span><span class="hs-comment">-- And lastly the total DAG cost</span><span>
</span><a name="line-143"></a><span>    </span><a name="local-6989586621679296193"><a href="#local-6989586621679296193"><span class="hs-identifier">totalCost</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679296189"><span class="hs-identifier hs-var">punativeCost</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-identifier hs-var">realToFrac</span><span> </span><a href="#local-6989586621679296191"><span class="hs-identifier hs-var">cumulativeCharacterCost</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-identifier hs-var">realToFrac</span><span> </span><a href="#local-6989586621679296192"><span class="hs-identifier hs-var">cumulativeRootCost</span></a><span>
</span><a name="line-144"></a><span>
</span><a name="line-145"></a><span>    </span><span class="hs-comment">-- And store all the minimization work in a context to be returned.</span><span>
</span><a name="line-146"></a><span>    </span><a name="local-6989586621679296194"><a href="#local-6989586621679296194"><span class="hs-identifier">outputContext</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">zipWith</span><span> </span><a href="#local-6989586621679296200"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621679296190"><span class="hs-identifier hs-var">splitPunativeCosts</span></a><span> </span><a href="#local-6989586621679296185"><span class="hs-identifier hs-var">minimalDisplayForestPerBlockContext</span></a><span>
</span><a name="line-147"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-148"></a><span>        </span><a name="local-6989586621679296200"><a href="#local-6989586621679296200"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621679296201"><a href="#local-6989586621679296201"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679296202"><a href="#local-6989586621679296202"><span class="hs-identifier">a</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679296203"><a href="#local-6989586621679296203"><span class="hs-identifier">b</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679296204"><a href="#local-6989586621679296204"><span class="hs-identifier">c</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679296205"><a href="#local-6989586621679296205"><span class="hs-identifier">d</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679296202"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679296203"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679296201"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679296204"><span class="hs-identifier hs-var">c</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679296205"><span class="hs-identifier hs-var">d</span></a><span class="hs-special">)</span><span>
</span><a name="line-149"></a><span>
</span><a name="line-150"></a><span>    </span><a name="local-6989586621679296195"><a href="#local-6989586621679296195"><span class="hs-identifier">newGraphData</span></a></a><span>  </span><span class="hs-glyph">=</span><span>
</span><a name="line-151"></a><span>        </span><a href="Bio.Graph.ReferenceDAG.Internal.html#GraphData"><span class="hs-identifier hs-var">GraphData</span></a><span>        </span><span>
</span><a name="line-152"></a><span>        </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">dagCost</span><span>           </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679296193"><span class="hs-identifier hs-var">totalCost</span></a><span>
</span><a name="line-153"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">networkEdgeCost</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679296189"><span class="hs-identifier hs-var">punativeCost</span></a><span>
</span><a name="line-154"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">rootingCost</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">realToFrac</span><span> </span><a href="#local-6989586621679296192"><span class="hs-identifier hs-var">cumulativeRootCost</span></a><span>
</span><a name="line-155"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">totalBlockCost</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">realToFrac</span><span> </span><a href="#local-6989586621679296191"><span class="hs-identifier hs-var">cumulativeCharacterCost</span></a><span>
</span><a name="line-156"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">graphMetadata</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">graphMetadata</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">graphData</span><span> </span><a href="#local-6989586621679296182"><span class="hs-identifier hs-var">dag</span></a><span>
</span><a name="line-157"></a><span>        </span><span class="hs-special">}</span><span>
</span><a name="line-158"></a><span>
</span><a name="line-159"></a><span>    </span><span>
</span><a name="line-160"></a><span>    </span><span>
</span><a name="line-161"></a><span class="hs-comment">{-
assignPunitiveNetworkEdgeCost :: HasBlockCost u v w x y z i r =&gt; PhylogeneticDAG2 e n u v w x y z -&gt; PhylogeneticDAG2 e n u v w x y z
assignPunitiveNetworkEdgeCost input@(PDAG2 dag) = PDAG2 $ dag { graphData = newGraphData }
  where
    punativeCost  = calculatePunitiveNetworkEdgeCost input
--    sequenceCosts = minimum . fmap totalSubtreeCost . resolutions . nodeDecoration . (references dag !) &lt;$&gt; rootRefs dag
    sequenceCosts = sum . fmap minimum . NE.transpose . fmap (fmap blockCost . toBlocks . characterSequence)
                  . (\x -&gt; trace (renderResolutionContexts x) x)
                  . resolutions . nodeDecoration . (references dag !) &lt;$&gt; rootRefs dag
    newGraphData  =
        GraphData        
        { dagCost           = punativeCost + realToFrac (sum sequenceCosts)
        , networkEdgeCost   = punativeCost
        , rootSequenceCosts = realToFrac &lt;$&gt; sequenceCosts
        , graphMetadata     = graphMetadata $ graphData dag
        }
    renderResolutionContexts = unlines . fmap renderContext . toList 
      where
        renderContext x = unwords
            [ show $ totalSubtreeCost x
            , show $ subtreeEdgeSet x
            ]
-}</span><span>      </span><span>
</span><a name="line-184"></a><span>
</span><a name="line-185"></a><span>
</span><a name="line-186"></a><span class="hs-comment">-- |</span><span>
</span><a name="line-187"></a><span class="hs-comment">-- /O(r * 2^d)/ where /r/ is the number of roots and /d/ is the number of network</span><span>
</span><a name="line-188"></a><span class="hs-comment">-- nodes in the DAG.</span><span>
</span><a name="line-189"></a><span class="hs-comment">-- </span><span>
</span><a name="line-190"></a><span class="hs-comment">-- Gathers the valid display forests present in the input DAG.</span><span>
</span><a name="line-191"></a><span class="hs-comment">--</span><span>
</span><a name="line-192"></a><span class="hs-comment">-- A valid display forest satifies the following constraints:</span><span>
</span><a name="line-193"></a><span class="hs-comment">--</span><span>
</span><a name="line-194"></a><span class="hs-comment">-- * For each root node in the input DAG, there is a corresponding display tree</span><span>
</span><a name="line-195"></a><span class="hs-comment">--   with that root.</span><span>
</span><a name="line-196"></a><span class="hs-comment">--</span><span>
</span><a name="line-197"></a><span class="hs-comment">-- * Each display tree in the display forest is not connected to anothe display</span><span>
</span><a name="line-198"></a><span class="hs-comment">--   tree. Equivelently, no two roots on the input DAG are connected.</span><span>
</span><a name="line-199"></a><span class="hs-comment">--</span><span>
</span><a name="line-200"></a><span class="hs-comment">-- * Each taxa in the input DAG is connected to exactly one root.</span><span>
</span><a name="line-201"></a><span class="hs-comment">--</span><span>
</span><a name="line-202"></a><span class="hs-identifier">gatherDisplayForests</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Bio.Graph.PhylogeneticDAG.Internal.html#PhylogeneticDAG2"><span class="hs-identifier hs-type">PhylogeneticDAG2</span></a><span> </span><a href="#local-6989586621679296163"><span class="hs-identifier hs-type">e</span></a><span> </span><a href="#local-6989586621679296164"><span class="hs-identifier hs-type">n</span></a><span> </span><a href="#local-6989586621679296165"><span class="hs-identifier hs-type">u</span></a><span> </span><a href="#local-6989586621679296166"><span class="hs-identifier hs-type">v</span></a><span> </span><a href="#local-6989586621679296167"><span class="hs-identifier hs-type">w</span></a><span> </span><a href="#local-6989586621679296168"><span class="hs-identifier hs-type">x</span></a><span> </span><a href="#local-6989586621679296169"><span class="hs-identifier hs-type">y</span></a><span> </span><a href="#local-6989586621679296170"><span class="hs-identifier hs-type">z</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Bio.Graph.Node.Internal.html#ResolutionCache"><span class="hs-identifier hs-type">ResolutionCache</span></a><span> </span><span class="hs-special">(</span><a href="Bio.Sequence.Internal.html#CharacterSequence"><span class="hs-identifier hs-type">CharacterSequence</span></a><span> </span><a href="#local-6989586621679296165"><span class="hs-identifier hs-type">u</span></a><span> </span><a href="#local-6989586621679296166"><span class="hs-identifier hs-type">v</span></a><span> </span><a href="#local-6989586621679296167"><span class="hs-identifier hs-type">w</span></a><span> </span><a href="#local-6989586621679296168"><span class="hs-identifier hs-type">x</span></a><span> </span><a href="#local-6989586621679296169"><span class="hs-identifier hs-type">y</span></a><span> </span><a href="#local-6989586621679296170"><span class="hs-identifier hs-type">z</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-203"></a><a name="gatherDisplayForests"><a href="Bio.Graph.PhylogeneticDAG.NetworkEdgeQuantification.html#gatherDisplayForests"><span class="hs-identifier">gatherDisplayForests</span></a></a><span> </span><span class="hs-special">(</span><a href="Bio.Graph.PhylogeneticDAG.Internal.html#PDAG2"><span class="hs-identifier hs-var">PDAG2</span></a><span> </span><a name="local-6989586621679296206"><a href="#local-6989586621679296206"><span class="hs-identifier">dag</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679296209"><span class="hs-identifier hs-var">result</span></a><span>
</span><a name="line-204"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-205"></a><span>    </span><span class="hs-comment">-- First we collect all resolutions for each root node</span><span>
</span><a name="line-206"></a><span>    </span><a name="local-6989586621679296207"><a href="#local-6989586621679296207"><span class="hs-identifier">rootResolutions</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">resolutions</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">nodeDecoration</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679296208"><span class="hs-identifier hs-var">refs</span></a><span> </span><span class="hs-glyph">!</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier">rootRefs</span><span> </span><a href="#local-6989586621679296206"><span class="hs-identifier hs-var">dag</span></a><span>
</span><a name="line-207"></a><span>    </span><a name="local-6989586621679296208"><a href="#local-6989586621679296208"><span class="hs-identifier">refs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">references</span><span> </span><a href="#local-6989586621679296206"><span class="hs-identifier hs-var">dag</span></a><span>
</span><a name="line-208"></a><span>
</span><a name="line-209"></a><span>    </span><span class="hs-comment">-- Second we collect the valid root combinations.</span><span>
</span><a name="line-210"></a><span>    </span><a name="local-6989586621679296209"><a href="#local-6989586621679296209"><span class="hs-identifier">result</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Bio.Graph.PhylogeneticDAG.NetworkEdgeQuantification.html#filterResolutionCombinationsBy"><span class="hs-identifier hs-var">filterResolutionCombinationsBy</span></a><span> </span><a href="Bio.Graph.PhylogeneticDAG.NetworkEdgeQuantification.html#formsValidDisplayForest"><span class="hs-identifier hs-var">formsValidDisplayForest</span></a><span> </span><a href="#local-6989586621679296207"><span class="hs-identifier hs-var">rootResolutions</span></a><span>
</span><a name="line-211"></a><span>
</span><a name="line-212"></a><span>
</span><a name="line-213"></a><span class="hs-comment">-- |</span><span>
</span><a name="line-214"></a><span class="hs-comment">-- There is at least one most parsimonious (for all characters combined) display</span><span>
</span><a name="line-215"></a><span class="hs-comment">-- forest. This display forest is analogous to the most parsimonious display tree</span><span>
</span><a name="line-216"></a><span class="hs-comment">-- \(&#964;_min\) described in /Wheeler 2015/, with additional constraints. See</span><span>
</span><a name="line-217"></a><span class="hs-comment">-- 'gatherDisplayForests' for more information on the contraints of a valid</span><span>
</span><a name="line-218"></a><span class="hs-comment">-- display forest.</span><span>
</span><a name="line-219"></a><span class="hs-comment">--</span><span>
</span><a name="line-220"></a><span class="hs-comment">-- The most parsimonious display forest is the set of display trees which has</span><span>
</span><a name="line-221"></a><span class="hs-comment">-- the minimal cost over all character blocks when adding together the cost of</span><span>
</span><a name="line-222"></a><span class="hs-comment">-- each display tree *and* adding the root cost for each character block.</span><span>
</span><a name="line-223"></a><span class="hs-identifier">extractMostParsimoniusDisplayForest</span><span>
</span><a name="line-224"></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">Foldable1</span><span> </span><a href="#local-6989586621679296154"><span class="hs-identifier hs-type">f</span></a><span>
</span><a name="line-225"></a><span>     </span><span class="hs-special">,</span><span> </span><a href="Bio.Sequence.Block.html#HasBlockCost"><span class="hs-identifier hs-type">HasBlockCost</span></a><span> </span><a href="#local-6989586621679296155"><span class="hs-identifier hs-type">u</span></a><span> </span><a href="#local-6989586621679296156"><span class="hs-identifier hs-type">v</span></a><span> </span><a href="#local-6989586621679296157"><span class="hs-identifier hs-type">w</span></a><span> </span><a href="#local-6989586621679296158"><span class="hs-identifier hs-type">x</span></a><span> </span><a href="#local-6989586621679296159"><span class="hs-identifier hs-type">y</span></a><span> </span><a href="#local-6989586621679296160"><span class="hs-identifier hs-type">z</span></a><span> </span><a href="#local-6989586621679296161"><span class="hs-identifier hs-type">i</span></a><span> </span><a href="#local-6989586621679296162"><span class="hs-identifier hs-type">r</span></a><span>
</span><a name="line-226"></a><span>     </span><span class="hs-special">,</span><span> </span><a href="Bio.Sequence.Block.html#HasRootCost"><span class="hs-identifier hs-type">HasRootCost</span></a><span>  </span><a href="#local-6989586621679296155"><span class="hs-identifier hs-type">u</span></a><span> </span><a href="#local-6989586621679296156"><span class="hs-identifier hs-type">v</span></a><span> </span><a href="#local-6989586621679296157"><span class="hs-identifier hs-type">w</span></a><span> </span><a href="#local-6989586621679296158"><span class="hs-identifier hs-type">x</span></a><span> </span><a href="#local-6989586621679296159"><span class="hs-identifier hs-type">y</span></a><span> </span><a href="#local-6989586621679296160"><span class="hs-identifier hs-type">z</span></a><span>   </span><a href="#local-6989586621679296162"><span class="hs-identifier hs-type">r</span></a><span>
</span><a name="line-227"></a><span>     </span><span class="hs-special">,</span><span> </span><a href="Bio.Metadata.Dynamic.Class.html#HasTraversalFoci"><span class="hs-identifier hs-type">HasTraversalFoci</span></a><span> </span><a href="#local-6989586621679296160"><span class="hs-identifier hs-type">z</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="Bio.Metadata.Dynamic.Internal.html#TraversalFoci"><span class="hs-identifier hs-type">TraversalFoci</span></a><span class="hs-special">)</span><span>
</span><a name="line-228"></a><span>     </span><span class="hs-special">)</span><span>
</span><a name="line-229"></a><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679296154"><span class="hs-identifier hs-type">f</span></a><span> </span><span class="hs-special">(</span><a href="Bio.Graph.Node.Internal.html#ResolutionCache"><span class="hs-identifier hs-type">ResolutionCache</span></a><span> </span><span class="hs-special">(</span><a href="Bio.Sequence.Internal.html#CharacterSequence"><span class="hs-identifier hs-type">CharacterSequence</span></a><span> </span><a href="#local-6989586621679296155"><span class="hs-identifier hs-type">u</span></a><span> </span><a href="#local-6989586621679296156"><span class="hs-identifier hs-type">v</span></a><span> </span><a href="#local-6989586621679296157"><span class="hs-identifier hs-type">w</span></a><span> </span><a href="#local-6989586621679296158"><span class="hs-identifier hs-type">x</span></a><span> </span><a href="#local-6989586621679296159"><span class="hs-identifier hs-type">y</span></a><span> </span><a href="#local-6989586621679296160"><span class="hs-identifier hs-type">z</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-230"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Bio.Metadata.Dynamic.Internal.html#TraversalTopology"><span class="hs-identifier hs-type">TraversalTopology</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679296162"><span class="hs-identifier hs-type">r</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679296162"><span class="hs-identifier hs-type">r</span></a><span class="hs-special">)</span><span>
</span><a name="line-231"></a><a name="extractMostParsimoniusDisplayForest"><a href="Bio.Graph.PhylogeneticDAG.NetworkEdgeQuantification.html#extractMostParsimoniusDisplayForest"><span class="hs-identifier">extractMostParsimoniusDisplayForest</span></a></a><span> </span><a name="local-6989586621679296210"><a href="#local-6989586621679296210"><span class="hs-identifier">displayForests</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679296213"><span class="hs-identifier hs-var">topo</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679296215"><span class="hs-identifier hs-var">rCost</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679296216"><span class="hs-identifier hs-var">bCost</span></a><span class="hs-special">)</span><span>
</span><a name="line-232"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-233"></a><span>    </span><span class="hs-comment">-- We select the most parsimonious display forest.</span><span>
</span><a name="line-234"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-235"></a><span>    </span><span class="hs-comment">-- If there are multiple-equally parsimonious display forests, then we</span><span>
</span><a name="line-236"></a><span>    </span><span class="hs-comment">-- select the first one.</span><span>
</span><a name="line-237"></a><span>    </span><a name="local-6989586621679296211"><a href="#local-6989586621679296211"><span class="hs-identifier">minDisplayForestWLOG</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">head</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">minimaBy</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">comparing</span><span> </span><a href="#local-6989586621679296212"><span class="hs-identifier hs-var">displayForestCost</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679296210"><span class="hs-identifier hs-var">displayForests</span></a><span>
</span><a name="line-238"></a><span>
</span><a name="line-239"></a><span>    </span><a name="local-6989586621679296212"><a href="#local-6989586621679296212"><span class="hs-identifier">displayForestCost</span></a></a><span> </span><a name="local-6989586621679296217"><a href="#local-6989586621679296217"><span class="hs-identifier">dis</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">sum</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679296219"><span class="hs-identifier hs-var">displayTreeCost</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-6989586621679296217"><span class="hs-identifier hs-var">dis</span></a><span>
</span><a name="line-240"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-241"></a><span>        </span><a name="local-6989586621679296218"><a href="#local-6989586621679296218"><span class="hs-identifier">rootCount</span></a></a><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621679296217"><span class="hs-identifier hs-var">dis</span></a><span>
</span><a name="line-242"></a><span>        </span><a name="local-6989586621679296219"><a href="#local-6989586621679296219"><span class="hs-identifier">displayTreeCost</span></a></a><span> </span><a name="local-6989586621679296220"><a href="#local-6989586621679296220"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679296221"><a href="#local-6989586621679296221"><span class="hs-identifier">charSeq</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">characterSequence</span><span> </span><a href="#local-6989586621679296220"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-243"></a><span>                            </span><span class="hs-keyword">in</span><span>  </span><a href="Bio.Sequence.Internal.html#sequenceCost"><span class="hs-identifier hs-var">sequenceCost</span></a><span> </span><a href="#local-6989586621679296221"><span class="hs-identifier hs-var">charSeq</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><a href="Bio.Sequence.Internal.html#sequenceRootCost"><span class="hs-identifier hs-var">sequenceRootCost</span></a><span> </span><a href="#local-6989586621679296218"><span class="hs-identifier hs-var">rootCount</span></a><span> </span><a href="#local-6989586621679296221"><span class="hs-identifier hs-var">charSeq</span></a><span>
</span><a name="line-244"></a><span>
</span><a name="line-245"></a><span>    </span><span class="hs-comment">-- Once we have our most parsimonious display forest we create the forest</span><span>
</span><a name="line-246"></a><span>    </span><span class="hs-comment">-- context for it.</span><span>
</span><a name="line-247"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621679296213"><a href="#local-6989586621679296213"><span class="hs-identifier">topo</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679296214"><a href="#local-6989586621679296214"><span class="hs-identifier">costs</span></a></a><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Bio.Graph.PhylogeneticDAG.NetworkEdgeQuantification.html#createForestContext"><span class="hs-identifier hs-var">createForestContext</span></a><span> </span><a href="#local-6989586621679296211"><span class="hs-identifier hs-var">minDisplayForestWLOG</span></a><span>
</span><a name="line-248"></a><span>
</span><a name="line-249"></a><span>    </span><span class="hs-comment">-- Since we don't need the block-by-block contexts partitioned, we accumulate</span><span>
</span><a name="line-250"></a><span>    </span><span class="hs-comment">-- the costs of the forest context.</span><span>
</span><a name="line-251"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621679296215"><a href="#local-6989586621679296215"><span class="hs-identifier">rCost</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679296216"><a href="#local-6989586621679296216"><span class="hs-identifier">bCost</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldr1</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-6989586621679296222"><a href="#local-6989586621679296222"><span class="hs-identifier">a</span></a></a><span class="hs-special">,</span><a name="local-6989586621679296223"><a href="#local-6989586621679296223"><span class="hs-identifier">b</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679296224"><a href="#local-6989586621679296224"><span class="hs-identifier">c</span></a></a><span class="hs-special">,</span><a name="local-6989586621679296225"><a href="#local-6989586621679296225"><span class="hs-identifier">d</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679296222"><span class="hs-identifier hs-var">a</span></a><span class="hs-operator hs-var">+</span><a href="#local-6989586621679296224"><span class="hs-identifier hs-var">c</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679296223"><span class="hs-identifier hs-var">b</span></a><span class="hs-operator hs-var">+</span><a href="#local-6989586621679296225"><span class="hs-identifier hs-var">d</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-6989586621679296226"><a href="#local-6989586621679296226"><span class="hs-identifier">a</span></a></a><span class="hs-special">,</span><a name="local-6989586621679296227"><a href="#local-6989586621679296227"><span class="hs-identifier">b</span></a></a><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679296226"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">,</span><a href="#local-6989586621679296227"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-6989586621679296214"><span class="hs-identifier hs-var">costs</span></a><span>
</span><a name="line-252"></a><span>
</span><a name="line-253"></a><span>
</span><a name="line-254"></a><span class="hs-comment">-- |</span><span>
</span><a name="line-255"></a><span class="hs-comment">-- Takes the non-empty set of valid display forests and returns the display</span><span>
</span><a name="line-256"></a><span class="hs-comment">-- forest that is minimal for each character block. </span><span>
</span><a name="line-257"></a><span class="hs-identifier">extractMinimalDisplayForestPerBlock</span><span>
</span><a name="line-258"></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">Foldable1</span><span> </span><a href="#local-6989586621679296145"><span class="hs-identifier hs-type">f</span></a><span>
</span><a name="line-259"></a><span>     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Functor</span><span>   </span><a href="#local-6989586621679296145"><span class="hs-identifier hs-type">f</span></a><span>
</span><a name="line-260"></a><span>     </span><span class="hs-special">,</span><span> </span><a href="Bio.Sequence.Block.html#HasBlockCost"><span class="hs-identifier hs-type">HasBlockCost</span></a><span> </span><a href="#local-6989586621679296146"><span class="hs-identifier hs-type">u</span></a><span> </span><a href="#local-6989586621679296147"><span class="hs-identifier hs-type">v</span></a><span> </span><a href="#local-6989586621679296148"><span class="hs-identifier hs-type">w</span></a><span> </span><a href="#local-6989586621679296149"><span class="hs-identifier hs-type">x</span></a><span> </span><a href="#local-6989586621679296150"><span class="hs-identifier hs-type">y</span></a><span> </span><a href="#local-6989586621679296151"><span class="hs-identifier hs-type">z</span></a><span> </span><a href="#local-6989586621679296152"><span class="hs-identifier hs-type">i</span></a><span> </span><a href="#local-6989586621679296153"><span class="hs-identifier hs-type">r</span></a><span>
</span><a name="line-261"></a><span>     </span><span class="hs-special">,</span><span> </span><a href="Bio.Sequence.Block.html#HasRootCost"><span class="hs-identifier hs-type">HasRootCost</span></a><span>  </span><a href="#local-6989586621679296146"><span class="hs-identifier hs-type">u</span></a><span> </span><a href="#local-6989586621679296147"><span class="hs-identifier hs-type">v</span></a><span> </span><a href="#local-6989586621679296148"><span class="hs-identifier hs-type">w</span></a><span> </span><a href="#local-6989586621679296149"><span class="hs-identifier hs-type">x</span></a><span> </span><a href="#local-6989586621679296150"><span class="hs-identifier hs-type">y</span></a><span> </span><a href="#local-6989586621679296151"><span class="hs-identifier hs-type">z</span></a><span>   </span><a href="#local-6989586621679296153"><span class="hs-identifier hs-type">r</span></a><span>
</span><a name="line-262"></a><span>     </span><span class="hs-special">,</span><span> </span><a href="Bio.Metadata.Dynamic.Class.html#HasTraversalFoci"><span class="hs-identifier hs-type">HasTraversalFoci</span></a><span> </span><a href="#local-6989586621679296151"><span class="hs-identifier hs-type">z</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="Bio.Metadata.Dynamic.Internal.html#TraversalFoci"><span class="hs-identifier hs-type">TraversalFoci</span></a><span class="hs-special">)</span><span>
</span><a name="line-263"></a><span>     </span><span class="hs-special">)</span><span>
</span><a name="line-264"></a><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679296145"><span class="hs-identifier hs-type">f</span></a><span> </span><span class="hs-special">(</span><a href="Bio.Graph.Node.Internal.html#ResolutionCache"><span class="hs-identifier hs-type">ResolutionCache</span></a><span> </span><span class="hs-special">(</span><a href="Bio.Sequence.Internal.html#CharacterSequence"><span class="hs-identifier hs-type">CharacterSequence</span></a><span> </span><a href="#local-6989586621679296146"><span class="hs-identifier hs-type">u</span></a><span> </span><a href="#local-6989586621679296147"><span class="hs-identifier hs-type">v</span></a><span> </span><a href="#local-6989586621679296148"><span class="hs-identifier hs-type">w</span></a><span> </span><a href="#local-6989586621679296149"><span class="hs-identifier hs-type">x</span></a><span> </span><a href="#local-6989586621679296150"><span class="hs-identifier hs-type">y</span></a><span> </span><a href="#local-6989586621679296151"><span class="hs-identifier hs-type">z</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>                      </span><span class="hs-comment">-- ^ Set of valid display forests</span><span>
</span><a name="line-265"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">NonEmpty</span><span> </span><span class="hs-special">(</span><a href="Bio.Metadata.Dynamic.Internal.html#TraversalTopology"><span class="hs-identifier hs-type">TraversalTopology</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679296153"><span class="hs-identifier hs-type">r</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679296153"><span class="hs-identifier hs-type">r</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Vector</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">NonEmpty</span><span> </span><a href="Bio.Metadata.Dynamic.Internal.html#TraversalFocusEdge"><span class="hs-identifier hs-type">TraversalFocusEdge</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- ^ Valid display forest for each character block</span><span>
</span><a name="line-266"></a><span>                                                                              </span><span class="hs-comment">--   And the dynamic character rooting edges.</span><span>
</span><a name="line-267"></a><a name="extractMinimalDisplayForestPerBlock"><a href="Bio.Graph.PhylogeneticDAG.NetworkEdgeQuantification.html#extractMinimalDisplayForestPerBlock"><span class="hs-identifier">extractMinimalDisplayForestPerBlock</span></a></a><span> </span><a name="local-6989586621679296228"><a href="#local-6989586621679296228"><span class="hs-identifier">displayForests</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679296229"><span class="hs-identifier hs-var">minimalBlockContexts</span></a><span>
</span><a name="line-268"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-269"></a><span>    </span><a name="local-6989586621679296229"><a href="#local-6989586621679296229"><span class="hs-identifier">minimalBlockContexts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldr1</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">zipWith</span><span> </span><a href="#local-6989586621679296231"><span class="hs-identifier hs-var">minimizeBlockContext</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679296230"><span class="hs-identifier hs-var">validBlockContexts</span></a><span>
</span><a name="line-270"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-271"></a><span>        </span><a name="local-6989586621679296231"><a href="#local-6989586621679296231"><span class="hs-identifier">minimizeBlockContext</span></a></a><span> </span><a name="local-6989586621679296232"><a href="#local-6989586621679296232"><span class="hs-identifier">lhs</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621679296233"><a href="#local-6989586621679296233"><span class="hs-identifier">rCost1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679296234"><a href="#local-6989586621679296234"><span class="hs-identifier">bCost1</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><a name="local-6989586621679296235"><a href="#local-6989586621679296235"><span class="hs-identifier">rhs</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621679296236"><a href="#local-6989586621679296236"><span class="hs-identifier">rCost2</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679296237"><a href="#local-6989586621679296237"><span class="hs-identifier">bCost2</span></a></a><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>
</span><a name="line-272"></a><span>          </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679296238"><span class="hs-identifier hs-var">cost1</span></a><span> </span><span class="hs-operator hs-var">&lt;=</span><span> </span><a href="#local-6989586621679296239"><span class="hs-identifier hs-var">cost2</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679296232"><span class="hs-identifier hs-var">lhs</span></a><span>
</span><a name="line-273"></a><span>          </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679296235"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-274"></a><span>          </span><span class="hs-keyword">where</span><span>
</span><a name="line-275"></a><span>            </span><a name="local-6989586621679296238"><a href="#local-6989586621679296238"><span class="hs-identifier">cost1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679296233"><span class="hs-identifier hs-var">rCost1</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><a href="#local-6989586621679296234"><span class="hs-identifier hs-var">bCost1</span></a><span>
</span><a name="line-276"></a><span>            </span><a name="local-6989586621679296239"><a href="#local-6989586621679296239"><span class="hs-identifier">cost2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679296236"><span class="hs-identifier hs-var">rCost2</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><a href="#local-6989586621679296237"><span class="hs-identifier hs-var">bCost2</span></a><span>
</span><a name="line-277"></a><span>    </span><span>
</span><a name="line-278"></a><span>    </span><a name="local-6989586621679296230"><a href="#local-6989586621679296230"><span class="hs-identifier">validBlockContexts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Bio.Graph.PhylogeneticDAG.NetworkEdgeQuantification.html#linearizeContext"><span class="hs-identifier hs-var">linearizeContext</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Bio.Graph.PhylogeneticDAG.NetworkEdgeQuantification.html#createForestContext"><span class="hs-identifier hs-var">createForestContext</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-6989586621679296228"><span class="hs-identifier hs-var">displayForests</span></a><span>
</span><a name="line-279"></a><span>
</span><a name="line-280"></a><span>
</span><a name="line-281"></a><span class="hs-comment">-- |</span><span>
</span><a name="line-282"></a><span class="hs-comment">-- Calculate the punitive networkedge cost for the DAG.</span><span>
</span><a name="line-283"></a><span class="hs-identifier">calculatePunitiveNetworkEdgeCost</span><span>
</span><a name="line-284"></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">Foldable</span><span> </span><a href="#local-6989586621679296142"><span class="hs-identifier hs-type">f</span></a><span>
</span><a name="line-285"></a><span class="hs-comment">--     , Num r</span><span>
</span><a name="line-286"></a><span>     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Floating</span><span> </span><a href="#local-6989586621679296143"><span class="hs-identifier hs-type">r</span></a><span>
</span><a name="line-287"></a><span>     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Real</span><span> </span><a href="#local-6989586621679296143"><span class="hs-identifier hs-type">r</span></a><span>
</span><a name="line-288"></a><span>     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Ord</span><span> </span><a href="#local-6989586621679296144"><span class="hs-identifier hs-type">e</span></a><span>
</span><a name="line-289"></a><span>     </span><span class="hs-special">)</span><span>
</span><a name="line-290"></a><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Word</span><span>                                      </span><span class="hs-comment">-- ^ Entire DAG edge-set cardinality</span><span>
</span><a name="line-291"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679296142"><span class="hs-identifier hs-type">f</span></a><span> </span><a href="#local-6989586621679296144"><span class="hs-identifier hs-type">e</span></a><span>                                       </span><span class="hs-comment">-- ^ Complete collection of network edges in the DAG</span><span>
</span><a name="line-292"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Data.TopologyRepresentation.html#TopologyRepresentation"><span class="hs-identifier hs-type">TopologyRepresentation</span></a><span> </span><a href="#local-6989586621679296144"><span class="hs-identifier hs-type">e</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679296143"><span class="hs-identifier hs-type">r</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679296143"><span class="hs-identifier hs-type">r</span></a><span class="hs-special">)</span><span>          </span><span class="hs-comment">-- ^ Most parsimonious display forest context</span><span>
</span><a name="line-293"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">NonEmpty</span><span> </span><span class="hs-special">(</span><a href="Data.TopologyRepresentation.html#TopologyRepresentation"><span class="hs-identifier hs-type">TopologyRepresentation</span></a><span> </span><a href="#local-6989586621679296144"><span class="hs-identifier hs-type">e</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679296143"><span class="hs-identifier hs-type">r</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679296143"><span class="hs-identifier hs-type">r</span></a><span class="hs-special">)</span><span> </span><span class="hs-comment">-- ^ Minimal display forest context for each character block</span><span>
</span><a name="line-294"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">ExtendedReal</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">NonEmpty</span><span> </span><a href="#local-6989586621679296143"><span class="hs-identifier hs-type">r</span></a><span class="hs-special">)</span><span>
</span><a name="line-295"></a><a name="calculatePunitiveNetworkEdgeCost"><a href="Bio.Graph.PhylogeneticDAG.NetworkEdgeQuantification.html#calculatePunitiveNetworkEdgeCost"><span class="hs-identifier">calculatePunitiveNetworkEdgeCost</span></a></a><span> </span><a name="local-6989586621679296240"><a href="#local-6989586621679296240"><span class="hs-identifier">edgeSetCardinality</span></a></a><span> </span><a name="local-6989586621679296241"><a href="#local-6989586621679296241"><span class="hs-identifier">networkEdgeSet</span></a></a><span> </span><a name="local-6989586621679296242"><a href="#local-6989586621679296242"><span class="hs-identifier">parsimoniousContext</span></a></a><span> </span><a name="local-6989586621679296243"><a href="#local-6989586621679296243"><span class="hs-identifier">minimalContexts</span></a></a><span>
</span><a name="line-296"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621679296244"><span class="hs-identifier hs-var">extraneousEdges</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- trace (&quot;Extraneous edges: &quot; &lt;&gt; show extraneousEdges)</span><span>
</span><a name="line-297"></a><span>                                 </span><span class="hs-comment">-- . trace (&quot;Entire     edges: &quot; &lt;&gt; show entireNetworkEdgeSet)</span><span>
</span><a name="line-298"></a><span>                                 </span><span class="hs-comment">-- . trace (&quot;Minimal Block edges: &quot; &lt;&gt; show ((\(_,_,x) -&gt; collapseToEdgeSet x) &lt;$&gt; minimalBlockNetworkDisplay)) $</span><span>
</span><a name="line-299"></a><span>                                 </span><span class="hs-special">(</span><span class="hs-identifier hs-var">infinity</span><span class="hs-special">,</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-operator hs-var">&lt;$</span><span> </span><a href="#local-6989586621679296243"><span class="hs-identifier hs-var">minimalContexts</span></a><span class="hs-special">)</span><span>
</span><a name="line-300"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>                  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">realToFrac</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">sum</span><span> </span><a href="#local-6989586621679296250"><span class="hs-identifier hs-var">punativeCostPerBlock</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679296250"><span class="hs-identifier hs-var">punativeCostPerBlock</span></a><span class="hs-special">)</span><span>
</span><a name="line-301"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-302"></a><span>    </span><span class="hs-comment">-- First we determine if there are extraneous network edges in the DAG</span><span>
</span><a name="line-303"></a><span>    </span><span class="hs-comment">-- </span><span>
</span><a name="line-304"></a><span>    </span><span class="hs-comment">-- We calculate the extraneous network edges by taking the difference between</span><span>
</span><a name="line-305"></a><span>    </span><span class="hs-comment">-- the complete netowrk edge set and the &quot;used&quot; network edge set.</span><span>
</span><a name="line-306"></a><span>    </span><a name="local-6989586621679296244"><a href="#local-6989586621679296244"><span class="hs-identifier">extraneousEdges</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679296245"><span class="hs-identifier hs-var">totalNetworkEdges</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">difference</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679296246"><span class="hs-identifier hs-var">usedNetworkEdges</span></a><span>
</span><a name="line-307"></a><span>    </span><a name="local-6989586621679296245"><a href="#local-6989586621679296245"><span class="hs-identifier">totalNetworkEdges</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">S</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">fromList</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">toList</span><span> </span><a href="#local-6989586621679296241"><span class="hs-identifier hs-var">networkEdgeSet</span></a><span>
</span><a name="line-308"></a><span>    </span><a name="local-6989586621679296246"><a href="#local-6989586621679296246"><span class="hs-identifier">usedNetworkEdges</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldMap1</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-6989586621679296251"><a href="#local-6989586621679296251"><span class="hs-identifier">x</span></a></a><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.TopologyRepresentation.html#includedNetworkEdges"><span class="hs-identifier hs-var">includedNetworkEdges</span></a><span> </span><a href="#local-6989586621679296251"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679296243"><span class="hs-identifier hs-var">minimalContexts</span></a><span>
</span><a name="line-309"></a><span>
</span><a name="line-310"></a><span>    </span><span class="hs-comment">-- Next we gather the set of network edges present in the most parsimonious</span><span>
</span><a name="line-311"></a><span>    </span><span class="hs-comment">-- display forest.</span><span>
</span><a name="line-312"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621679296247"><a href="#local-6989586621679296247"><span class="hs-identifier">parimoniousTopology</span></a></a><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679296242"><span class="hs-identifier hs-var">parsimoniousContext</span></a><span>
</span><a name="line-313"></a><span>    </span><a name="local-6989586621679296248"><a href="#local-6989586621679296248"><span class="hs-identifier">mostParsimoniousNetworkEdgeSet</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.TopologyRepresentation.html#includedNetworkEdges"><span class="hs-identifier hs-var">includedNetworkEdges</span></a><span> </span><a href="#local-6989586621679296247"><span class="hs-identifier hs-var">parimoniousTopology</span></a><span>
</span><a name="line-314"></a><span>
</span><a name="line-315"></a><span>    </span><span class="hs-comment">-- We gather the punative network edge cost for a block.</span><span>
</span><a name="line-316"></a><span>    </span><a name="local-6989586621679296249"><a href="#local-6989586621679296249"><span class="hs-identifier">punativeEdgeCost</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679296252"><a href="#local-6989586621679296252"><span class="hs-identifier">topo</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621679296253"><a href="#local-6989586621679296253"><span class="hs-identifier">costOfBlock</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679296253"><span class="hs-identifier hs-var">costOfBlock</span></a><span> </span><span class="hs-operator hs-var">*</span><span> </span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><a href="#local-6989586621679296254"><span class="hs-identifier hs-var">differingNetworkEdgeCount</span></a><span>
</span><a name="line-317"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-318"></a><span>        </span><a name="local-6989586621679296254"><a href="#local-6989586621679296254"><span class="hs-identifier">differingNetworkEdgeCount</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621679296255"><span class="hs-identifier hs-var">differenceEdgeSet</span></a><span>
</span><a name="line-319"></a><span>        </span><a name="local-6989586621679296255"><a href="#local-6989586621679296255"><span class="hs-identifier">differenceEdgeSet</span></a></a><span>         </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679296256"><span class="hs-identifier hs-var">minimalBlockEdgeSet</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">difference</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679296248"><span class="hs-identifier hs-var">mostParsimoniousNetworkEdgeSet</span></a><span>
</span><a name="line-320"></a><span>        </span><a name="local-6989586621679296256"><a href="#local-6989586621679296256"><span class="hs-identifier">minimalBlockEdgeSet</span></a></a><span>       </span><span class="hs-glyph">=</span><span> </span><a href="Data.TopologyRepresentation.html#includedNetworkEdges"><span class="hs-identifier hs-var">includedNetworkEdges</span></a><span> </span><a href="#local-6989586621679296252"><span class="hs-identifier hs-var">topo</span></a><span>
</span><a name="line-321"></a><span>
</span><a name="line-322"></a><span>    </span><span class="hs-comment">-- Then we apply the punative edge cost to each character block</span><span>
</span><a name="line-323"></a><span>    </span><a name="local-6989586621679296250"><a href="#local-6989586621679296250"><span class="hs-identifier">punativeCostPerBlock</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">/</span><span> </span><a href="#local-6989586621679296257"><span class="hs-identifier hs-var">divisor</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="#local-6989586621679296249"><span class="hs-identifier hs-var">punativeEdgeCost</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-6989586621679296243"><span class="hs-identifier hs-var">minimalContexts</span></a><span>
</span><a name="line-324"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-325"></a><span>        </span><a name="local-6989586621679296257"><a href="#local-6989586621679296257"><span class="hs-identifier">divisor</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">realToFrac</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-number">2</span><span> </span><span class="hs-operator hs-var">*</span><span> </span><a href="#local-6989586621679296240"><span class="hs-identifier hs-var">edgeSetCardinality</span></a><span>
</span><a name="line-326"></a><span>
</span><a name="line-327"></a><span>    </span><span class="hs-comment">-- The numerator is the sum of the punative network edge cost for each block.</span><span>
</span><a name="line-328"></a><span class="hs-comment">--    numerator   = sum $ punativeEdgeCost &lt;$&gt; minimalContexts</span><span>
</span><a name="line-329"></a><span class="hs-comment">--    denominator = 2 * edgeSetCardinality</span><span>
</span><a name="line-330"></a><span>    </span><span>
</span><a name="line-331"></a><span>
</span><a name="line-332"></a><span class="hs-comment">-- |</span><span>
</span><a name="line-333"></a><span class="hs-comment">-- We create a forest context by accumulating the display tree topologies</span><span>
</span><a name="line-334"></a><span class="hs-comment">-- and the cost for each block between roots.</span><span>
</span><a name="line-335"></a><span class="hs-comment">--</span><span>
</span><a name="line-336"></a><span class="hs-comment">-- Useful for comparing contexts when quantifying the punative network edge cost.</span><span>
</span><a name="line-337"></a><span class="hs-identifier">createForestContext</span><span>
</span><a name="line-338"></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">Foldable1</span><span> </span><a href="#local-6989586621679296133"><span class="hs-identifier hs-type">f</span></a><span>
</span><a name="line-339"></a><span>     </span><span class="hs-special">,</span><span> </span><a href="Bio.Sequence.Block.html#HasBlockCost"><span class="hs-identifier hs-type">HasBlockCost</span></a><span> </span><a href="#local-6989586621679296134"><span class="hs-identifier hs-type">u</span></a><span> </span><a href="#local-6989586621679296135"><span class="hs-identifier hs-type">v</span></a><span> </span><a href="#local-6989586621679296136"><span class="hs-identifier hs-type">w</span></a><span> </span><a href="#local-6989586621679296137"><span class="hs-identifier hs-type">x</span></a><span> </span><a href="#local-6989586621679296138"><span class="hs-identifier hs-type">y</span></a><span> </span><a href="#local-6989586621679296139"><span class="hs-identifier hs-type">z</span></a><span> </span><a href="#local-6989586621679296140"><span class="hs-identifier hs-type">i</span></a><span> </span><a href="#local-6989586621679296141"><span class="hs-identifier hs-type">r</span></a><span>
</span><a name="line-340"></a><span>     </span><span class="hs-special">,</span><span> </span><a href="Bio.Sequence.Block.html#HasRootCost"><span class="hs-identifier hs-type">HasRootCost</span></a><span>  </span><a href="#local-6989586621679296134"><span class="hs-identifier hs-type">u</span></a><span> </span><a href="#local-6989586621679296135"><span class="hs-identifier hs-type">v</span></a><span> </span><a href="#local-6989586621679296136"><span class="hs-identifier hs-type">w</span></a><span> </span><a href="#local-6989586621679296137"><span class="hs-identifier hs-type">x</span></a><span> </span><a href="#local-6989586621679296138"><span class="hs-identifier hs-type">y</span></a><span> </span><a href="#local-6989586621679296139"><span class="hs-identifier hs-type">z</span></a><span>   </span><a href="#local-6989586621679296141"><span class="hs-identifier hs-type">r</span></a><span>
</span><a name="line-341"></a><span>     </span><span class="hs-special">,</span><span> </span><a href="Bio.Metadata.Dynamic.Class.html#HasTraversalFoci"><span class="hs-identifier hs-type">HasTraversalFoci</span></a><span> </span><a href="#local-6989586621679296139"><span class="hs-identifier hs-type">z</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="Bio.Metadata.Dynamic.Internal.html#TraversalFoci"><span class="hs-identifier hs-type">TraversalFoci</span></a><span class="hs-special">)</span><span>
</span><a name="line-342"></a><span>     </span><span class="hs-special">)</span><span>
</span><a name="line-343"></a><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679296133"><span class="hs-identifier hs-type">f</span></a><span> </span><span class="hs-special">(</span><a href="Bio.Graph.Node.Internal.html#ResolutionInformation"><span class="hs-identifier hs-type">ResolutionInformation</span></a><span> </span><span class="hs-special">(</span><a href="Bio.Sequence.Internal.html#CharacterSequence"><span class="hs-identifier hs-type">CharacterSequence</span></a><span> </span><a href="#local-6989586621679296134"><span class="hs-identifier hs-type">u</span></a><span> </span><a href="#local-6989586621679296135"><span class="hs-identifier hs-type">v</span></a><span> </span><a href="#local-6989586621679296136"><span class="hs-identifier hs-type">w</span></a><span> </span><a href="#local-6989586621679296137"><span class="hs-identifier hs-type">x</span></a><span> </span><a href="#local-6989586621679296138"><span class="hs-identifier hs-type">y</span></a><span> </span><a href="#local-6989586621679296139"><span class="hs-identifier hs-type">z</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-344"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Bio.Metadata.Dynamic.Internal.html#TraversalTopology"><span class="hs-identifier hs-type">TraversalTopology</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">NonEmpty</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679296141"><span class="hs-identifier hs-type">r</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679296141"><span class="hs-identifier hs-type">r</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Vector</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">NonEmpty</span><span> </span><a href="Bio.Metadata.Dynamic.Internal.html#TraversalFocusEdge"><span class="hs-identifier hs-type">TraversalFocusEdge</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-345"></a><a name="createForestContext"><a href="Bio.Graph.PhylogeneticDAG.NetworkEdgeQuantification.html#createForestContext"><span class="hs-identifier">createForestContext</span></a></a><span> </span><a name="local-6989586621679296258"><a href="#local-6989586621679296258"><span class="hs-identifier">displayForest</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Bio.Graph.PhylogeneticDAG.NetworkEdgeQuantification.html#fromBlockMinimizationContext"><span class="hs-identifier hs-var">fromBlockMinimizationContext</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">foldMap1</span><span> </span><a href="#local-6989586621679296261"><span class="hs-identifier hs-var">blockContext</span></a><span> </span><a href="#local-6989586621679296258"><span class="hs-identifier hs-var">displayForest</span></a><span>
</span><a name="line-346"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-347"></a><span>    </span><a name="local-6989586621679296259"><a href="#local-6989586621679296259"><span class="hs-identifier">rootCount</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621679296258"><span class="hs-identifier hs-var">displayForest</span></a><span>
</span><a name="line-348"></a><span>    </span><a name="local-6989586621679296260"><a href="#local-6989586621679296260"><span class="hs-identifier">getRootingEdge</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fst</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">NE</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">head</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">fromJust</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">^.</span><span> </span><a href="Bio.Metadata.Dynamic.Class.html#traversalFoci"><span class="hs-identifier hs-var">traversalFoci</span></a><span class="hs-special">)</span><span>
</span><a name="line-349"></a><span>    </span><a name="local-6989586621679296261"><a href="#local-6989586621679296261"><span class="hs-identifier">blockContext</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="Bio.Graph.PhylogeneticDAG.NetworkEdgeQuantification.html#toBlockMinimizationContext"><span class="hs-identifier hs-var">toBlockMinimizationContext</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier">topologyRepresentation</span><span> </span><span class="hs-operator hs-var">&lt;*&gt;</span><span> </span><a href="#local-6989586621679296262"><span class="hs-identifier hs-var">blockCosts</span></a><span>
</span><a name="line-350"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-351"></a><span>        </span><a name="local-6989586621679296262"><a href="#local-6989586621679296262"><span class="hs-identifier">blockCosts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679296263"><a href="#local-6989586621679296263"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Bio.Sequence.Block.html#rootCost"><span class="hs-identifier hs-var">BLK</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">rootCost</span></a><span> </span><a href="#local-6989586621679296259"><span class="hs-identifier hs-var">rootCount</span></a><span> </span><a href="#local-6989586621679296263"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">,</span><span> </span><a href="Bio.Sequence.Block.html#blockCost"><span class="hs-identifier hs-var">BLK</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">blockCost</span></a><span> </span><a href="#local-6989586621679296263"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679296260"><span class="hs-identifier hs-var">getRootingEdge</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier">dynamicCharacters</span><span> </span><a href="#local-6989586621679296263"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Bio.Sequence.Internal.html#toBlocks"><span class="hs-identifier hs-var">toBlocks</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">characterSequence</span><span>
</span><a name="line-352"></a><span>
</span><a name="line-353"></a><span>
</span><a name="line-354"></a><span class="hs-comment">-- |</span><span>
</span><a name="line-355"></a><span class="hs-comment">-- Take a display forest context and push the topology information through to</span><span>
</span><a name="line-356"></a><span class="hs-comment">-- every block in the associated sequence. This creates a &quot;linear&quot; context</span><span>
</span><a name="line-357"></a><span class="hs-comment">-- suitable for zipping.</span><span>
</span><a name="line-358"></a><span class="hs-identifier">linearizeContext</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="Bio.Metadata.Dynamic.Internal.html#TraversalTopology"><span class="hs-identifier hs-type">TraversalTopology</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">NonEmpty</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679296130"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679296131"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679296132"><span class="hs-identifier hs-type">c</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">NonEmpty</span><span> </span><span class="hs-special">(</span><a href="Bio.Metadata.Dynamic.Internal.html#TraversalTopology"><span class="hs-identifier hs-type">TraversalTopology</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679296130"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679296131"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679296132"><span class="hs-identifier hs-type">c</span></a><span class="hs-special">)</span><span>
</span><a name="line-359"></a><a name="linearizeContext"><a href="Bio.Graph.PhylogeneticDAG.NetworkEdgeQuantification.html#linearizeContext"><span class="hs-identifier">linearizeContext</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679296264"><a href="#local-6989586621679296264"><span class="hs-identifier">topo</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679296265"><a href="#local-6989586621679296265"><span class="hs-identifier">costs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679296266"><span class="hs-identifier hs-var">squashTopologyIntoContext</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-6989586621679296265"><span class="hs-identifier hs-var">costs</span></a><span>
</span><a name="line-360"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-361"></a><span>    </span><a name="local-6989586621679296266"><a href="#local-6989586621679296266"><span class="hs-identifier">squashTopologyIntoContext</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679296267"><a href="#local-6989586621679296267"><span class="hs-identifier">x</span></a></a><span class="hs-special">,</span><a name="local-6989586621679296268"><a href="#local-6989586621679296268"><span class="hs-identifier">y</span></a></a><span class="hs-special">,</span><a name="local-6989586621679296269"><a href="#local-6989586621679296269"><span class="hs-identifier">z</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679296264"><span class="hs-identifier hs-var">topo</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679296267"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679296268"><span class="hs-identifier hs-var">y</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679296269"><span class="hs-identifier hs-var">z</span></a><span class="hs-special">)</span><span>
</span><a name="line-362"></a><span>
</span><a name="line-363"></a><span>
</span><a name="line-364"></a><span class="hs-identifier">ignoreDynamicCharacterTraversalFoci</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Functor</span><span> </span><a href="#local-6989586621679296125"><span class="hs-identifier hs-type">f</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679296125"><span class="hs-identifier hs-type">f</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679296126"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><a href="#local-6989586621679296127"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">,</span><a href="#local-6989586621679296128"><span class="hs-identifier hs-type">c</span></a><span class="hs-special">,</span><a href="#local-6989586621679296129"><span class="hs-identifier hs-type">d</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679296125"><span class="hs-identifier hs-type">f</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679296126"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><a href="#local-6989586621679296127"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">,</span><a href="#local-6989586621679296128"><span class="hs-identifier hs-type">c</span></a><span class="hs-special">)</span><span>
</span><a name="line-365"></a><a name="ignoreDynamicCharacterTraversalFoci"><a href="Bio.Graph.PhylogeneticDAG.NetworkEdgeQuantification.html#ignoreDynamicCharacterTraversalFoci"><span class="hs-identifier">ignoreDynamicCharacterTraversalFoci</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-6989586621679296270"><a href="#local-6989586621679296270"><span class="hs-identifier">a</span></a></a><span class="hs-special">,</span><a name="local-6989586621679296271"><a href="#local-6989586621679296271"><span class="hs-identifier">b</span></a></a><span class="hs-special">,</span><a name="local-6989586621679296272"><a href="#local-6989586621679296272"><span class="hs-identifier">c</span></a></a><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679296270"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">,</span><a href="#local-6989586621679296271"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">,</span><a href="#local-6989586621679296272"><span class="hs-identifier hs-var">c</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-366"></a><span>
</span><a name="line-367"></a><span>  </span><span>
</span><a name="line-368"></a><span>
</span><a name="line-369"></a><span>
</span><a name="line-370"></a><span class="hs-comment">-- | Used for convient accumulation.</span><span>
</span><a name="line-371"></a><span class="hs-keyword">data</span><span> </span><a name="BlockMinimizationContext"><a href="Bio.Graph.PhylogeneticDAG.NetworkEdgeQuantification.html#BlockMinimizationContext"><span class="hs-identifier">BlockMinimizationContext</span></a></a><span> </span><a name="local-6989586621679296106"><a href="#local-6989586621679296106"><span class="hs-identifier">c</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="BMC"><a href="Bio.Graph.PhylogeneticDAG.NetworkEdgeQuantification.html#BMC"><span class="hs-identifier">BMC</span></a></a><span> </span><a href="Bio.Metadata.Dynamic.Internal.html#TraversalTopology"><span class="hs-identifier hs-type">TraversalTopology</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">NonEmpty</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679296106"><span class="hs-identifier hs-type">c</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679296106"><span class="hs-identifier hs-type">c</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Vector</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">NonEmpty</span><span> </span><a href="Bio.Metadata.Dynamic.Internal.html#TraversalFocusEdge"><span class="hs-identifier hs-type">TraversalFocusEdge</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-372"></a><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">)</span><span>
</span><a name="line-373"></a><span>
</span><a name="line-374"></a><span>
</span><a name="line-375"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Num</span><span> </span><a href="#local-6989586621679296107"><span class="hs-identifier hs-type">c</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Semigroup</span><span> </span><span class="hs-special">(</span><a href="Bio.Graph.PhylogeneticDAG.NetworkEdgeQuantification.html#BlockMinimizationContext"><span class="hs-identifier hs-type">BlockMinimizationContext</span></a><span> </span><a href="#local-6989586621679296107"><span class="hs-identifier hs-type">c</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-376"></a><span>
</span><a name="line-377"></a><span>  </span><span class="hs-special">(</span><a name="local-3458764513820541482"><span class="hs-operator">&lt;&gt;</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Bio.Graph.PhylogeneticDAG.NetworkEdgeQuantification.html#BMC"><span class="hs-identifier hs-var">BMC</span></a><span> </span><a name="local-6989586621679296108"><a href="#local-6989586621679296108"><span class="hs-identifier">topo1</span></a></a><span> </span><a name="local-6989586621679296109"><a href="#local-6989586621679296109"><span class="hs-identifier">costs1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Bio.Graph.PhylogeneticDAG.NetworkEdgeQuantification.html#BMC"><span class="hs-identifier hs-var">BMC</span></a><span> </span><a name="local-6989586621679296110"><a href="#local-6989586621679296110"><span class="hs-identifier">topo2</span></a></a><span> </span><a name="local-6989586621679296111"><a href="#local-6989586621679296111"><span class="hs-identifier">costs2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Bio.Graph.PhylogeneticDAG.NetworkEdgeQuantification.html#BMC"><span class="hs-identifier hs-var">BMC</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679296108"><span class="hs-identifier hs-var">topo1</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><a href="#local-6989586621679296110"><span class="hs-identifier hs-var">topo2</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">zipWith</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-6989586621679296112"><a href="#local-6989586621679296112"><span class="hs-identifier">a</span></a></a><span class="hs-special">,</span><a name="local-6989586621679296113"><a href="#local-6989586621679296113"><span class="hs-identifier">b</span></a></a><span class="hs-special">,</span><a name="local-6989586621679296114"><a href="#local-6989586621679296114"><span class="hs-identifier">c</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679296115"><a href="#local-6989586621679296115"><span class="hs-identifier">d</span></a></a><span class="hs-special">,</span><a name="local-6989586621679296116"><a href="#local-6989586621679296116"><span class="hs-identifier">e</span></a></a><span class="hs-special">,</span><a name="local-6989586621679296117"><a href="#local-6989586621679296117"><span class="hs-identifier">f</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679296112"><span class="hs-identifier hs-var">a</span></a><span class="hs-operator hs-var">+</span><a href="#local-6989586621679296115"><span class="hs-identifier hs-var">d</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679296113"><span class="hs-identifier hs-var">b</span></a><span class="hs-operator hs-var">+</span><a href="#local-6989586621679296116"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">zipWith</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">&lt;&gt;</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679296114"><span class="hs-identifier hs-var">c</span></a><span> </span><a href="#local-6989586621679296117"><span class="hs-identifier hs-var">f</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679296109"><span class="hs-identifier hs-var">costs1</span></a><span> </span><a href="#local-6989586621679296111"><span class="hs-identifier hs-var">costs2</span></a><span>
</span><a name="line-378"></a><span>
</span><a name="line-379"></a><span>
</span><a name="line-380"></a><span class="hs-identifier">toBlockMinimizationContext</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Bio.Metadata.Dynamic.Internal.html#TraversalTopology"><span class="hs-identifier hs-type">TraversalTopology</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">NonEmpty</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679296124"><span class="hs-identifier hs-type">c</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679296124"><span class="hs-identifier hs-type">c</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Vector</span><span> </span><a href="Bio.Metadata.Dynamic.Internal.html#TraversalFocusEdge"><span class="hs-identifier hs-type">TraversalFocusEdge</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Bio.Graph.PhylogeneticDAG.NetworkEdgeQuantification.html#BlockMinimizationContext"><span class="hs-identifier hs-type">BlockMinimizationContext</span></a><span> </span><a href="#local-6989586621679296124"><span class="hs-identifier hs-type">c</span></a><span>
</span><a name="line-381"></a><a name="toBlockMinimizationContext"><a href="Bio.Graph.PhylogeneticDAG.NetworkEdgeQuantification.html#toBlockMinimizationContext"><span class="hs-identifier">toBlockMinimizationContext</span></a></a><span> </span><a name="local-6989586621679296273"><a href="#local-6989586621679296273"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Bio.Graph.PhylogeneticDAG.NetworkEdgeQuantification.html#BMC"><span class="hs-identifier hs-var">BMC</span></a><span> </span><a href="#local-6989586621679296273"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-6989586621679296274"><a href="#local-6989586621679296274"><span class="hs-identifier">a</span></a></a><span class="hs-special">,</span><a name="local-6989586621679296275"><a href="#local-6989586621679296275"><span class="hs-identifier">b</span></a></a><span class="hs-special">,</span><a name="local-6989586621679296276"><a href="#local-6989586621679296276"><span class="hs-identifier">c</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679296274"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">,</span><a href="#local-6989586621679296275"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-6989586621679296276"><span class="hs-identifier hs-var">c</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-382"></a><span>
</span><a name="line-383"></a><span>  </span><span>
</span><a name="line-384"></a><span class="hs-identifier">fromBlockMinimizationContext</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Bio.Graph.PhylogeneticDAG.NetworkEdgeQuantification.html#BlockMinimizationContext"><span class="hs-identifier hs-type">BlockMinimizationContext</span></a><span> </span><a href="#local-6989586621679296123"><span class="hs-identifier hs-type">c</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Bio.Metadata.Dynamic.Internal.html#TraversalTopology"><span class="hs-identifier hs-type">TraversalTopology</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">NonEmpty</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679296123"><span class="hs-identifier hs-type">c</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679296123"><span class="hs-identifier hs-type">c</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Vector</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">NonEmpty</span><span> </span><a href="Bio.Metadata.Dynamic.Internal.html#TraversalFocusEdge"><span class="hs-identifier hs-type">TraversalFocusEdge</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-385"></a><a name="fromBlockMinimizationContext"><a href="Bio.Graph.PhylogeneticDAG.NetworkEdgeQuantification.html#fromBlockMinimizationContext"><span class="hs-identifier">fromBlockMinimizationContext</span></a></a><span> </span><span class="hs-special">(</span><a href="Bio.Graph.PhylogeneticDAG.NetworkEdgeQuantification.html#BMC"><span class="hs-identifier hs-var">BMC</span></a><span> </span><a name="local-6989586621679296277"><a href="#local-6989586621679296277"><span class="hs-identifier">topo</span></a></a><span> </span><a name="local-6989586621679296278"><a href="#local-6989586621679296278"><span class="hs-identifier">costs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679296277"><span class="hs-identifier hs-var">topo</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679296278"><span class="hs-identifier hs-var">costs</span></a><span class="hs-special">)</span><span>
</span><a name="line-386"></a><span>
</span><a name="line-387"></a><span>
</span><a name="line-388"></a><span>
</span><a name="line-389"></a><span>
</span><a name="line-390"></a><span>
</span><a name="line-391"></a><span class="hs-comment">{-
-- |
-- Calculate the punitive networkedge cost for the DAG.
calculatePunitiveNetworkEdgeCost :: HasBlockCost u v w x y z i r =&gt; PhylogeneticDAG2 e n u v w x y z -&gt; ExtendedReal
calculatePunitiveNetworkEdgeCost inputDag
  | cardinality extraneousEdges &gt; 0 = -- trace (&quot;Extraneous edges: &quot; &lt;&gt; show extraneousEdges)
                                    -- . trace (&quot;Entire     edges: &quot; &lt;&gt; show entireNetworkEdgeSet)
                                    -- . trace (&quot;Minimal Block edges: &quot; &lt;&gt; show ((\(_,_,x) -&gt; collapseToEdgeSet x) &lt;$&gt; minimalBlockNetworkDisplay)) $
                                      infinity
  | otherwise                       = realToFrac numerator / realToFrac denominator
  where
    extraneousEdges        = entireNetworkEdgeSet `difference` minimalRequiredEdgeSet 
    minimalRequiredEdgeSet = foldMap (\(_,_,x) -&gt; collapseToEdgeSet x) minimalBlockNetworkDisplay
    entireNetworkEdgeSet   = extractNetworkEdgeSet inputDag

    numerator   = punativeEdgeCost minResult
    denominator :: Word
    denominator = cardinality minimalTotalNetworkDisplay --WLOG, all should be the same number of edges
    
    minResult@(minimalTotalNetworkDisplay, minimalBlockNetworkDisplay) = minimumBy (comparing punativeEdgeCost) minimalNetworkDisplaysWithMinimalBlocks

    minimalTotalNetworkDisplays = extractNetworkMinimalDisplayTrees inputDag
    minimalBlockNetworkDisplays = extractBlocksMinimalEdgeSets      inputDag

    minimalNetworkDisplaysWithMinimalBlocks = minimalBlocksForGivenNetworkEdgeDisplay &lt;$&gt; minimalTotalNetworkDisplays

    punativeEdgeCost (_totalEdgeSet, blockEdgeSets) = sum $ fmap g blockEdgeSets 
      where
        g (x,y,_) = x * fromIntegral y

    minimalBlocksForGivenNetworkEdgeDisplay displayEdgeSet = (displayEdgeSet, fmap gatherMinimalDisplayEdgeSetDiffernce minimalBlockNetworkDisplays)
      where
        gatherMinimalDisplayEdgeSetDiffernce (minBlockCost, minDisplayEdgeSets) = (minBlockCost, edgeDifference, minDifferenceDisplayEdgeSet)
          where
            (edgeDifference, minDifferenceDisplayEdgeSet) = minimumBy (comparing fst) $ (cardinality . (displayEdgeSet `difference`) &amp;&amp;&amp; id) &lt;$&gt; minDisplayEdgeSets


-- |
-- Construct each most parsimonious display forest resolution with respect to the
-- DAG rootings.
extractNetworkMinimalDisplayTrees :: PhylogeneticDAG2 e n u v w x y z -&gt; NonEmpty (NetworkDisplayEdgeSet (Int, Int))
extractNetworkMinimalDisplayTrees (PDAG2 dag) = rootTransformation rootResolutions
  where
    -- Since the number of roots in a DAG is fixed, each network display will
    -- contain an equal number of elements in the network display.
    rootTransformation = fmap (fromEdgeSets . NE.fromList . fmap subtreeEdgeSet)
                       . NE.fromList . minimaBy (comparing (sum . fmap totalSubtreeCost))
                       . pairwiseSequence resolutionsDoNotOverlap

    -- First we collect all resolutions for each root node
    rootResolutions = resolutions . nodeDecoration . (refs !) &lt;$&gt; rootRefs dag
    refs = references dag
    

-- |
-- Derive the entire edgeset of the DAG.
extractNetworkEdgeSet :: PhylogeneticDAG2 e n u v w x y z -&gt; EdgeSet (Int, Int)
extractNetworkEdgeSet (PDAG2 dag) = getEdges dag


-- |
-- Construct a &quot;Sequence&quot; of minimal cost minimal and display tree resolutions
-- for each character block.
extractBlocksMinimalEdgeSets :: HasBlockCost u v w x y z i r 
                             =&gt; PhylogeneticDAG2 e n u v w x y z
                             -&gt; NonEmpty (r, NonEmpty (NetworkDisplayEdgeSet (Int,Int)))
extractBlocksMinimalEdgeSets (PDAG2 dag) = foldMapWithKey1 f sequenceBlocksWLOG
  where
    generateBlockCosts = fmap (fmap (fmap (fmap blockCost . toBlocks)))
    rootingResolutions = generateBlockCosts $ pairwiseSequence resolutionsDoNotOverlap rootResolutions
    sequenceBlocksWLOG = toBlocks . characterSequence . NE.head $ NE.head rootResolutions
    rootResolutions = resolutions . nodeDecoration . (refs !) &lt;$&gt; rootRefs dag
    refs  = references dag

    focusOnBlockIndex i = (sum . fmap ((! i) . characterSequence)) &amp;&amp;&amp; (fromEdgeSets . NE.fromList . fmap subtreeEdgeSet)

    f k _v =
        case minimaValues of
          x:xs -&gt; pure (fst x, fmap snd $ x:|xs) 
          []   -&gt; error &quot;&quot;
      where
        minimaValues = minimaBy (comparing fst) $ focusOnBlockIndex k &lt;$&gt; rootingResolutions
-}</span><span>
</span><a name="line-474"></a><span>
</span><a name="line-475"></a><span>
</span><a name="line-476"></a><span class="hs-comment">-- |</span><span>
</span><a name="line-477"></a><span class="hs-comment">-- /O( n * m )/</span><span>
</span><a name="line-478"></a><span class="hs-comment">--</span><span>
</span><a name="line-479"></a><span class="hs-identifier">filterResolutionCombinationsBy</span><span>
</span><a name="line-480"></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">Applicative</span><span> </span><a href="#local-6989586621679296120"><span class="hs-identifier hs-type">f</span></a><span>
</span><a name="line-481"></a><span>     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Foldable</span><span> </span><a href="#local-6989586621679296120"><span class="hs-identifier hs-type">f</span></a><span>
</span><a name="line-482"></a><span>     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Traversable</span><span> </span><a href="#local-6989586621679296121"><span class="hs-identifier hs-type">t</span></a><span>
</span><a name="line-483"></a><span>     </span><span class="hs-special">)</span><span>
</span><a name="line-484"></a><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679296121"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679296122"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">)</span><span>
</span><a name="line-485"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679296121"><span class="hs-identifier hs-type">t</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679296120"><span class="hs-identifier hs-type">f</span></a><span> </span><a href="#local-6989586621679296122"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-486"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679296121"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679296122"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">]</span><span>
</span><a name="line-487"></a><a name="filterResolutionCombinationsBy"><a href="Bio.Graph.PhylogeneticDAG.NetworkEdgeQuantification.html#filterResolutionCombinationsBy"><span class="hs-identifier">filterResolutionCombinationsBy</span></a></a><span> </span><a name="local-6989586621679296279"><a href="#local-6989586621679296279"><span class="hs-identifier">predicate</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><a href="#local-6989586621679296279"><span class="hs-identifier hs-var">predicate</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">toList</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">sequenceA</span><span>
</span><a name="line-488"></a><span>
</span><a name="line-489"></a><span>
</span><a name="line-490"></a><span class="hs-comment">-- |</span><span>
</span><a name="line-491"></a><span class="hs-comment">-- A collection of resolutions, one resolution for each root in the DAG, forms a</span><span>
</span><a name="line-492"></a><span class="hs-comment">-- valid display forest if the following constraints are satisfied:</span><span>
</span><a name="line-493"></a><span class="hs-comment">--</span><span>
</span><a name="line-494"></a><span class="hs-comment">-- * For each root node in the input DAG, there is a corresponding display tree</span><span>
</span><a name="line-495"></a><span class="hs-comment">--   with that root.</span><span>
</span><a name="line-496"></a><span class="hs-comment">--</span><span>
</span><a name="line-497"></a><span class="hs-comment">-- * Each diplay tree in the display forest is not connected to anothe display</span><span>
</span><a name="line-498"></a><span class="hs-comment">--   tree. Equivelently, no two roots on the input DAG are connected.</span><span>
</span><a name="line-499"></a><span class="hs-comment">--</span><span>
</span><a name="line-500"></a><span class="hs-comment">-- * Each taxa in the input DAG is connected to exactly one root.</span><span>
</span><a name="line-501"></a><span class="hs-comment">--</span><span>
</span><a name="line-502"></a><span class="hs-comment">-- This function asserts that the conditions are met indirectly by using</span><span>
</span><a name="line-503"></a><span class="hs-comment">-- invariants of the 'ResolutionInformation' construction in an earlier</span><span>
</span><a name="line-504"></a><span class="hs-comment">-- computation.</span><span>
</span><a name="line-505"></a><span class="hs-identifier">formsValidDisplayForest</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Foldable1</span><span> </span><a href="#local-6989586621679296118"><span class="hs-identifier hs-type">f</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679296118"><span class="hs-identifier hs-type">f</span></a><span> </span><span class="hs-special">(</span><a href="Bio.Graph.Node.Internal.html#ResolutionInformation"><span class="hs-identifier hs-type">ResolutionInformation</span></a><span> </span><a href="#local-6989586621679296119"><span class="hs-identifier hs-type">s</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-506"></a><a name="formsValidDisplayForest"><a href="Bio.Graph.PhylogeneticDAG.NetworkEdgeQuantification.html#formsValidDisplayForest"><span class="hs-identifier">formsValidDisplayForest</span></a></a><span> </span><a name="local-6989586621679296280"><a href="#local-6989586621679296280"><span class="hs-identifier">resSet</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-507"></a><span>    </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">toNonEmpty</span><span> </span><a href="#local-6989586621679296280"><span class="hs-identifier hs-var">resSet</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-508"></a><span>      </span><span class="hs-identifier">_</span><span class="hs-operator hs-var">:|</span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-509"></a><span>      </span><span class="hs-identifier">_</span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679296281"><span class="hs-identifier hs-var">notContradictory</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621679296282"><span class="hs-identifier hs-var">completeLeafCoverage</span></a><span>
</span><a name="line-510"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-511"></a><span>    </span><a name="local-6989586621679296281"><a href="#local-6989586621679296281"><span class="hs-identifier">notContradictory</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">transitivePropertyHolds</span><span> </span><a href="Bio.Graph.PhylogeneticDAG.Internal.html#resolutionsDoNotOverlap"><span class="hs-identifier hs-var">resolutionsDoNotOverlap</span></a><span> </span><a href="#local-6989586621679296280"><span class="hs-identifier hs-var">resSet</span></a><span>
</span><a name="line-512"></a><span>    </span><a name="local-6989586621679296282"><a href="#local-6989586621679296282"><span class="hs-identifier">completeLeafCoverage</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679296283"><a href="#local-6989586621679296283"><span class="hs-identifier">bitVal</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldMap1</span><span> </span><span class="hs-identifier">leafSetRepresentation</span><span> </span><a href="#local-6989586621679296280"><span class="hs-identifier hs-var">resSet</span></a><span>
</span><a name="line-513"></a><span>                           </span><span class="hs-keyword">in</span><span>  </span><span class="hs-identifier hs-var">complement</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679296283"><span class="hs-identifier hs-var">bitVal</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">xor</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679296283"><span class="hs-identifier hs-var">bitVal</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621679296283"><span class="hs-identifier hs-var">bitVal</span></a><span>
</span><a name="line-514"></a></pre></body></html>